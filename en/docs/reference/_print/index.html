<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.100.2"><link rel=canonical type=text/html href=https://osrd.fr/en/docs/reference/><link rel=alternate type=application/rss+xml href=https://osrd.fr/en/docs/reference/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Technical reference | OSRD</title><meta name=description content="Internal machinery and APIs"><meta property="og:title" content="Technical reference"><meta property="og:description" content="Internal machinery and APIs"><meta property="og:type" content="website"><meta property="og:url" content="https://osrd.fr/en/docs/reference/"><meta property="og:site_name" content="OSRD"><meta itemprop=name content="Technical reference"><meta itemprop=description content="Internal machinery and APIs"><meta name=twitter:card content="summary"><meta name=twitter:title content="Technical reference"><meta name=twitter:description content="Internal machinery and APIs"><link rel=preload href=/scss/main.min.f03845650927da20a5e2e1fdc5e543de4fa1a463e0acedaca071fac4e82a8bf4.css as=style><link href=/scss/main.min.f03845650927da20a5e2e1fdc5e543de4fa1a463e0acedaca071fac4e82a8bf4.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/en/><span class=navbar-logo><svg id="Calque_1" data-name="Calque 1" viewBox="0 0 64 64" sodipodi:docname="logo_osrd_seul_blanc.svg" width="64" height="64" inkscape:version="1.1.2 (0a00cf5339, 2022-02-04)" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns="http://www.w3.org/2000/svg" xmlns:svg="http://www.w3.org/2000/svg" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:cc="http://creativecommons.org/ns#" xmlns:dc="http://purl.org/dc/elements/1.1/"><sodipodi:namedview pagecolor="#ffffff" bordercolor="#666666" borderopacity="1" objecttolerance="10" gridtolerance="10" guidetolerance="10" inkscape:pageopacity="0" inkscape:pageshadow="2" inkscape:window-width="3440" inkscape:window-height="1380" id="namedview47" showgrid="false" fit-margin-top="0" fit-margin-left="0" fit-margin-right="0" fit-margin-bottom="0" inkscape:zoom="3.0016455" inkscape:cx="12.992873" inkscape:cy="71.294228" inkscape:window-x="0" inkscape:window-y="32" inkscape:window-maximized="1" inkscape:current-layer="Calque_1" inkscape:pagecheckerboard="0"/><defs id="defs4"><style id="style2">.cls-1,.cls-2,.cls-3,.cls-4,.cls-7{fill:none;stroke-linecap:round;stroke-linejoin:round}.cls-1,.cls-4{stroke:#aa026d}.cls-1,.cls-2{stroke-width:10px}.cls-2,.cls-3{stroke:#71196f}.cls-3,.cls-4{stroke-width:5px}.cls-5,.cls-6{font-size:119.48px}.cls-5{fill:#71196f;font-family:AvenirLTStd-Heavy,Avenir LT Std}.cls-6{fill:#aa026d;font-family:AvenirLTStd-Medium,Avenir LT Std}.cls-7{stroke:#fff;stroke-width:.75px}</style></defs><title id="title6">logo-OSRD_</title><g id="g847" transform="matrix(0.09645818,0,0,0.09645818,7.1489968,-1.215e-6)"><path inkscape:connector-curvature="0" class="cls-1" d="m389.52 658.5v-88c0-199.26-91.83-331.42-279.82-362" id="path8" style="stroke:#f2f2f2;stroke-opacity:1"/><path inkscape:connector-curvature="0" class="cls-1" d="m298.5 658.5v-87.07c0-156.89-75.34-258.73-229.71-276" id="path10" style="stroke:#f2f2f2;stroke-opacity:1"/><path inkscape:connector-curvature="0" class="cls-2" d="m216.77 658.5v-70.49c0-121.76-58.68-200.64-178.91-213.6" id="path12" style="stroke:#a0a0a0;stroke-opacity:1"/><path inkscape:connector-curvature="0" class="cls-2" d="M125.74 658.5V617.36C125.74 533.21 86.13 478 5 466.95" id="path14" style="stroke:#a0a0a0;stroke-opacity:1"/><path inkscape:connector-curvature="0" class="cls-2" d="m125.74 658.5v-88c0-199.26 91.84-331.42 279.83-362" id="path16" style="stroke:#a0a0a0;stroke-opacity:1"/><path inkscape:connector-curvature="0" class="cls-2" d="m216.77 658.5v-87.07c0-156.89 75.34-258.73 229.71-276" id="path18" style="stroke:#a0a0a0;stroke-opacity:1"/><path inkscape:connector-curvature="0" class="cls-1" d="m298.5 658.5v-70.49c0-121.76 58.68-200.64 178.91-213.6" id="path20" style="stroke:#f2f2f2;stroke-opacity:1"/><path inkscape:connector-curvature="0" class="cls-1" d="m389.52 658.5v-41.14c0-84.15 39.62-139.36 120.75-150.41" id="path22" style="stroke:#f2f2f2;stroke-opacity:1"/><line class="cls-3" x1="126" y1="642.5" x2="126" y2="122.5" id="line24" style="stroke:#a0a0a0;stroke-opacity:1"/><line class="cls-3" x1="217" y1="642.5" x2="217" y2="2.5" id="line26" style="stroke:#a0a0a0;stroke-opacity:1"/><line class="cls-4" x1="299" y1="642.5" x2="299" y2="2.5" id="line28" style="stroke:#f7f7f7;stroke-opacity:1"/><line class="cls-4" x1="390" y1="642.5" x2="390" y2="122.5" id="line30" style="stroke:#f2f2f2;stroke-opacity:1"/></g></svg></span><span class=font-weight-bold>OSRD</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/en/about/><span>About</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/en/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/en/blog/><span>Blog</span></a></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/fr/docs/reference/>Français</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.19b424109fa25a6844134532280b2256.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/en/docs/reference/>Return to the regular view of this page</a>.</p></div><h1 class=title>Technical reference</h1><div class=lead>Internal machinery and APIs</div><ul><li>1: <a href=#pg-956c746a8215379d75cfcf5474a683e3>Architecture</a></li><ul><li>1.1: <a href=#pg-563493d51cba2cf0991bc456da66a1b1>Data-flow</a></li><li>1.2: <a href=#pg-8c50df3d62cb7d3b188a4daf7e4536fd>Services</a></li></ul><li>2: <a href=#pg-9bd47f930a6befba383b5f079fd5620d>Design documents</a></li><ul><li>2.1: <a href=#pg-0289c7adf583e85ce535e627617fcb3a>Signaling</a></li><li>2.2: <a href=#pg-6802b8721cfb6034a773e0771f4b7493>Conflict detection</a></li><li>2.3: <a href=#pg-5c302d0351a984c31f1516d7661b618f>Search for last-minute train slots (STDCM)</a></li><ul><li>2.3.1: <a href=#pg-947b82c2b20e8d312398ef2a5634cd3c>Business context</a></li><li>2.3.2: <a href=#pg-f0e665bd09334507f4e0f2438621834b>Train slot search module</a></li><ul><li>2.3.2.1: <a href=#pg-a4f78c201b7f1d0e1991144fff21f26a>Input format</a></li><li>2.3.2.2: <a href=#pg-12bb8a99ebcc826ad37983a300610aed>Encoding the solution space</a></li><li>2.3.2.3: <a href=#pg-74094845d6db946e31db476ef1c506a2>Discontinuities and backtracking</a></li><li>2.3.2.4: <a href=#pg-615ce0cf6c404cd85469e6285e5feb90>Conflict avoidance</a></li><li>2.3.2.5: <a href=#pg-ed97b39b0c3816e4f1073f363957a3e3>Standard allowance</a></li><li>2.3.2.6: <a href=#pg-460b1be4e2f2584372a451ceef833731>Implementation details</a></li></ul><li>2.3.3: <a href=#pg-8ee6423983b11793e61c99ce092f6373>Signaling interface</a></li></ul></ul><li>3: <a href=#pg-c963971a74112cd3ec208d3977cd25e5>APIs</a></li><ul><li>3.1: <a href=#pg-20edb78a2f57bbf0e0aadeb2bd6baaab>JSON Schemas</a></li><ul></ul></ul></ul><div class=content><p>Technical reference guides contain technical reference for APIs and other aspects of OSRD&rsquo;s machinery. They describe how it works and how to use it but assume that you have a basic understanding of key concepts.</p></div></div><div class=td-content><h1 id=pg-956c746a8215379d75cfcf5474a683e3>1 - Architecture</h1><div class=lead>Learn more about OSRD architecture</div><p>Architecture documents are meant to help understand how OSRD works overall.</p></div><div class=td-content><h1 id=pg-563493d51cba2cf0991bc456da66a1b1>1.1 - Data-flow</h1><div class=lead>OSRD&rsquo;s data-flow diagram</div><p><img src=data_flow.svg alt="Data-flow diagram"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-8c50df3d62cb7d3b188a4daf7e4536fd>1.2 - Services</h1><div class=lead>OSRD&rsquo;s services architecture</div><p>It is a multi-service architecture where several software components interact with each other. This choice was made to ensure the modularity of the code and to guarantee the exploitability of certain OSRD services by external applications.</p><p><img src=services.en.svg alt="Services architecture"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-9bd47f930a6befba383b5f079fd5620d>2 - Design documents</h1><div class=lead>Learn more about how the software was designed</div><p>Design documents are meant to help understand and participate in designing software.</p><p>Each design document describes a number of things about a piece of software:</p><ul><li>its goals</li><li>its constraints</li><li>how its inputs and outputs were modeled</li><li>how it works</li></ul></div><div class=td-content><h1 id=pg-0289c7adf583e85ce535e627617fcb3a>2.1 - Signaling</h1><div class=lead>Describes the signaling model</div><div class="pageinfo pageinfo-warning"><p>This document is pending review</p></div><h2 id=description>Description</h2><p>The signaling layer includes all signals, which respond to track occupancy and
reservation. Signals can be of different types, and are modularly loaded. Only
their behavior towards the state of the infrastructure and the train&rsquo;s reaction
to signaling matters.</p><p>Signals are connected to each other by blocks. Blocks define the movements
authorized by signaling.</p><h2 id=goals>Goals</h2><p>The signaling system is at the crossroads of many needs:</p><ul><li>it must allow for realistic signaling simulation in a multi-train simulation</li><li>it must allow the conflict detection system to determine which resources are required for the train</li><li>it must allow application users to edit and display signals</li><li>it must allow for visualization of signals on a map</li></ul><h2 id=design-requirements>Design requirements:</h2><p>Static data:</p><ul><li>must enable the front-end to display the signals</li><li>must enable the infrastructure editor to configure signals</li><li>must enable the back-end to simulate signals</li><li>must be close to realistic industry models</li><li>must allow for the modeling of composite signals, which carry several
logical signals within a single physical signal</li></ul><p>To simulate signaling:</p><ul><li>blocks must be generated for both user convenience and <strong>pathfinding</strong></li><li>for each signal, its <strong>next compatible signal</strong> and <strong>protected zones</strong> must be deduced</li><li>the <strong>minimum necessary information</strong> must be provided to the signaling modules for their operation</li><li>using signaling modules without having to instantiate a complete simulation must be enabled</li><li>the design of the signaling module API must allow for signals to be loaded in any order</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># unique identifier for the signaling system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;id&#34;: </span><span style=color:#4e9a06>&#34;BAL&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;version&#34;: </span><span style=color:#4e9a06>&#34;1.0&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># a list of roles the system assumes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;roles&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;MA&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;SPEED_LIMITS&#34;</span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># the schema of the dynamic state of signals of this type</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;signal_state&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;enum&#34;, &#34;field_name&#34;: </span><span style=color:#4e9a06>&#34;aspect&#34;</span><span style=color:#204a87;font-weight:700>, values</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;VL&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;A&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;S&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;C&#34;</span><span style=color:#000;font-weight:700>]</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: </span><span style=color:#4e9a06>&#34;ralen30&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: </span><span style=color:#4e9a06>&#34;ralen60&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: </span><span style=color:#4e9a06>&#34;ralen_rappel&#34;</span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># the schema of the settings signals of this type can read</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;signal_settings&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: &#34;Nf&#34;, &#34;display_name&#34;: </span><span style=color:#4e9a06>&#34;Non-franchissable&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: &#34;has_ralen30&#34;, &#34;default&#34;: false, &#34;display_name&#34;: </span><span style=color:#4e9a06>&#34;Ralen 30&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: &#34;has_rappel30&#34;, &#34;default&#34;: false, &#34;display_name&#34;: </span><span style=color:#4e9a06>&#34;Rappel 30&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: &#34;has_ralen60&#34;, &#34;default&#34;: false, &#34;display_name&#34;: </span><span style=color:#4e9a06>&#34;Ralen 60&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: &#34;has_rappel60&#34;, &#34;default&#34;: false, &#34;display_name&#34;: </span><span style=color:#4e9a06>&#34;Rappel 60&#34;</span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># these are C-like boolean expressions:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># true, false, &lt;flag&gt;, &lt;enum&gt; == value, &amp;&amp;, || and ! can be used</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># used to evaluate whether a signal is a block boundary.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;block_boundary_when&#34;: </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># used to evaluate whether a signal is a route boundary.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;route_boundary_when&#34;: </span><span style=color:#4e9a06>&#34;Nf&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># used for naive conflict detection.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;constraining_ma_when&#34;: </span><span style=color:#4e9a06>&#34;aspect != VL&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=assumptions>Assumptions</h2><ul><li>Each physical signal can be decomposed into a list of logical signals, all of which are associated with a signaling system.</li><li>Blocks have a type.</li><li>It is possible to determine, given only the signal, its delimiting properties.</li><li>Blocks never cross route boundaries.</li><li>Blocks which are not covered by routes do not exist, or can be ignored.</li><li>At any time, trains only use one signaling system capable of transmitting movement authority.</li></ul><h1 id=design-of-signaling-systems>Design of Signaling Systems</h1><p>Each signaling system has:</p><ul><li>A unique identifier (a string).</li><li>A set of roles:<ul><li>Transmission of Movement Authority</li><li>Transmission of speed limits</li></ul></li><li>Its signal state type, which enables deducing:<ul><li>The graphical representation of the signal</li><li>How a train would react to the signal</li><li>If the signal state constrains Movement Authority</li></ul></li><li>The signal parameter types, names and description, which enable front-end edition of signal parameters.</li><li>The block and route conditions, which enable evaluating whether a signal delimits blocks or routes, given its parameters.</li></ul><p>Note that if a signaling system has a dual role of transmitting Movement Authority (MA) and speed
limits, not all signals in this system are necessarily tasked with transmitting
speed limit information.</p><h1 id=design-of-blocks>Design of blocks</h1><p>The blocks have several attributes:</p><ul><li>A signaling system that corresponds to that displayed by its first signal.</li><li>A <strong>path</strong>, which is a list of direction + detector pairs (just like route paths).</li><li>An <strong>entry signal</strong>, (optional when the block starts from a buffer stop).</li><li><strong>Intermediate signals</strong>, if any (only used by systems with distant signals).</li><li>An <strong>exit signal</strong>, (optional when the block ends at a buffer stop).</li></ul><p>The path is expressed from detector to detector so that it can be overlayed with the route graph.</p><p>A few remarks:</p><ul><li>There can be multiple blocks with the same path, as long as they have different signaling systems. Trains only use a block at a time, and ignore others.</li><li>Blocks do not have a state: one can rely on the dynamic state of the zones that make it up.</li><li>Blocks are used to figure out which signals protect which zones in a given context.</li></ul><h1 id=design-of-signals>Design of signals</h1><p>Physical signal are made up of one or more logical signals, which are displayed as a single unit on the field. During simulation, logical signals are treated as separate signals.</p><p>Each logical signal is associated with a signaling system, which defines if the
signal transmits Movement Authority, speed limits, or both.</p><p>Logical signals have one or more drivers. Signal drivers are responsible for computing
signal state. Any given signal driver only works for a given pair of signaling systems,
where the first one is displayed by the signal, and the second is the one displayed by
the next signal.</p><p>When a logical signal has an empty driver list, its content is deduced from neighboring signals.</p><p>For example, a BAL signal that is both a departure of the TVM block and a
departure of the BAL block, it will have two drivers: <code>BAL-BAL</code> and <code>BAL-TVM</code>.</p><h2 id=raw-signal-format>Raw signal format</h2><p>The raw signal format is the user-editable description of a physical signal.</p><p>Raw signals have a list of logical signals, which are independently simulated units sharing
a common physical display. Each logical signal has:</p><ul><li>a signaling system</li><li>user-editable settings, as specified in the signaling system description</li><li>a list of allowed next signaling systems, which are used to load drivers</li></ul><p>For example, this signal encodes a BAL signal which starts both a BAL and a TVM block:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># signals must have location data.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># this data is omitted as its format is irrelevant to how signals behave</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;logical_signals&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#8f5902;font-style:italic># the signaling system shown by the signal</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;signaling_system&#34;: </span><span style=color:#4e9a06>&#34;BAL&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#8f5902;font-style:italic># the settings for this signal, as defined in the signaling system manifest</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;settings&#34;: {&#34;has_ralen30&#34;: &#34;true&#34;, &#34;Nf&#34;: </span><span style=color:#4e9a06>&#34;true&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#8f5902;font-style:italic># this signal can react to BAL or TVM signals</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#8f5902;font-style:italic># if the list is empty, the signal is assumed to be compatible with all following signaling systems</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;next_signaling_systems&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;BAL&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;TVM&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>For example, this signal encodes a BAL signal which starts a BAL block, and shares its physical display / support with a BAPR signal starting a BAPR block:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># signals must have location data.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># this data is omitted as its format is irrelevant to how signals behave</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;logical_signals&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;signaling_system&#34;: </span><span style=color:#4e9a06>&#34;BAL&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;settings&#34;: {&#34;has_ralen30&#34;: &#34;true&#34;, &#34;Nf&#34;: </span><span style=color:#4e9a06>&#34;true&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;next_signaling_systems&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;BAL&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;signaling_system&#34;: </span><span style=color:#4e9a06>&#34;BAPR&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;settings&#34;: {&#34;Nf&#34;: &#34;true&#34;, &#34;distant&#34;: </span><span style=color:#4e9a06>&#34;false&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;next_signaling_systems&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;BAPR&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Such signal descriptions can be condensed down into a simplified description string, for the specific use-case of representing / generating signal icons: <code>BAL[Nf=true,ralen30=true]+BAPR[Nf=true,distant=false]</code></p><h3 id=loading-signal-parameters>Loading Signal Parameters</h3><p>The first step of loading the signal is to characterize the signal in the signaling system.
This step produces an object that describes the signal.</p><p>During the loading of the signal:</p><ul><li>the signaling system corresponding to the provided name is identified</li><li>the signal parameters are loaded and validated according to the signaling system spec</li><li>the signal&rsquo;s block and route delimiting properties are evaluated</li></ul><h3 id=loading-the-signal>Loading the Signal</h3><p>Once signal parameters are loaded, drivers can be loaded. For each driver:</p><ul><li>The driver implementation is identified from the <code>(signaling_system, next_signaling_system)</code> pair.</li><li>It is verified that the signaling system outgoing from the driver corresponds to the one of the signal.</li><li>It is verified that there is no existing driver for the incoming signaling system of the driver.</li></ul><p>This step produces a <code>Map&lt;SignalingSystem, SignalDriver></code>, where the signaling
system is the one incoming to the signal. It then becomes possible to construct
the loaded signal.</p><h3 id=constructing-blocks>Constructing Blocks</h3><ul><li>The framework creates blocks between signals following the routes present in the infrastructure, and the block properties of the signals.</li><li>Checks are made on the created block graph: it must always be possible to choose a block for each signal and each state of the infrastructure.</li></ul><h3 id=speed-limits>Speed Limits</h3><p>Speed limits are represented as ranges on routes.
They start their life as ranges on track sections, and are lifted to ranges on routes as follows:</p><ul><li>Directional speed limits by track are elevated to routes. The same speed limit can be on multiple routes.</li><li>For each speed limit, the route graph is traversed in reverse searching for signals capable of handling the limit:<ul><li>Only speed limits not preceded by another limit with identical properties are considered.</li><li>Each signal must signal its interest in a speed limit: Not concerned, Concerned but to be announced by another signal, or Concerned and terminal.</li></ul></li><li>For each speed limit planned along the train&rsquo;s path, the signals in the announcement chain are added to the list of those to be simulated for the train.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>SpeedLimitHandling</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/** This signal isn&#39;t supposed to announce this limit */</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Ignore</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/** This signal should announce this limit, but cannot */</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/** This signal can announce this limit, and is part of an ongoing chain */</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Chain</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/** This signal can announce this limit, and ends the chain */</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>EndChain</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>handles_speed_limit</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#3465a4>self</span>: <span style=color:#000>SignalSettings</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>speed_limit</span>: <span style=color:#000>SpeedLimit</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>distance_mm</span>: <span style=color:#204a87;font-weight:700>u64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>SpeedLimitHandling</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>handles_speed_limit_chain</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#3465a4>self</span>: <span style=color:#000>SignalSettings</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>speed_limit</span>: <span style=color:#000>SpeedLimit</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>chain_signal</span>: <span style=color:#000>Signal</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>distance_mm</span>: <span style=color:#204a87;font-weight:700>u64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>SpeedLimitHandling</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=block-validation>Block validation</h3><p>The validation process helps to report invalid configurations in terms of signaling and blockage. The validation cases we want to support are:</p><ul><li>The signaling system may want to validate, knowing if the block starts / ends on a buffer:<ul><li>the length of the block</li><li>the spacing between the block signals, first signal excluded</li></ul></li><li>Each signal in the block may have specific information if it is a transition signal. Therefore, all signal drivers participate in the validation.</li></ul><p>In practice, there are two separate mechanisms to address these two needs:</p><ul><li>The <strong>signaling system module</strong> is responsible for validating signaling <strong>within</strong> blocks.</li><li><strong>Signal drivers</strong> take care of validating transitions <strong>between</strong> blocks.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>extern</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>report_warning</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>/* TODO */</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>extern</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>report_error</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>/* TODO */</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Block</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>startsAtBufferStop</span>: <span style=color:#204a87;font-weight:700>bool</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>stopsAtBufferStop</span>: <span style=color:#204a87;font-weight:700>bool</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>signalTypes</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SignalingSystemId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>signalSettings</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SignalSettings</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>signalPositions</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Distance</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>length</span>: <span style=color:#000>Distance</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/// Runs in the signaling system module
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>check_block</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>block</span>: <span style=color:#000>Block</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/// Runs in the signal driver module
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>check_signal</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>signal</span>: <span style=color:#000>SignalSettings</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>block</span>: <span style=color:#000>Block</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// The partial block downstream of the signal - no signal can see backward
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=signal-lifecycle>Signal lifecycle</h3><p>Before a train startup:</p><ul><li>the path a of the train can be expressed is given, both as routes and blocks</li><li>the signal queue a train will encounter is established</li></ul><p>During the simulation:</p><ul><li>along a train movement, the track occupation before it are synthesized</li><li>when a train observes a signal, its state is evaluated</li></ul><h3 id=signal-state-evaluation>Signal state evaluation</h3><p>Signals are modeled as an evaluation function, taking a view of the world and returning the signal state</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>ZoneStatus</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#8f5902;font-style:italic>/** The zone is clear to be used by the train */</span>
</span></span><span style=display:flex><span>   <span style=color:#000>CLEAR</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>   <span style=color:#8f5902;font-style:italic>/** The zone is occupied by another train, but otherwise clear to use */</span>
</span></span><span style=display:flex><span>   <span style=color:#000>OCCUPIED</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>   <span style=color:#8f5902;font-style:italic>/** The zone is incompatible. There may be another train as well */</span>
</span></span><span style=display:flex><span>   <span style=color:#000>INCOMPATIBLE</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>MAView</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** Combined status of the zones protected by the current signal */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>protectedZoneStatus</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>ZoneStatus</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>nextSignalState</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>SignalState</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>nextSignalSettings</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>SignalSettings</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>DirectSpeedLimit</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** Distance between the signal and the speed limit */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>distance</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>Distance</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>speed</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>Speed</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>IndirectSpeedLimit</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>distanceToNextSignal</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>Distance</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>nextSignalState</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>SignalState</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>nextSignalSettings</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>SignalSettings</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>SpeedLimitView</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** A list of speed limits directly downstream of the signal */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>directSpeedLimits</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>List</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#000>DirectSpeedLimit</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** A list of speed limits which need to be announced in a signal chain */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>indirectSpeedLimits</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>List</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#000>IndirectSpeedLimit</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>fun</span> <span style=color:#000>signal</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>maView</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>MAView</span><span style=color:#000;font-weight:700>?,</span> <span style=color:#000>limitView</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>SpeedLimitView</span><span style=color:#000;font-weight:700>?):</span> <span style=color:#000>SignalState</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>The view should allow access to the following data:</p><ul><li>a synthetized view of zones downstream until the end of the train&rsquo;s MA</li><li>the block chain</li><li>the state of downstream signals which belong to the current block chain</li></ul><h3 id=signaling-view-path>Signaling view path</h3><p>The path along which the MAView and SpeedLimitView live is best expressed using blocks:</p><ul><li>blocks can be added to extend the view along the path of a train</li><li>the view can be reduced by removing blocks, as the train passes by signals</li></ul><h3 id=simulation-outside-the-train-path>Simulation outside the train path</h3><p>Everything mentionned so far was designed to simulate signals between a train the
end of its movement authority, as all others signals have no influence over the behavior
of trains (they cannot be seen, or are disregarded by drivers).</p><p>Nevertheless, one may want to simulate and display the state of all signals at a given point in time,
regardless of which signals are in use.</p><p>Simulation rules are as follows:</p><ul><li>if a signal starts blocks which have differing paths, it is simulated as if it were at the end of a route</li><li>if a signal starts blocks which all start the same path, it is simulated in the same view as the next signals in this path</li></ul><h2 id=dependencies>Dependencies</h2><p>For the block graph generation:</p><ul><li>route graph. For each route:<ul><li><code>waypoints: List&lt;DiDetector></code></li><li><code>signals: OrderedMap&lt;Position, UnloadedSignal></code></li><li><code>speed_limits: RangeMap&lt;Position, SpeedLimit></code>, including the logic for train category limits</li></ul></li><li>signaling systems</li><li>drivers</li></ul><p>For evaluation:</p><ul><li>train path in blocks</li><li>portion of the path to evaluate</li><li>drivers</li><li>state of the zones in the section to evaluate</li></ul><h2 id=operations>Operations</h2><ul><li><strong>Instantiating a view</strong> creates a framework for observing signals</li><li><strong>Planning the path signals</strong> to the view the blocks that the train will traverse</li><li><strong>Observing a signal</strong> subscribe to the state of a signal (through the view)</li><li><strong>Passing a signal</strong> signals that a signal has been passed by the train (through the view)</li></ul><h2 id=appendices>Appendices</h2><h3 id=research-questions>Research Questions</h3><ul><li>Are there any blocks that overlap the end of a route? SNCF(Loïc): No.</li><li>Are there any signals which rely on the state of the one after next signal? SNCF(Loïc): No.</li><li>Are there signals that change behavior based on the active block in front of them? SNCF(Loïc): Yes, for slowdowns.</li><li>Are there signals that are the start of blocks of different types? SNCF(Loïc): Yes.</li><li>Can the behavior of a signal depend on which block is active after the end of the current block? SNCF(Loïc): Yes, with slowdowns or blinking yellow.</li><li>Do some signaling systems need additional information in the blocks? SNCF(Loïc): Kind of, there are slowdowns, but it&rsquo;s not specifically carried by the block.</li><li>Is it nominal for a train to have multiple active signaling systems at the same time? SNCF(Loïc): No.</li><li>When and by whom are the blocks generated?</li><li>What data is necessary for generating the blocks?</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-6802b8721cfb6034a773e0771f4b7493>2.2 - Conflict detection</h1><div class=lead>Detect unrealistic timetables</div><div class="pageinfo pageinfo-warning"><p>This document is a work in progress</p></div><p>Conflict detection is the process of looking for timetable conflicts.
A timetable conflict is any predictable condition which disrupts planned operations.
Planned operations can be disrupted if a train is slowed down, prevented from proceeding, or delayed.</p><p>One of the core features of OSRD is the ability to automatically detect some conflicts:</p><ul><li><strong>spacing conflicts</strong>: insufficient spacing between trains sharing the same path</li><li><strong>routing conflicts</strong>: insufficient spacing between trains with intersecting paths</li></ul><p>Some other kinds of conflicts may be detected <em>later on</em>:</p><ul><li><strong>maintenance conflicts</strong>: planned maintenance disrupts the path of a train</li><li><strong>power delivery conflicts</strong>: combined power delivery requirements exceeds capacity</li></ul><p>Conflict detection relies on interlocking and signaling modeling and simulation to:</p><ol><li>figure out what each actor requires to perform its duty undisturbed</li><li>detect conflicting requirements</li></ol><h2 id=design-constraints>Design constraints</h2><p>The primary design goals are as follows:</p><ul><li>enable threading new train paths into an existing timetable (see STDCM)</li><li>produce conflicts which can be linked back to a root cause</li><li>operate in way that can be visualized and interpreted</li><li>scale to real world timetables: millions of yearly trains, tens of thousands of daily trains</li></ul><p>In addition to these goals, the following constraints apply:</p><ul><li>it must be possible to thread new train paths into timetables with existing conflicts</li><li>it must not cause false-negatives: if no conflicts are detected, a multi-train simulation of the same timetable must not yield any slowdowns</li><li>it cannot rely on data we do not have</li><li>it has to enable later support of mobile block systems</li><li>it has to rely on existing signaling and interlocking simulation</li><li>it has to enable detecting conflicts regardless of the signaling system in use</li><li>it has to support transitions between signaling systems</li><li>it has to support conflicts between different signaling systems</li></ul><h2 id=conflict-modeling>Conflict modeling</h2><p><strong>Actors</strong> are objects which cause resources to be used:</p><ul><li><strong>train paths</strong> (or someone / something on the behalf of the train)</li><li><strong>maintenance work</strong></li></ul><p>Actors need <strong>resources</strong> to be available to proceed, such as:</p><ul><li><strong>zones</strong>, which have one state per way to traverse it</li><li><strong>switches</strong>, which have one state per position</li><li><strong>station platforms</strong>, which could be used to prevent two large trains from occupying both sides of a tiny platform</li></ul><p>Actor emit <strong>resource requirements</strong>, which:</p><ul><li>describe the need of an actor for a resource, for a given time span</li><li>describe what the resource is needed for</li><li>detail how the resource is used, such as switch position, zone entry and exit</li></ul><p>Resource requirements can turn out to be either <strong>satisfied</strong>
or <strong>conflicting</strong> with other requirements, depending on compatibility rules.</p><p><strong>Compatibility rules differ by requirement purpose and resource type</strong>. For example:</p><ul><li>spacing requirements are exclusive: simultaneous requirements for the same resource are conflicting</li><li>zone and switch requirements are shareable: simultaneous requirements are satisfied if the resource configuration is identical</li></ul><p><strong>For conflict detection to work, resource requirements have to be at least as extensive as what&rsquo;s required to guarantee that a train path will not be disturbed.</strong></p><h2 id=routing-conflicts>Routing conflicts</h2><h3 id=context>Context</h3><p>For trains to proceed safely along their planned path:</p><ul><li>switches have to be moved in the appropriate position</li><li>level crossings have to activate</li><li>risks of collision with other trains have to be mitigated</li></ul><p>In practice, the path of trains is partitioned into routes, which when set, ensure a train can safely follow the route.</p><p>Routes have the following lifestyle:</p><ul><li>As a train approaches the start of one of its routes, it is <strong>called</strong> by an operator. If all resources required to safely use the route are available, switches and level crossings start to move. If a resources is not available, e.g. because another train has reserved a section of track, this process is delayed until all conditions are met.</li><li>Once all resources are configured and reserved, the route is <strong>set</strong> and ready to be followed. Before that point, the entry of the route was protected by signaling, which prevented the train from moving past the entry point.</li><li>As the train moves along the route, it is <strong>destroyed</strong>. When the tail of the trail releases key detectors along the route, resources before this detector are released, and can this be reserved by other routes.</li></ul><p>For a train to proceed through a route unimpeded, the following things have to happen:</p><ul><li>The route has to be set before the train arrives, and before it is slowed down by signaling.</li><li>The route has to be called, so that is it set in time.</li><li>All resources required for the route to start setting at call time have to be available.</li></ul><h3 id=generating-requirements>Generating requirements</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>RouteRequirement</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>route</span>: <span style=color:#000>RouteId</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>set_deadline</span>: <span style=color:#000>Time</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>zone_requirements</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>RouteZoneRequirement</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>RouteZoneRequirement</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>zone</span>: <span style=color:#000>ZoneId</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>entry_det</span>: <span style=color:#000>DirDetectorId</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>exit_det</span>: <span style=color:#000>DirDetectorId</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>release_time</span>: <span style=color:#000>Time</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>switches</span>: <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SwitchId</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SwitchConfigId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Routing requirements are generated by the following algorithm:</p><ul><li>Compute the set deadline using signaling simulation. The set deadline is the point in time at which the train would be slowed down if the route were not set.</li><li>For each zone in each route, simulate when it would be released, and thus not required anymore.</li></ul><div class="pageinfo pageinfo-info"><p>Route overlaps are not yet supported.</p></div><h3 id=requirement-compatibility-rules>Requirement compatibility rules</h3><p>Requirement compatibility is evaluated for all <code>RouteZoneRequirement</code>s, grouped by zone. Requirements A and B, ordered such that <code>A.set_deadline &lt;= B.set_deadline</code>, are compatible if and only if either:</p><ul><li>their active time span does not overlap, such that <code>A.release_time &lt;= (B.set_deadline - activation_time)</code>, where the activation time is the delay required to reconfigure from <code>A.switches</code> to <code>B.switches</code>.</li><li><code>(A.entry_det, A.exit_det, A.switches) == (B.entry_det, B.exit_det, B.switches)</code></li></ul><h2 id=spacing-conflicts>Spacing conflicts</h2><h3 id=context-1>Context</h3><p>Even if interlocking mitigates some of the risks associated with operating trains, a major one is left out: head to tail collisions, caused by insufficient spacing.</p><p>This responsibility is handled by signaling, which conveys both interlocking and spacing constraints.</p><p>Signaling helps trains slow down until the end of their movement authority, which is either:</p><ul><li>behind the tail of the next train</li><li>at the end of the last route set for this train</li></ul><p><strong>Spacing requirements are emitted for zones which if occupied, would cause a slowdown, and zones occupied by the train</strong></p><h3 id=generating-requirements-1>Generating requirements</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>SpacingRequirement</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>zone</span>: <span style=color:#000>ZoneId</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>begin_time</span>: <span style=color:#000>Time</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>end_time</span>: <span style=color:#000>Time</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Every time the driver sees a signal, generate updated spacing requirements by calculating which zones, if occupied, would trigger a slowdown:</p><ul><li>start by assuming the zone just after the head of the train is occupied</li><li>until the train is not slowed down, move the occupied section one zone further away from the train</li></ul><h3 id=requirement-compatibility-rules-1>Requirement compatibility rules</h3><p>Requirement compatibility is evaluated for all <code>SpacingRequirement</code>s, grouped by zone.</p><p>Requirements A and B are compatible if and only if their <code>[begin_time, end_time]</code> ranges do not overlap.</p><h2 id=incremental-requirement-generation>Incremental requirement generation</h2><h3 id=routing-requirements>Routing requirements</h3><pre tabindex=0><code class=language-mermaid data-lang=mermaid>sequenceDiagram
    participant client as Client
    participant gen as Routing resource generator
    client -&gt;&gt; gen: initial path + train movement
    loop
        gen -&gt;&gt; client: prefix path extension needed
        client -&gt;&gt; gen: extra prefix path + train movement
    end
    gen -&gt;&gt; client: resource requirements
</code></pre><p>After an initial path is given, the requirement generator can ask for more <strong>prefix</strong> path (before the start of the route). The client responds with:</p><ul><li>the extra prefix path</li><li>the movement of the train over time on the given prefix path</li></ul><p>If the initial path has multiple routes, the last route is the one resource requirements are emitted for.</p><h3 id=spacing-requirements>Spacing requirements</h3><pre tabindex=0><code class=language-mermaid data-lang=mermaid>sequenceDiagram
    participant client as Client
    participant gen as Spacing resource generator
    client -&gt;&gt; gen: initial path + train movement
    loop
        gen -&gt;&gt; client: postfix path extension needed
        client -&gt;&gt; gen: extra postfix path
    end
    gen -&gt;&gt; client: resource requirements
</code></pre><p>After an initial path is given, the requirement generator can ask for more <strong>postfix</strong> path (before the start of the route).</p><h2 id=visualizing-requirements>Visualizing requirements</h2><script type=application/javascript src=mkt.js></script><p><object style=width:100% onload=mkt_hydrate(this.contentDocument.rootElement) type=image/svg+xml data=requirements-diagram.svg></object></p><p><a href=./requirements-diagram.html>Full-page requirements diagram</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-5c302d0351a984c31f1516d7661b618f>2.3 - Search for last-minute train slots (STDCM)</h1><p>OSRD can be used to find a slot for a train in an already established
timetable, without causing conflicts with other trains.</p><p>The acronym STDCM (Short Term Digital Capacity Management) is used
to describe this concept in general.</p></div><div class=td-content><h1 id=pg-947b82c2b20e8d312398ef2a5634cd3c>2.3.1 - Business context</h1><p>Some definitions:</p><h3 id=capacity>Capacity</h3><p><strong>Capacity</strong>, in this context, is the ability to
reserve infrastructure elements to allow the passage of a train.</p><p>Capacity is expressed in both space and time:
the reservation of an element can block a specific zone
that becomes inaccessible to other trains, and this reservation
lasts for a given time interval.</p><p>It can be displayed
on a chart, with the time on the horizontal axis
and the distance traveled on the vertical axis.</p><p><img src=space_time_chart.png alt="Space-time chart"></p><blockquote><p>Example of a space-time chart displaying the passage of a train.</p><p>The colors here represent aspects of the signals, but
display a consumption of the capacity as well:
when these blocks overlap for two trains, they conflict.</p></blockquote><p>There is a <strong>conflict</strong> between two trains when they reserve
the same object at the same time, in incompatible configurations.</p><p><img src=conflict.png alt="Space-time chart with conflict"></p><blockquote><p>Example of a space-time graph with a conflict: the second train
is faster than the first one, they are in conflict at the end
of the path, when the rectangles overlap.</p><p>When simulating this timetable, the second train would be
slowed down by the yellow signals, caused by the
presence of the first train.</p></blockquote><h3 id=train-slots>Train slots</h3><p>A <strong>train slot</strong> corresponds to a capacity reservation
for the passage of a train. It is fixed in space and time:
the departure time and the path taken are known.
On the space-time charts in this page, a train slot corresponds
to the set of blocks displayed for a train.</p><blockquote><p>Note: in English-speaking countries, these are often simply called &ldquo;train paths&rdquo;.
But in this context, this name would be ambiguous with the
physical path taken by the train.</p></blockquote><p>The usual procedure is for the infrastructure manager
(e.g. SNCF Réseau) to offers train slots for sale to
railway companies (e.g. SNCF Voyageurs).</p><p>At a given date before the scheduled day of operation,
all the train paths are allocated. But <strong>there may be
enough capacity to fit more trains</strong>. Trains can fit between
scheduled slots,
when they are sufficiently far apart or have not found a buyer.</p><p>The remaining capacity after the allocation of train paths is called
<strong>residual capacity</strong>. This section explains how OSRD looks
for train slots in this residual capacity.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f0e665bd09334507f4e0f2438621834b>2.3.2 - Train slot search module</h1><p>This module handles the search for solutions.</p><p>To reduce the problem to its simplest form and for easy and efficient
testing, inputs and outputs are strongly simplified and abstracted.</p><p>To summarize its behavior:
the solution space is described as a graph that encodes locations,
time, and speed. A pathfinding is run on this graph to find a solution.</p><p>This graph could, in a way, be seen as a decision tree,
but different paths can lead to the same node.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a4f78c201b7f1d0e1991144fff21f26a>2.3.2.1 - Input format</h1><p>This module takes several parameters to find a path:</p><ul><li>A graph describing the physical infrastructure</li><li>Unavailable sections in time intervals</li><li>Origin and destination point(s)</li><li>Departure time interval</li><li>Maximum run time</li><li>Simulation parameters (rolling stock, time step, allowances, &mldr;)</li></ul><p>Among those, the first 3 require more explanations.</p><h4 id=infrastructure-graph>Infrastructure graph</h4><p>Today, the input graph is the <code>SignalingRoutes</code> graph.
But it can be any graph that represents the physical infrastructures
and the paths that can be used.</p><p>The only constraints are: the edges must have a length, and it must
be possible to compute running time on parts of an edge.</p><h4 id=unavailable-sections>Unavailable sections</h4><p>This input encodes the areas that are unavailable because of
capacity constraints.</p><p>Every edge has a set of &ldquo;occupancy block&rdquo;. A block is made of these elements:</p><ul><li>Start offset</li><li>End offset</li><li>Start time</li><li>End time</li></ul><p>Offsets are relative to the start of the edge. Each block means that
the <em>head</em> of the train cannot be located in the edge
segment during the given interval.</p><p>These blocks include the grid margin. If the solution needs to have
an <code>x</code> seconds margin before the train passage, every block ends
<code>x</code> seconds later.</p><p>To give an example, with the following schedule, a 42m long train,
and 10m sight distance:</p><p><img src=unavailable_sections.svg alt="Unavailable section example"></p><ul><li>The occupancy of the block 1 from t=0 to t=300 makes it unavailable
in its entirety during this time</li><li>The last 10 meters of block 1 are unavailable from t=300 to t=360,
because the signal at the start of block 2 must be green when the
conductor sees it. It is possible to consider that this unavailability block
starts at t=130 (when the next signal isn&rsquo;t green), as blocks can overlap.</li><li>The occupancy of block 2 from t=130 to t=360 makes it unavailable
during this time. It is also unavailable from t=0, as the presence of a
train in this block would cause a warning on block 1.</li><li>The first 42 meters of block 3 are unavailable from t=0 to t=360,
because the tail of the train must have left the block 2 at this time.</li><li>The rest of block 3 is unavailable in its entirety from t=280 to t=360</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-12bb8a99ebcc826ad37983a300610aed>2.3.2.2 - Encoding the solution space</h1><h4 id=general-principle>General principle</h4><p>The problem is still a pathfinding problem in a given graph.
Once the problem is encoded as a graph search, it is possible to reuse
our existing tools for this purpose.</p><p>We consider the <em>product graph</em> of position, time, and speed.
This means that every graph element contains these 3 variables
(among other things)</p><p>Every graph edge is computed using
<a href=https://osrd.fr/en/docs/explanation/running_time_calculation/ title="running-time calculation">running-time calculation</a>
to get speed and positions as functions of time.</p><h4 id=graphical-representation>Graphical representation</h4><p>Space is encoded with a graph that contains the physical infrastructure.</p><p><img src=routes_time_1.png alt="product graph (1/3)"></p><p>It is then &ldquo;duplicated&rdquo; at different times.</p><p><img src=routes_time_2.png alt="product graph (2/3)"></p><p>The nodes are then linked together in a way that reflects travel time.</p><p><img src=routes_time_3.png alt="product graph (3/3)"></p><h4 id=notes>Notes</h4><ul><li>The graph is constructed on the fly as it is explored.</li><li>It is <em>discretized</em> in time, to evaluate which nodes have already
been visited. We keep full accuracy of time values, but two nodes
at the same place and close times are considered identical.</li><li>Every edge is computed with a running time computation.</li><li>Speed isn&rsquo;t discretized or considered to check visited nodes,
it&rsquo;s only used to compute time.</li><li>By default, the train always goes as fast as it can
(while still following standard allowances).
It only slows down when necessary.</li></ul><h4 id=example>Example</h4><p>For example, with the following infrastructure, using the track graph:
<img src=example_infra.svg alt="Example infra"></p><p>Exploring the solution graph can give the following result:
<img src=example_graph.svg alt="Représentation du graphe"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-74094845d6db946e31db476ef1c506a2>2.3.2.3 - Discontinuities and backtracking</h1><h4 id=the-discontinuity-problem>The discontinuity problem</h4><p>When a new graph edge is visited, a simulation is run to evaluate
its speed. But it is not possible to see beyond the current edge.
This makes it difficult to compute braking curves, because
they can span over several edges.</p><p><img src=discontinuity.png alt=Discontinuity></p><blockquote><p>This example illustrates the problem: by default
the first edge is explored by going at maximum speed.
The destination is only visible once the second edge is visited,
which doesn&rsquo;t leave enough distance to stop.</p></blockquote><h4 id=solution--backtracking>Solution : backtracking</h4><p>To solve this problem, when an edge is generated with a
discontinuity in the speed envelopes, the algorithm goes back
over the previous edges to create new ones that include the
decelerations.</p><p>To give a simplified example, on a path of 4 edges
where the train can accelerate or decelerate by 10km/h per edge:</p><p><img src=backtracking_1.png alt="Discontinuity (edge version, 1/2)"></p><p>For the train to stop at the end of route 4, it must be at most
at 10km/h at the end of edge 3. A new edge is then created on
edge 3, which ends at 10km/h. A deceleration is computed
backwards from the end of the edge back to the start,
until the original curve is met (or the start of the edge).</p><p>In this example, the discontinuity has only been moved to the
transition between edges 2 and 3. The process is then repeated
on edge 2, which gives the following result:</p><p><img src=backtracking_2.png alt="Discontinuity (edge version, 2/2)"></p><p>Old edges are still present in the graph as they can lead to other solutions.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-615ce0cf6c404cd85469e6285e5feb90>2.3.2.4 - Conflict avoidance</h1><p>While exploring the graph, it is possible to end up in locations that would
generate conflicts. They can be avoided by adding delay.</p><h4 id=shifting-the-departure-time>Shifting the departure time</h4><p>The departure time is defined as an interval in the module parameters:
the train can leave at a given time, or up to <code>x</code> seconds later.
Whenever possible, delay should be added by shifting the departure time.</p><blockquote><p>for example : a train can leave between 10:00 et 11:00. Leaving
at 10:00 would cause a conflict, the train actually needs to enter the
destination station 15 minutes later. Making the train leave at
10:15 solves the problem.</p></blockquote><p>In OSRD, this feature is handled by keeping track, for every edge,
of the maximum duration by which we can delay the departure time.
As long as this value is enough, conflicts are avoided this way.</p><p>This time shift is a value stored in every edge of the path.
Once a path is found, the value is summed over the whole path.
This is added to the departure time.</p><blockquote><p>For example :</p><ul><li>a train leaves between 10:00 and 11:00. The initial maximum
time shift is 1:00.</li><li>At some point, an edge becomes unavailable 20 minutes after the
train passage. The value is now at 20 for any edge accessed from here.</li><li>The departure time is then delayed by 5 minutes to avoid a conflict.
The maximum time shift value is now at 15 minutes.</li><li>This process is applied until the destination is found,
or until no more delay can be added this way.</li></ul></blockquote><h4 id=engineering-allowances>Engineering allowances</h4><p>Once the maximum delay is at 0, the delay needs to be added
between two points of the path.</p><p><img src=engineering_allowance.png alt="Engineering allowances (1/2)"></p><p>The idea is the same as the one used to fix speed discontinuities:
new edges are created, replacing the previous ones.
The new edges have an engineering allowance, to add the delay where
it is possible.</p><p><img src=engineering_allowance_edges.png alt="Engineering allowances (2/2)"></p><p>computing an
<a href=https://osrd.fr/en/docs/explanation/running_time_calculation/allowances/ title=allowances>engineering allowance</a>
is a feature of the running-time
calculation module. It adds a given delay between two points of
a path, without affecting the speeds on the rest of the path.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ed97b39b0c3816e4f1073f363957a3e3>2.3.2.5 - Standard allowance</h1><p>The STDCM module must be usable with
<a href=https://osrd.fr/en/docs/explanation/running_time_calculation/allowances/ title="marge de régularité">standard allowances</a>.
The user can set an allowance value, expressed either as a function of
the running time or the travelled distance. This time must be added to the
running time, so that it arrives later compared to its fastest possible
running time.</p><blockquote><p>For example: the user can set a margin of 5 minutes per 100km.
On a 42km long path that would take 10 minutes at best,
the train should arrive 12 minutes and 6 seconds after leaving.</p></blockquote><p>This can cause problems to detect conflicts, as an allowance would move
the end of the train slot to a later time.
The allowance must be considered when we compute conflicts as
the graph is explored.</p><p>The allowance must also follow the <a href=/pdf/MARECO.pdf>MARECO</a> model:
the extra time isn&rsquo;t added evenly over the whole path,
it is computed in a way that requires knowing the whole path.
This is done to optimize the energy used by the train.</p><h4 id=linear-margin-expressed-as-a-function-of-time>Linear margin expressed as a function of time</h4><p>As a first step, the problem is solved with a linear margin,
i.e. added evenly over the whole path.
The speed is simply modified by a constant factor.</p><p>The <a href=https://osrd.fr/en/docs/explanation/running_time_calculation/envelopes_system/ title=envelopes>envelopes</a>.
computed during the graph traversal are not modified, they are always
at maximum speed. But they are paired with a speed factor, which is used
to compute running time and to evaluate conflicts.</p><p>The final envelope, with the allowance, is only computed once a path
is found.</p><h4 id=linear-margin-expressed-as-a-function-of-distance>Linear margin expressed as a function of distance</h4><p>The principle is generally the same, but with an extra difficulty:
the speed factor isn&rsquo;t constant over the path.
When a train goes faster, it travels more distance in the same time,
which increases the allowance time and the speed factor.</p><p>Because the train speed changes over the path, the speed factor
changes from one edge to another. This causes irregular speed curves.</p><h4 id=mareco-allowances>MARECO Allowances</h4><p>This is exclusively a post-processing step,
because it isn&rsquo;t possible to compute the MARECO envelope
without knowing the full train path.
When looking for a path, linear allowances are used.</p><p>This means that conflicts may appear at this step.
To avoid them, the following procedure is applied:</p><ol><li>A mareco allowance is applied over the whole path.</li><li>If there are conflict, the first one is considered.</li><li>The mareco allowance is <em>split in two intervals</em>.
The point where the first conflict appeared is set
to be at the same time as the envelope with a linear allowance,
removing the conflict at this point.</li><li>This process is repeated iteratively until no conflict is found.</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-460b1be4e2f2584372a451ceef833731>2.3.2.6 - Implementation details</h1><p>This page is about implementation details.
It isn&rsquo;t necessary to understand general principles,
but it helps before reading the code.</p><h4 id=stdcmedgebuilder>STDCMEdgeBuilder</h4><p>This refers to
<a href=https://github.com/osrd-project/osrd/blob/dev/core/src/main/java/fr/sncf/osrd/stdcm/graph/STDCMEdgeBuilder.java>this class</a>
in the project.</p><p>This class is used to make it easier to create instances of
<code>STDCMEdge</code>, the graph edges. Those contain many attributes,
most of which can be determined from the context (e.g. the
previous node).
The <code>STDCMEdgeBuilder</code> class makes some parameters optional
and automatically computes others.</p><p>Once instantiated and parametrized, an <code>STDCMEdgeBuilder</code> has two methods:</p><ul><li><p><code>Collection&lt;STDCMEdge> makeAllEdges()</code> can be used to create all
the possible edges in the given context for a given route.
If there are several &ldquo;openings&rdquo; between occupancy blocks, one edge
is instantiated for each opening. Every conflict, their avoidance,
and their related attributes are handled here.</p></li><li><p><code>STDCMEdge findEdgeSameNextOccupancy(double timeNextOccupancy)</code>:
This method is used to get the specific edges that uses a certain
opening (when it exists), identified here with the time of the next
occupancy block. It is called whenever a new edge must be re-created
to replace an old one. It calls the previous method.</p></li></ul><h3 id=pathfinding>Pathfinding</h3><p>The methods mentioned here are defined in
<a href=https://github.com/osrd-project/osrd/blob/dev/core/src/main/java/fr/sncf/osrd/stdcm/graph/STDCMPathfinding.java>this class</a>.</p><h4 id=cost-function>Cost function</h4><p>The function used to define pathfinding cost sets which path
is used over another. The result is always the one that minimizes
this cost (as long as the heuristic is admissible).</p><p>Here, two parameters are used: total run time and departure time.
The latter has a very small weight compared to the former,
so that the fastest path is found. More details
are explained in the documentation of those methods.</p><h4 id=heuristics>Heuristics</h4><p>The algorithm used to find a path is an A*, with a heuristic based
on geographical coordinates.</p><p>However, the coordinates of generated infrastructures are arbitrary
and don&rsquo;t reflect the track distance. It means that,
for the generated infrastructures, the path may not always be the
shortest one.</p><p>It would be possible to use this heuristic to determine whether
the current node can lead to a path that doesn&rsquo;t take
longer than the maximum allowed total run time. But for the same
reason, adding this feature would break any STDCM test on generated
infras. More details in
<a href=https://github.com/osrd-project/osrd/issues/2818>this issue</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-8ee6423983b11793e61c99ce092f6373>2.3.3 - Signaling interface</h1><p>WIP</p><p>There&rsquo;s a draft of what we intend to do on the French page,
but it&rsquo;s still a work in progress.
The implementation hasn&rsquo;t been started.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c963971a74112cd3ec208d3977cd25e5>3 - APIs</h1><div class=lead>Programming interfaces specifications</div></div><div class=td-content><h1 id=pg-20edb78a2f57bbf0e0aadeb2bd6baaab>3.1 - JSON Schemas</h1><script src=https://cdn.rawgit.com/caldwell/renderjson/master/renderjson.js></script><div id=container><h1>Infrastructure</h1></div><script>var infra={};tmp=$.ajax({url:"/schemas/infra_schema.json",async:!1,dataType:'json',success:function(e){infra=e}}),document.getElementById("container").appendChild(renderjson(infra))</script><div id=container2><h1>Rolling Stock</h1></div><script>var rolling_stock={};tmp=$.ajax({url:"/schemas/rolling_stock_schema.json",async:!1,dataType:'json',success:function(e){rolling_stock=e}}),document.getElementById("container2").appendChild(renderjson(rolling_stock))</script><style>#container,#container2{text-shadow:none;background:;padding:1em}.renderjson a{text-decoration:none}.renderjson .disclosure{color:#aa026d;font-size:150%}.renderjson .syntax{color:grey}.renderjson .string{color:#000}.renderjson .number{color:cyan}.renderjson .boolean{color:plum}.renderjson .key{color:#aa026d}.renderjson .keyword{color:#fafad2}.renderjson .object.syntax{color:#20b2aa}.renderjson .array.syntax{color:#ffa07a}</style></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/osrd-project/osrd aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 OSRD contributors. All Rights Reserved</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/mermaid@8.13.4/dist/mermaid.min.js integrity="sha512-JERecFUBbsm75UpkVheAuDOE8NdHjQBrPACfEQYPwvPG+fjgCpHAz1Jw2ci9EXmd3DdfiWth3O3CQvcfEg8gsA==" crossorigin=anonymous></script><style>.markmap>svg{width:100%;height:300px}</style><script>window.markmap={autoLoader:{manual:!0}}</script><script src=https://cdn.jsdelivr.net/npm/markmap-autoloader></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.928c8c2d8b4f463998503da833bc465b748d40b80287e0398a7e1a38ab1c87a2.js integrity="sha256-koyMLYtPRjmYUD2oM7xGW3SNQLgCh+A5in4aOKsch6I=" crossorigin=anonymous></script></body></html>