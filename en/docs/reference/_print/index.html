<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=canonical type=text/html href=https://osrd.fr/en/docs/reference/><link rel=alternate type=application/rss+xml href=https://osrd.fr/en/docs/reference/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Technical reference | OSRD</title>
<meta name=description content="Internal machinery and APIs"><meta property="og:title" content="Technical reference"><meta property="og:description" content="Internal machinery and APIs"><meta property="og:type" content="website"><meta property="og:url" content="https://osrd.fr/en/docs/reference/"><meta itemprop=name content="Technical reference"><meta itemprop=description content="Internal machinery and APIs"><meta name=twitter:card content="summary"><meta name=twitter:title content="Technical reference"><meta name=twitter:description content="Internal machinery and APIs"><link rel=preload href=/scss/main.min.4d9db1288b215f6876c21ef883bcd30df98e7409451895d47ac7aa0297a1a496.css as=style><link href=/scss/main.min.4d9db1288b215f6876c21ef883bcd30df98e7409451895d47ac7aa0297a1a496.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.3.min.js integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="td-navbar navbar-dark js-navbar-scroll"><div class="container-fluid flex-column flex-md-row"><a class=navbar-brand href=/en/><span class="navbar-brand__logo navbar-logo"><svg xmlns="http://www.w3.org/2000/svg" id="svg36" width="110.767" height="22"><style id="style1">.st9{fill:#fff}</style><g id="ok" transform="scale(.1918)"><g id="g36"><g id="g29"><path id="path23" d="M38.5 83.4c-1.9 8.2-2.9 17-2.9 26.5v4.8h16.6c-2.8-13.2-7.8-23.4-13.7-31.3z" class="st9"/><path id="path24" d="M0 57.5v19.9c3.1 1.2 6.3 2.7 9.5 4.6 8.5 5.2 15 12.6 19.4 21.8v-31c-3.4-3-6.9-5.5-10.3-7.5-6.5-3.7-13-6.2-18.6-7.8z" class="st9"/><path id="path25" d="M35.6 69.9c4.3-11.3 10.6-21.1 18.9-29.4V0H35.6z" class="st9"/><path id="path26" d="M40.8 75.4c5.3 6.2 10.1 13.8 13.7 23.3V50.6C48.6 57.8 44 66.1 40.8 75.4z" class="st9"/><path id="path27" d="M100.7.0H61.3v34.5C73.1 25.2 86 20 96.9 17.2c1.8-.5 3.7.6 4.1 2.4.5 1.8-.6 3.6-2.4 4.1-11.4 2.9-25.3 8.6-37.2 19.7v31.8c2.9-6.3 6.7-11.7 11.4-16.4 9.4-9.3 21-14.1 30.5-16.6 1.8-.5 3.7.6 4.1 2.4.5 1.8-.6 3.6-2.4 4.1-4.7 1.2-10.1 3.1-15.3 6-19 10.3-28.2 28.4-28.2 55.2v4.8h39.3c7.8.0 14.1-6.3 14.1-14.1V14.1C114.7 6.3 108.4.0 100.7.0z" class="st9"/><path id="path28" d="M22 59.6c2.2 1.3 4.5 2.8 6.8 4.6V0H14.1C6.3.0.0 6.3.0 14.1v36.4c6.5 1.7 14.2 4.5 22 9.1z" class="st9"/><path id="path29" d="M5.4 87.5c-1.8-1.1-3.6-2-5.4-2.8v15.9c0 7.8 6.3 14.1 14.1 14.1h11.6c-3.6-12.2-10.4-21.3-20.3-27.2z" class="st9"/></g><g id="g30"><path id="path30" d="M201.7 109c-30.8.0-53.7-21.2-53.7-52.5.0-31.7 22.9-51.6 53.7-51.6 31 0 53.9 20 53.9 51.6-.1 31.3-23 52.5-53.9 52.5zm0-82.6c-16.7.0-28.2 12.8-28.2 30.1.0 17.9 11.6 30.7 28.2 30.7S230 74.4 230 56.6c0-17.3-11.6-30.2-28.3-30.2z" class="st9"/></g><g id="g32"><g id="g31"><path id="path31" d="M334.3 33.3c-4-5.2-11.4-8.5-17.6-8.5-6.2.0-13.8 2.1-13.8 9.9.0 6.6 5.9 8.7 15.2 11.6 13.4 4.3 30.7 10 30.7 29.7.0 22.7-18.3 32.9-37.8 32.9-14.1.0-28.3-5.2-37-14.2l15.6-15.9c4.7 6 13.5 10.5 21.3 10.5 7.3.0 13.7-2.8 13.7-10.7.0-7.5-7.5-9.9-20.5-14.1C291.6 60.3 279 53.9 279 36c0-21.9 19.8-31 38.2-31 11.2.0 23.7 4.2 32.4 12.1z" class="st9"/></g></g><g id="g34"><g id="g33"><path id="path32" d="m433.1 106.4-21.3-39.2h-8.1v39.2h-23.4V7.6H418c19 0 37.8 7.3 37.8 29.9.0 13.3-7.8 22.7-20.5 26.6l25.8 42.3zm-16.9-79.6h-12.7v23h11.3c7.7.0 17.3-2 17.3-12 0-9.2-8.7-11-15.9-11z" class="st9"/></g></g><g id="g35"><path id="path34" d="M522.2 106.4h-36.8V7.6H521c28 0 56.5 11.7 56.5 49.1.0 34.7-28.1 49.7-55.3 49.7zm-1.7-78.5h-11.9v57.8h11.3c17 0 32.8-7 32.8-29 0-22.2-15.8-28.8-32.2-28.8z" class="st9"/></g></g></g></svg></span><span class=navbar-brand__name>OSRD</span></a><div class="td-navbar-nav-scroll ms-md-auto" id=main_navbar><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/en/about/><span>About</span></a></li><li class=nav-item><a class="nav-link active" href=/en/docs/><span>Documentation</span></a></li><li class=nav-item><a class=nav-link href=/en/blog/><span>Blog</span></a></li><li class="nav-item dropdown d-none d-lg-block"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><ul class=dropdown-menu><li><a class=dropdown-item href=/fr/docs/reference/>Français</a></li></ul></div></li></ul></div><div class="d-none d-lg-block"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder="Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.e507d32b9e31bc11ef7c669039708854.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/en/docs/reference/>Return to the regular view of this page</a>.</p></div><h1 class=title>Technical reference</h1><div class=lead>Internal machinery and APIs</div><ul><li>1: <a href=#pg-956c746a8215379d75cfcf5474a683e3>Architecture</a></li><ul><li>1.1: <a href=#pg-563493d51cba2cf0991bc456da66a1b1>Data-flow</a></li><li>1.2: <a href=#pg-8c50df3d62cb7d3b188a4daf7e4536fd>Services</a></li></ul><li>2: <a href=#pg-9bd47f930a6befba383b5f079fd5620d>Design documents</a></li><ul><li>2.1: <a href=#pg-66ca35805c319e31c2d4731f9ba724cb>Signaling</a></li><ul><li>2.1.1: <a href=#pg-a13c7252a608d9b4f83805055888abca>Signaling systems</a></li><li>2.1.2: <a href=#pg-0ddc3365b71acf7992582218d337a954>Blocks and signals</a></li><li>2.1.3: <a href=#pg-6fc6d9cd43d8303e9afcb126b6a5cabd>Speed limits</a></li><li>2.1.4: <a href=#pg-4af0b951e1d3073e37165f2ea66d0d5f>Simulation lifecycle</a></li></ul><li>2.2: <a href=#pg-6802b8721cfb6034a773e0771f4b7493>Conflict detection</a></li><li>2.3: <a href=#pg-5c302d0351a984c31f1516d7661b618f>Search for last-minute train slots (STDCM)</a></li><ul><li>2.3.1: <a href=#pg-947b82c2b20e8d312398ef2a5634cd3c>Business context</a></li><li>2.3.2: <a href=#pg-f0e665bd09334507f4e0f2438621834b>Train slot search module</a></li><ul><li>2.3.2.1: <a href=#pg-397a7d0b773c457d82f0a20b928d52b4>Infrastructure exploration</a></li><li>2.3.2.2: <a href=#pg-47b91c7f9ce15fcf0e7131cd9fc9dc37>Conflict detection</a></li><li>2.3.2.3: <a href=#pg-12bb8a99ebcc826ad37983a300610aed>Encoding the solution space</a></li><li>2.3.2.4: <a href=#pg-74094845d6db946e31db476ef1c506a2>Discontinuities and backtracking</a></li><li>2.3.2.5: <a href=#pg-615ce0cf6c404cd85469e6285e5feb90>Conflict avoidance</a></li><li>2.3.2.6: <a href=#pg-ed97b39b0c3816e4f1073f363957a3e3>Standard allowance</a></li><li>2.3.2.7: <a href=#pg-460b1be4e2f2584372a451ceef833731>Implementation details</a></li></ul></ul><li>2.4: <a href=#pg-4d0f19ea5ea7b131826269e88f6b283d>Timetable v2</a></li><li>2.5: <a href=#pg-d68749890c12f16864453cedb0b81cde>Authentication and authorization</a></li><ul><li>2.5.1: <a href=#pg-ad1fe861914919710a4ff4f68d0c334d>Editoast internal authorization API</a></li></ul><li>2.6: <a href=#pg-7bd41c6c5ba86329c3d475a15fc8fc73>Scalable async RPC</a></li></ul></ul><div class=content><p>Technical reference guides contain technical reference for APIs and other aspects of OSRD&rsquo;s machinery. They describe how it works and how to use it but assume that you have a basic understanding of key concepts.</p></div></div><div class=td-content><h1 id=pg-956c746a8215379d75cfcf5474a683e3>1 - Architecture</h1><div class=lead>Learn more about OSRD architecture</div><p>Architecture documents are meant to help understand how OSRD works overall.</p></div><div class=td-content><h1 id=pg-563493d51cba2cf0991bc456da66a1b1>1.1 - Data-flow</h1><div class=lead>OSRD&rsquo;s data-flow diagram</div><p><img src=data_flow.svg alt="Data-flow diagram"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-8c50df3d62cb7d3b188a4daf7e4536fd>1.2 - Services</h1><div class=lead>OSRD&rsquo;s services architecture</div><p>It is a multi-service architecture where several software components interact with each other. This choice was made to ensure the modularity of the code and to guarantee the exploitability of certain OSRD services by external applications.</p><h2 id=current>Current</h2><p><img src=services.en.svg alt="Services architecture"></p><h2 id=target>Target</h2><p>Mutiple things are planned to be done in the future, including:</p><ul><li><input checked disabled type=checkbox> Add an authenticating reverse proxy service (gateway)</li><li><input checked disabled type=checkbox> Deploy <code>editoast</code> as a scalable map tile service</li><li><input disabled type=checkbox> Make the <code>core</code> service scalable<ul><li>Core services will handle only one infrastructure (on a given version) at a time</li><li>Add a message broker (RabbitMQ) to dispatch queries to the right instance</li><li>Create a <code>core-controller</code> service that will spawn / kill / scale <code>core</code> services (k8s and docker support)</li><li>Responsibility for infrastructures loading is moved from the front to the <code>core-controller</code></li></ul></li></ul><p><img src=services_target.en.svg alt="Services architecture"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-9bd47f930a6befba383b5f079fd5620d>2 - Design documents</h1><div class=lead>Learn more about how the software was designed</div><p>Design documents are meant to help understand and participate in designing software.</p><p>Each design document describes a number of things about a piece of software:</p><ul><li>its goals</li><li>its constraints</li><li>how its inputs and outputs were modeled</li><li>how it works</li></ul></div><div class=td-content><h1 id=pg-66ca35805c319e31c2d4731f9ba724cb>2.1 - Signaling</h1><div class=lead>Describes the signaling model</div><h2 id=description>Description</h2><p>The signaling layer includes all signals, which respond to track occupancy and
reservation. Signals can be of different types, and are modularly loaded. Only
their behavior towards the state of the infrastructure and the train&rsquo;s reaction
to signaling matters.</p><p>Signals are connected to each other by blocks. Blocks define paths permitted
by signaling.</p><h2 id=goals>Goals</h2><p>The signaling system is at the crossroads of many needs:</p><ul><li>it must allow for realistic signaling simulation in a multi-train simulation</li><li>it must allow the conflict detection system to determine which resources are required for the train</li><li>it must allow application users to edit and display signals</li><li>it must allow for visualization of signals on a map</li><li>it must allow for automated import from existing databases</li></ul><h2 id=design-requirements>Design requirements:</h2><p>All static data:</p><ul><li>must enable the front-end to display the signals</li><li>must enable the infrastructure editor to configure signals</li><li>must enable the back-end to simulate signals</li><li>must be close to realistic industry models</li><li>must allow for the modeling of composite signals, which carry several
logical signals within a single physical signal</li></ul><p>To simulate signaling:</p><ul><li>blocks must be generated for both user convenience and <strong>pathfinding</strong></li><li>for each signal, its <strong>next compatible signal</strong> and <strong>protected zones</strong> must be deduced</li><li>the <strong>minimum necessary information</strong> must be provided to the signaling modules for their operation</li><li>enable using signaling modules without instantiating a complete simulation</li><li>allow for signals to be loaded in any order, in parallel</li></ul><p>For speed limits:</p><ul><li>some speed limits have to be enforced depending on the train path&rsquo;s routes</li><li>speed limits can be configured to have an impact on signaling</li><li>ability to link the reaction of the train to a signal, and a speed limit</li></ul><h2 id=assumptions>Assumptions</h2><ul><li>Each physical signal can be decomposed into a list of logical signals, all of which are associated with a signaling system.</li><li>Blocks have a type.</li><li>It is possible to compute, given a signal alone, its block and route delimiting properties.</li><li>Blocks never cross route boundaries.</li><li>Blocks which are not covered by routes do not exist, or can be ignored.</li><li>At any time, trains only use one signaling system capable of transmitting movement authority.</li><li>Speed limits change depending on which route is in use, and affect how signals behave</li><li>Some speed limits have an impact on signaling, and some do not</li><li>Either a speed limits differentiates per train category, or requires dynamic signaling, but not both</li></ul><h2 id=operations>Operations</h2><ul><li><strong>Instantiating a view</strong> creates a framework for observing signals</li><li><strong>Planning the path signals</strong> to the view the blocks that the train will traverse</li><li><strong>Observing a signal</strong> subscribe to the state of a signal (through the view)</li><li><strong>Passing a signal</strong> signals that a signal has been passed by the train (through the view)</li></ul><h2 id=research-questions>Research Questions</h2><ul><li>Are there any blocks that overlap the end of a route? SNCF(Loïc): No.</li><li>Are there any signals which rely on the state of the one after next signal? SNCF(Loïc): No.</li><li>Are there signals that change behavior based on the active block in front of them? SNCF(Loïc): Yes, for slowdowns.</li><li>Are there signals that are the start of blocks of different types? SNCF(Loïc): Yes.</li><li>Can the behavior of a signal depend on which block is active after the end of the current block? SNCF(Loïc): Yes, with slowdowns or blinking yellow.</li><li>Do some signaling systems need additional information in the blocks? SNCF(Loïc): Kind of, there are slowdowns, but it&rsquo;s not specifically carried by the block.</li><li>Is it nominal for a train to have multiple active signaling systems at the same time? SNCF(Loïc): No.</li><li>are there any signals which depend on which route is set, but are not route delimiters? SNCF(Loïc): Yes, see Sémaphore Clignotant</li><li>how do speed limits per train category and dynamic signaling interact? SNCF(Nicolas): There shouldn&rsquo;t be any speed limit per category signaled by dynamic signaling</li><li>are there any signals which depend on the state of multiple routes? SNCF(Loïc): No</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a13c7252a608d9b4f83805055888abca>2.1.1 - Signaling systems</h1><p>Each signaling system has:</p><ul><li>A unique identifier (a string).</li><li>Its signal state type, which enables deducing:<ul><li>The graphical representation of the signal</li><li>How a train would react to the signal</li><li>If the signal state constrains Movement Authority</li></ul></li><li>The signal parameter types, names and description, which enable front-end edition of signal parameters.</li><li>The block and route conditions, which enable evaluating whether a signal delimits blocks or routes, given its parameters.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># unique identifier for the signaling system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;id&#34;: </span><span style=color:#4e9a06>&#34;BAL&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;version&#34;: </span><span style=color:#4e9a06>&#34;1.0&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># the schema of the dynamic state of signals of this type</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;signal_state&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;enum&#34;, &#34;field_name&#34;: </span><span style=color:#4e9a06>&#34;aspect&#34;</span><span style=color:#204a87;font-weight:700>, values</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;VL&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;A&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;S&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;C&#34;</span><span style=color:#000;font-weight:700>]</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: </span><span style=color:#4e9a06>&#34;ralen30&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: </span><span style=color:#4e9a06>&#34;ralen60&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: </span><span style=color:#4e9a06>&#34;ralen_rappel&#34;</span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># describes static properties of the signal</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;signal_properties&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: &#34;Nf&#34;, &#34;display_name&#34;: </span><span style=color:#4e9a06>&#34;Non-franchissable&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: &#34;has_ralen30&#34;, &#34;default&#34;: false, &#34;display_name&#34;: </span><span style=color:#4e9a06>&#34;Ralen 30&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: &#34;has_rappel30&#34;, &#34;default&#34;: false, &#34;display_name&#34;: </span><span style=color:#4e9a06>&#34;Rappel 30&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: &#34;has_ralen60&#34;, &#34;default&#34;: false, &#34;display_name&#34;: </span><span style=color:#4e9a06>&#34;Ralen 60&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: &#34;has_rappel60&#34;, &#34;default&#34;: false, &#34;display_name&#34;: </span><span style=color:#4e9a06>&#34;Rappel 60&#34;</span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># describes dynamic properties of the signal. These can be set on a per-route basis</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;signal_parameters&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: &#34;short_block&#34;, &#34;default&#34;: false, &#34;display_name&#34;: </span><span style=color:#4e9a06>&#34;Short block&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: &#34;rappel30&#34;, &#34;default&#34;: false, &#34;display_name&#34;: </span><span style=color:#4e9a06>&#34;Rappel 30&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: &#34;rappel60&#34;, &#34;default&#34;: false, &#34;display_name&#34;: </span><span style=color:#4e9a06>&#34;Rappel 60&#34;</span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># these are C-like boolean expressions:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># true, false, &lt;flag&gt;, &lt;enum&gt; == value, &amp;&amp;, || and ! can be used</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># used to evaluate whether a signal is a block boundary. Only properties can be used, not parameters.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;block_boundary_when&#34;: </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># used to evaluate whether a signal is a route boundary. Only properties can be used, not parameters.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;route_boundary_when&#34;: </span><span style=color:#4e9a06>&#34;Nf&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># A predicate used evaluate whether a signal state can make a train slow down. Used for naive conflict detection.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;constraining_ma_when&#34;: </span><span style=color:#4e9a06>&#34;aspect != VL&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-0ddc3365b71acf7992582218d337a954>2.1.2 - Blocks and signals</h1><h1 id=blocks>Blocks</h1><p>The blocks have several attributes:</p><ul><li>A signaling system that corresponds to that displayed by its first signal.</li><li>A <strong>path</strong>, which is a list of direction + detector pairs (just like route paths).</li><li>An <strong>entry signal</strong>, (optional when the block starts from a buffer stop).</li><li><strong>Intermediate signals</strong>, if any (only used by systems with distant signals).</li><li>An <strong>exit signal</strong>, (optional when the block ends at a buffer stop).</li></ul><p>The path is expressed from detector to detector so that it can be overlayed with the route graph.</p><p>A few remarks:</p><ul><li>There can be multiple blocks with the same path, as long as they have different signaling systems. Trains only use a block at a time, and ignore others.</li><li>Blocks do not have a state: one can rely on the dynamic state of the zones that make it up.</li><li>Blocks are used to figure out which signals protect which zones in a given context.</li></ul><h2 id=dependencies>Dependencies</h2><ul><li>route graph. For each route:<ul><li><code>waypoints: List&lt;DiDetector></code></li><li><code>signals: OrderedMap&lt;Position, UnloadedSignal></code></li><li><code>speed_limits: RangeMap&lt;Position, SpeedLimit></code>, including the logic for train category limits</li></ul></li><li>signaling systems</li><li>drivers</li></ul><h1 id=signals>Signals</h1><p>Physical signal are made up of one or more logical signals, which are displayed as a single unit on the field. During simulation, logical signals are treated as separate signals.</p><p>Each logical signal is associated with a signaling system, which defines if the
signal transmits Movement Authority, speed limits, or both.</p><p>Logical signals have one or more drivers. Signal drivers are responsible for computing
signal state. Any given signal driver only works for a given pair of signaling systems,
where the first one is displayed by the signal, and the second is the one displayed by
the next signal.</p><p>When a logical signal has an empty driver list, its content is deduced from neighboring signals.</p><p>For example, a BAL signal that is both a departure of the TVM block and a
departure of the BAL block, it will have two drivers: <code>BAL-BAL</code> and <code>BAL-TVM</code>.</p><h2 id=announcing-speed-limits>Announcing speed limits</h2><p>When a signal announces a speed limit, it needs to be linked with a speed section object.
This is meant to enable smooth transitions between the reaction to the announce signal, and the limit itself.</p><p>If multiple signals are involved in the announce process, only the one closest to the speed limit has to have
this attribute set.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># ...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;announce_speed_section&#34;: </span><span style=color:#4e9a06>&#34;${SPEED_SECTION_ID}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># ...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=conditional-parameters>Conditional parameters</h2><p>Some signal parameters vary depending on which route is set. On each signal, an arbitrary number of rules can be added.
If the signal is last to announce a speed limit, it must be explicitly mentionned in the rule.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># ...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;announce_speed_section&#34;: </span><span style=color:#4e9a06>&#34;${SPEED_SECTION_ID}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;default_parameters&#34;: {&#34;short_block&#34;: </span><span style=color:#4e9a06>&#34;false&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;conditional_parameters&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;on_route&#34;: </span><span style=color:#4e9a06>&#34;${ROUTE_ID}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;announce_speed_section&#34;: </span><span style=color:#4e9a06>&#34;${SPEED_SECTION_ID}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;parameters&#34;: {&#34;rappel30&#34;: &#34;true&#34;, &#34;short_block&#34;: </span><span style=color:#4e9a06>&#34;true&#34;</span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># ...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Signal parameter values are looked up in the following order:</p><ol><li>per route conditional parameters</li><li>per signal default parameters (<code>default_parameters</code>)</li><li>parameter default value, from the signaling system&rsquo;s <code>.signal_parameters[].default</code></li></ol><h2 id=serialized-format>Serialized format</h2><p>The serialized / raw format is the user-editable description of a physical signal.</p><p>Raw signals have a list of logical signals, which are independently simulated units sharing
a common physical display. Each logical signal has:</p><ul><li>a signaling system</li><li>user-editable properties, as specified in the signaling system description</li><li>a list of default parameters, which can get overriden per-route</li><li>an optional announced speed section, which can get overriden per-route</li><li>a list of allowed next signaling systems, which are used to load drivers</li></ul><p>For example, this signal encodes a BAL signal which:</p><ul><li>starts both a BAL and a TVM block</li><li>announces speed limit B on all routes except route A, where speed limit C is announced</li><li>on route A, the block is shorter than usual</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># signals must have location data.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># this data is omitted as its format is irrelevant to how signals behave</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;logical_signals&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#8f5902;font-style:italic># the signaling system shown by the signal</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;signaling_system&#34;: </span><span style=color:#4e9a06>&#34;BAL&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#8f5902;font-style:italic># the settings for this signal, as defined in the signaling system manifest</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;properties&#34;: {&#34;has_ralen30&#34;: &#34;true&#34;, &#34;Nf&#34;: </span><span style=color:#4e9a06>&#34;true&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#8f5902;font-style:italic># this signal can react to BAL or TVM signals</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#8f5902;font-style:italic># if the list is empty, the signal is assumed to be compatible with all following signaling systems</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;next_signaling_systems&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;BAL&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;TVM&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;announce_speed_section&#34;: </span><span style=color:#4e9a06>&#34;${SPEED_SECTION_B}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;default_parameters&#34;: {&#34;rappel30&#34;: &#34;true&#34;, &#34;short_block&#34;: </span><span style=color:#4e9a06>&#34;false&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;conditional_parameters&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>&#34;on_route&#34;: </span><span style=color:#4e9a06>&#34;${ROUTE_A}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>&#34;announce_speed_section&#34;: </span><span style=color:#4e9a06>&#34;${SPEED_SECTION_C}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#204a87;font-weight:700>&#34;parameters&#34;: {&#34;short_block&#34;: </span><span style=color:#4e9a06>&#34;true&#34;</span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>For example, this signal encodes a BAL signal which starts a BAL block, and shares its physical display / support with a BAPR signal starting a BAPR block:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># signals must have location data.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># this data is omitted as its format is irrelevant to how signals behave</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;logical_signals&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;signaling_system&#34;: </span><span style=color:#4e9a06>&#34;BAL&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;properties&#34;: {&#34;has_ralen30&#34;: &#34;true&#34;, &#34;Nf&#34;: </span><span style=color:#4e9a06>&#34;true&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;next_signaling_systems&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;BAL&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;signaling_system&#34;: </span><span style=color:#4e9a06>&#34;BAPR&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;properties&#34;: {&#34;Nf&#34;: &#34;true&#34;, &#34;distant&#34;: </span><span style=color:#4e9a06>&#34;false&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;next_signaling_systems&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;BAPR&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=signal-description-strings>Signal description strings</h2><p>Signal definitions need to be condensed into a shorter form, just to look up signal icons.
In order to store this into MVT map tiles hassle free, it&rsquo;s condensed down into a single string.</p><p>It looks something like that: <code>BAL[Nf=true,ralen30=true]+BAPR[Nf=true,distant=false]</code>
It&rsquo;s built as follows:</p><ul><li>a list of logical signals, sorted by signaling system name, separated by <code>+</code></li><li>inside each logical signal, signal properties are sorted by name, enclosed in square brackets and separated by <code>,</code></li></ul><h2 id=dependencies-1>Dependencies</h2><p>For signal state evaluation:</p><ul><li>train path in blocks</li><li>portion of the path to evaluate</li><li>drivers</li><li>state of the zones in the section to evaluate</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-6fc6d9cd43d8303e9afcb126b6a5cabd>2.1.3 - Speed limits</h1><div class=lead>Describes how speed limits work</div><h2 id=description>Description</h2><p>Railway infrastructure has a surprising variety of speed limits:</p><ul><li>some are known by the driver, and not announced at all</li><li>some are announced by fixed signs regardless of where the train goes</li><li>some are announced by fixed signs, depending on where the train path goes</li><li>some are announced by dynamic signals regardless of where the train goes</li><li>some are announced by dynamic signals, depending on where the train path goes</li></ul><h2 id=data-model>Data model</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># unique speed limit identifier</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;id&#34;: </span><span style=color:#4e9a06>&#34;...&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># A list of routes the speed limit is enforced on. When empty</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># or missing, the speed limit is enforced regardless of the route.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># /!\ When a speed section is announced by signals, the routes it is</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># announced on are automatically filled in /!\</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;on_routes&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;${ROUTE_A}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;${ROUTE_B}&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># &#34;on_routes&#34;: null, # not conditional</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># &#34;on_routes&#34;: [], # conditional</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># A speed limit in meters per second.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;speed_limit&#34;: </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># A map from train tag to speed limit override. If missing and</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># the speed limit is announced by a signal, this field is deduced</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># from the signal.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;speed_limit_by_tag&#34;: {&#34;freight&#34;: </span><span style=color:#0000cf;font-weight:700>20</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;track_ranges&#34;: [{&#34;track&#34;: &#34;${TRACK_SECTION}&#34;, &#34;begin&#34;: 0, &#34;end&#34;: 42, &#34;applicable_directions&#34;: </span><span style=color:#4e9a06>&#34;START_TO_STOP&#34;</span>}<span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=design-considerations>Design considerations</h2><h3 id=where-to-put-the-speed-limit-value>Where to put the speed limit value</h3><p>When a speed limit is announced by dynamic signaling, we may be in a position where speed limit value is duplicated:</p><ul><li>once in the signal itself</li><li>once in the speed limit</li></ul><p>There are multiple ways this issue can be dealt with:</p><h4 id=hahahugoshortcode146s0hbhb-mandatory-speed-limit-value-in-the-speed-section>✅
Mandatory speed limit value in the speed section</h4><p>Upsides:</p><ul><li>simpler to implement, works even without train reactions to signals nor additional API</li></ul><p>Downsides:</p><ul><li>more work on the side of users</li><li>room for inconsistencies between the speed limit announced by signaling, and the effective speed limit</li></ul><h4 id=hahahugoshortcode146s1hbhb-deduce-the-signal-constraint-from-the-speed-limit>❌
Deduce the signal constraint from the speed limit</h4><p>This option was not explored much, as it was deemed awkward
to deduce signal parameters from a speed limit value.</p><h4 id=hahahugoshortcode146s2hbhb-deduce-the-speed-limit-from-the-signal>❌
Deduce the speed limit from the signal</h4><p>Make the speed limit value optional, and deduce it from the signal itself.
Speed limits per tag also have to be deduced if missing.</p><p>Upsides:</p><ul><li>less work for users</li><li>lessens the likelyhood of configuration mismatches</li></ul><p>Downsides:</p><ul><li>not all signaling systems work well with this. It may be difficult to deduce the announced speed limit from a signal configuration, such as with TVM.</li><li>speed limits have to be deduced, which increases implementation complexity</li></ul><h3 id=how-to-link-announce-signals-and-speed-limit-area>How to link announce signals and speed limit area</h3><p>Speed limit announced by dynamic signaling often start being enforced at a specific location,
which is distinct from the signal which announces the speed limit.</p><p>To allow for correct train reactions to this kind of limits, a link between the announce signal
and the speed limit section has to be made at some point.</p><h4 id=hahahugoshortcode146s3hbhb-automated-matching-of-signals-and-speed-sections>❌
Automated matching of signals and speed sections</h4><p>Was not deemed realistic.</p><h4 id=hahahugoshortcode146s4hbhb-explicit-link-from-route-to-speed-limit-and-signals>❌
Explicit link from route to speed limit and signals</h4><p>Was deemed to be awkward, as signaling is currently built over interlocking.
Referencing signaling from interlocking creates a circular dependency between the two schemas.</p><h4 id=hahahugoshortcode146s5hbhb-explicit-link-from-speed-limit-to-signals>❌
Explicit link from speed limit to signals</h4><p>Add a list of <code>(route, signal)</code> tuples to speed sections.</p><p>Upside:</p><ul><li>a link with the signal can be made with creating the speed section</li></ul><p>Downside:</p><ul><li>Creates a dependency loop between speed limits and signaling. Part of the parsing of speed limit has to be deferred.</li><li>Signals parameters also have to be set per route, which is done in the signal. Having per-route options on both sides doubles the work.</li></ul><h4 id=hahahugoshortcode146s6hbhb-inlining-speed-limit-definitions-into-signals>❌
Inlining speed limit definitions into signals</h4><p>Introduces a new type of speed limit, which are announced by signals.
These speed limits are directly defined within signal definitions.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># ...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;conditional_parameters&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;on_route&#34;: </span><span style=color:#4e9a06>&#34;${ROUTE_ID}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;speed_section&#34;: </span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>&#34;speed_limit&#34;: </span><span style=color:#0000cf;font-weight:700>42</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>&#34;begin&#34;: {&#34;track&#34;: &#34;a&#34;, &#34;offset&#34;: </span><span style=color:#0000cf;font-weight:700>10</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>                </span><span style=color:#204a87;font-weight:700>&#34;end&#34;: {&#34;track&#34;: &#34;b&#34;, &#34;offset&#34;: </span><span style=color:#0000cf;font-weight:700>15</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;parameters&#34;: {&#34;rappel30&#34;: &#34;true&#34;, &#34;short_block&#34;: </span><span style=color:#4e9a06>&#34;true&#34;</span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># ...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Upsides:</p><ul><li>straightforward infrastructure edition experience for speed sections announced by a single signal</li></ul><p>Downsides:</p><ul><li>creates two separate kinds of speed limits:<ul><li>can cause code duplication</li><li>could make later changes of the data model trickier</li><li>it&rsquo;s unclear whether the criterion used to make this partition is appropriate</li></ul></li><li>speed sections created directly inside signals can only be announced by a single signal, which could be an issue for speed sections which apply to very large areas, and are announced by multiple signals (such as one for each direction)</li><li>the cost of reversing this decision could be fairly high</li></ul><h4 id=hahahugoshortcode146s7hbhb-explicit-link-from-signal-to-speed-section>✅
Explicit link from signal to speed section</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># ...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;conditional_parameters&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;on_route&#34;: </span><span style=color:#4e9a06>&#34;${ROUTE_ID}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;announced_speed_section&#34;: </span><span style=color:#4e9a06>&#34;${SPEED_SECTION_ID}&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;parameters&#34;: {&#34;rappel30&#34;: &#34;true&#34;, &#34;short_block&#34;: </span><span style=color:#4e9a06>&#34;true&#34;</span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># ...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Upsides:</p><ul><li>single unified way of declaring speed limits</li><li>very close to the current implementation</li></ul><p>Downsides:</p><ul><li>adds a level of indirection between the signal and the speed section</li><li>the edition front-end has to be smart enough to create / search speed sections from the signal edition menu</li></ul><h3 id=speed-limits-by-route>Speed limits by route</h3><p>Some speed limits only apply so some routes. This relationship needs to be modeled:</p><ol><li>speed limits could have a list of routes they apply on</li><li>routes could have a list of speed limits they enforce</li><li>the routes a speed limit apply on could be deduced from its announce signals, plus an explicit list of routes per speed section</li></ol><p>We took option 3.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-4af0b951e1d3073e37165f2ea66d0d5f>2.1.4 - Simulation lifecycle</h1><div class=lead>Tells the story of how signaling infrastructure is loaded and simulated on</div><h2 id=loading-signal-parameters>Loading Signal Parameters</h2><p>The first step of loading the signal is to characterize the signal in the signaling system.
This step produces an object that describes the signal.</p><p>During the loading of the signal:</p><ul><li>the signaling system corresponding to the provided name is identified</li><li>the signal properties and parameters are loaded and validated according to the signaling system spec</li><li>the signal&rsquo;s block and route delimiting properties are evaluated</li></ul><h2 id=loading-the-signal>Loading the Signal</h2><p>Once signal parameters are loaded, drivers can be loaded. For each driver:</p><ul><li>The driver implementation is identified from the <code>(signaling_system, next_signaling_system)</code> pair.</li><li>It is verified that the signaling system outgoing from the driver corresponds to the one of the signal.</li><li>It is verified that there is no existing driver for the incoming signaling system of the driver.</li></ul><p>This step produces a <code>Map&lt;SignalingSystem, SignalDriver></code>, where the signaling
system is the one incoming to the signal. It then becomes possible to construct
the loaded signal.</p><h2 id=constructing-blocks>Constructing Blocks</h2><ul><li>The framework creates blocks between signals following the routes present in the infrastructure, and the block properties of the signals.</li><li>Checks are made on the created block graph: it must always be possible to choose a block for each signal and each state of the infrastructure.</li></ul><h2 id=block-validation>Block validation</h2><p>The validation process helps to report invalid configurations in terms of signaling and blockage. The validation cases we want to support are:</p><ul><li>The signaling system may want to validate, knowing if the block starts / ends on a buffer:<ul><li>the length of the block</li><li>the spacing between the block signals, first signal excluded</li></ul></li><li>Each signal in the block may have specific information if it is a transition signal. Therefore, all signal drivers participate in the validation.</li></ul><p>In practice, there are two separate mechanisms to address these two needs:</p><ul><li>The <strong>signaling system module</strong> is responsible for validating signaling <strong>within</strong> blocks.</li><li><strong>Signal drivers</strong> take care of validating transitions <strong>between</strong> blocks.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>extern</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>report_warning</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>/* TODO */</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>extern</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>report_error</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>/* TODO */</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Block</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>startsAtBufferStop</span>: <span style=color:#204a87;font-weight:700>bool</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>stopsAtBufferStop</span>: <span style=color:#204a87;font-weight:700>bool</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>signalTypes</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SignalingSystemId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>signalSettings</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SignalSettings</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>signalPositions</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Distance</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>length</span>: <span style=color:#000>Distance</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/// Runs in the signaling system module
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>check_block</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>block</span>: <span style=color:#000>Block</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/// Runs in the signal driver module
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>check_signal</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>signal</span>: <span style=color:#000>SignalSettings</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>block</span>: <span style=color:#000>Block</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// The partial block downstream of the signal - no signal can see backward
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=signal-lifecycle>Signal lifecycle</h2><p>Before a train startup:</p><ul><li>the path a of the train can be expressed is given, both as routes and blocks</li><li>the signal queue a train will encounter is established</li></ul><p>During the simulation:</p><ul><li>along a train movement, the track occupation before it are synthesized</li><li>when a train observes a signal, its state is evaluated</li></ul><h2 id=signal-state-evaluation>Signal state evaluation</h2><p>Signals are modeled as an evaluation function, taking a view of the world and returning the signal state</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>ZoneStatus</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#8f5902;font-style:italic>/** The zone is clear to be used by the train */</span>
</span></span><span style=display:flex><span>   <span style=color:#000>CLEAR</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>   <span style=color:#8f5902;font-style:italic>/** The zone is occupied by another train, but otherwise clear to use */</span>
</span></span><span style=display:flex><span>   <span style=color:#000>OCCUPIED</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>   <span style=color:#8f5902;font-style:italic>/** The zone is incompatible. There may be another train as well */</span>
</span></span><span style=display:flex><span>   <span style=color:#000>INCOMPATIBLE</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>MAView</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** Combined status of the zones protected by the current signal */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>protectedZoneStatus</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>ZoneStatus</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>nextSignalState</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>SignalState</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>nextSignalSettings</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>SignalSettings</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>fun</span> <span style=color:#000>signal</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>maView</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>MAView</span><span style=color:#000;font-weight:700>?):</span> <span style=color:#000>SignalState</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>The view should allow access to the following data:</p><ul><li>a synthetized view of zones downstream until the end of the train&rsquo;s MA</li><li>the block chain</li><li>the state of downstream signals which belong to the current block chain</li></ul><h2 id=signaling-view-path>Signaling view path</h2><p>The path along which the MAView and SpeedLimitView live is best expressed using blocks:</p><ul><li>blocks can be added to extend the view along the path of a train</li><li>the view can be reduced by removing blocks, as the train passes by signals</li></ul><h2 id=simulation-outside-the-train-path>Simulation outside the train path</h2><p>Everything mentionned so far was designed to simulate signals between a train the
end of its movement authority, as all others signals have no influence over the behavior
of trains (they cannot be seen, or are disregarded by drivers).</p><p>Nevertheless, one may want to simulate and display the state of all signals at a given point in time,
regardless of which signals are in use.</p><p>Simulation rules are as follows:</p><ul><li>if a signal starts blocks which have differing paths, it is simulated as if it were at the end of a route</li><li>if a signal starts blocks which all start the same path, it is simulated in the same view as the next signals in this path</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-6802b8721cfb6034a773e0771f4b7493>2.2 - Conflict detection</h1><div class=lead>Detect unrealistic timetables</div><div class="pageinfo pageinfo-warning"><p>This document is a work in progress</p></div><p>Conflict detection is the process of looking for timetable conflicts.
A timetable conflict is any predictable condition which disrupts planned operations.
Planned operations can be disrupted if a train is slowed down, prevented from proceeding, or delayed.</p><p>One of the core features of OSRD is the ability to automatically detect some conflicts:</p><ul><li><strong>spacing conflicts</strong>: insufficient spacing between trains sharing the same path</li><li><strong>routing conflicts</strong>: insufficient spacing between trains with intersecting paths</li></ul><p>Some other kinds of conflicts may be detected <em>later on</em>:</p><ul><li><strong>maintenance conflicts</strong>: planned maintenance disrupts the path of a train</li><li><strong>power delivery conflicts</strong>: combined power delivery requirements exceeds capacity</li></ul><p>Conflict detection relies on interlocking and signaling modeling and simulation to:</p><ol><li>figure out what each actor requires to perform its duty undisturbed</li><li>detect conflicting requirements</li></ol><h2 id=design-constraints>Design constraints</h2><p>The primary design goals are as follows:</p><ul><li>enable threading new train paths into an existing timetable (see STDCM)</li><li>produce conflicts which can be linked back to a root cause</li><li>operate in way that can be visualized and interpreted</li><li>scale to real world timetables: millions of yearly trains, tens of thousands of daily trains</li></ul><p>In addition to these goals, the following constraints apply:</p><ul><li>it must be possible to thread new train paths into timetables with existing conflicts</li><li>it must not cause false-negatives: if no conflicts are detected, a multi-train simulation of the same timetable must not yield any slowdowns</li><li>it cannot rely on data we do not have</li><li>it has to enable later support of mobile block systems</li><li>it has to rely on existing signaling and interlocking simulation</li><li>it has to enable detecting conflicts regardless of the signaling system in use</li><li>it has to support transitions between signaling systems</li><li>it has to support conflicts between different signaling systems</li></ul><h2 id=conflict-modeling>Conflict modeling</h2><p><strong>Actors</strong> are objects which cause resources to be used:</p><ul><li><strong>train paths</strong> (or someone / something on the behalf of the train)</li><li><strong>maintenance work</strong></li></ul><p>Actors need <strong>resources</strong> to be available to proceed, such as:</p><ul><li><strong>zones</strong>, which have one state per way to traverse it</li><li><strong>switches</strong>, which have one state per position</li><li><strong>station platforms</strong>, which could be used to prevent two large trains from occupying both sides of a tiny platform</li></ul><p>Actor emit <strong>resource requirements</strong>, which:</p><ul><li>describe the need of an actor for a resource, for a given time span</li><li>describe what the resource is needed for</li><li>detail how the resource is used, such as switch position, zone entry and exit</li></ul><p>Resource requirements can turn out to be either <strong>satisfied</strong>
or <strong>conflicting</strong> with other requirements, depending on compatibility rules.</p><p><strong>Compatibility rules differ by requirement purpose and resource type</strong>. For example:</p><ul><li>spacing requirements are exclusive: simultaneous requirements for the same resource are conflicting</li><li>zone and switch requirements are shareable: simultaneous requirements are satisfied if the resource configuration is identical</li></ul><p><strong>For conflict detection to work, resource requirements have to be at least as extensive as what&rsquo;s required to guarantee that a train path will not be disturbed.</strong></p><h2 id=routing-conflicts>Routing conflicts</h2><h3 id=context>Context</h3><p>For trains to proceed safely along their planned path:</p><ul><li>switches have to be moved in the appropriate position</li><li>level crossings have to activate</li><li>risks of collision with other trains have to be mitigated</li></ul><p>In practice, the path of trains is partitioned into routes, which when set, ensure a train can safely follow the route.</p><p>Routes have the following lifestyle:</p><ul><li>As a train approaches the start of one of its routes, it is <strong>called</strong> by an operator. If all resources required to safely use the route are available, switches and level crossings start to move. If a resources is not available, e.g. because another train has reserved a section of track, this process is delayed until all conditions are met.</li><li>Once all resources are configured and reserved, the route is <strong>set</strong> and ready to be followed. Before that point, the entry of the route was protected by signaling, which prevented the train from moving past the entry point.</li><li>As the train moves along the route, it is <strong>destroyed</strong>. When the tail of the trail releases key detectors along the route, resources before this detector are released, and can this be reserved by other routes.</li></ul><p>For a train to proceed through a route unimpeded, the following things have to happen:</p><ul><li>The route has to be set before the train arrives, and before it is slowed down by signaling.</li><li>The route has to be called, so that is it set in time.</li><li>All resources required for the route to start setting at call time have to be available.</li></ul><h3 id=generating-requirements>Generating requirements</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>RouteRequirement</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>route</span>: <span style=color:#000>RouteId</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>set_deadline</span>: <span style=color:#000>Time</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>zone_requirements</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>RouteZoneRequirement</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>RouteZoneRequirement</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>zone</span>: <span style=color:#000>ZoneId</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>entry_det</span>: <span style=color:#000>DirDetectorId</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>exit_det</span>: <span style=color:#000>DirDetectorId</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>release_time</span>: <span style=color:#000>Time</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>switches</span>: <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SwitchId</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SwitchConfigId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Routing requirements are generated by the following algorithm:</p><ul><li>Compute the set deadline using signaling simulation. The set deadline is the point in time at which the train would be slowed down if the route were not set.</li><li>For each zone in each route, simulate when it would be released, and thus not required anymore.</li></ul><div class="pageinfo pageinfo-info"><p>Route overlaps are not yet supported.</p></div><h3 id=requirement-compatibility-rules>Requirement compatibility rules</h3><p>Requirement compatibility is evaluated for all <code>RouteZoneRequirement</code>s, grouped by zone. Requirements A and B, ordered such that <code>A.set_deadline &lt;= B.set_deadline</code>, are compatible if and only if either:</p><ul><li>their active time span does not overlap, such that <code>A.release_time &lt;= (B.set_deadline - activation_time)</code>, where the activation time is the delay required to reconfigure from <code>A.switches</code> to <code>B.switches</code>.</li><li><code>(A.entry_det, A.exit_det, A.switches) == (B.entry_det, B.exit_det, B.switches)</code></li></ul><h2 id=spacing-conflicts>Spacing conflicts</h2><h3 id=context-1>Context</h3><p>Even if interlocking mitigates some of the risks associated with operating trains, a major one is left out: head to tail collisions, caused by insufficient spacing.</p><p>This responsibility is handled by signaling, which conveys both interlocking and spacing constraints.</p><p>Signaling helps trains slow down until the end of their movement authority, which is either:</p><ul><li>behind the tail of the next train</li><li>at the end of the last route set for this train</li></ul><p><strong>Spacing requirements are emitted for zones which if occupied, would cause a slowdown, and zones occupied by the train</strong></p><h3 id=generating-requirements-1>Generating requirements</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>SpacingRequirement</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>zone</span>: <span style=color:#000>ZoneId</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>begin_time</span>: <span style=color:#000>Time</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>end_time</span>: <span style=color:#000>Time</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Every time the driver sees a signal, generate updated spacing requirements by calculating which zones, if occupied, would trigger a slowdown:</p><ul><li>start by assuming the zone just after the head of the train is occupied</li><li>until the train is not slowed down, move the occupied section one zone further away from the train</li></ul><h3 id=requirement-compatibility-rules-1>Requirement compatibility rules</h3><p>Requirement compatibility is evaluated for all <code>SpacingRequirement</code>s, grouped by zone.</p><p>Requirements A and B are compatible if and only if their <code>[begin_time, end_time]</code> ranges do not overlap.</p><h2 id=incremental-requirement-generation>Incremental requirement generation</h2><h3 id=routing-requirements>Routing requirements</h3><pre class=mermaid>sequenceDiagram
    participant client as Client
    participant gen as Routing resource generator
    client -&gt;&gt; gen: initial path &#43; train movement
    loop
        gen -&gt;&gt; client: prefix path extension needed
        client -&gt;&gt; gen: extra prefix path &#43; train movement
    end
    gen -&gt;&gt; client: resource requirements</pre><p>After an initial path is given, the requirement generator can ask for more <strong>prefix</strong> path (before the start of the route). The client responds with:</p><ul><li>the extra prefix path</li><li>the movement of the train over time on the given prefix path</li></ul><p>If the initial path has multiple routes, the last route is the one resource requirements are emitted for.</p><h3 id=spacing-requirements>Spacing requirements</h3><pre class=mermaid>sequenceDiagram
    participant client as Client
    participant gen as Spacing resource generator
    client -&gt;&gt; gen: initial path &#43; train movement
    loop
        gen -&gt;&gt; client: postfix path extension needed
        client -&gt;&gt; gen: extra postfix path
    end
    gen -&gt;&gt; client: resource requirements</pre><p>After an initial path is given, the requirement generator can ask for more <strong>postfix</strong> path (before the start of the route).</p><h2 id=visualizing-requirements>Visualizing requirements</h2><script type=application/javascript src=mkt.js></script><p><object style=width:100% onload=mkt_hydrate(this.contentDocument.rootElement) type=image/svg+xml data=requirements-diagram.svg></object></p><p><a href=./requirements-diagram.html>Full-page requirements diagram</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-5c302d0351a984c31f1516d7661b618f>2.3 - Search for last-minute train slots (STDCM)</h1><p>OSRD can be used to find a slot for a train in an already established
timetable, without causing conflicts with other trains.</p><p>The acronym STDCM (Short Term Digital Capacity Management) is used
to describe this concept in general.</p></div><div class=td-content><h1 id=pg-947b82c2b20e8d312398ef2a5634cd3c>2.3.1 - Business context</h1><p>Some definitions:</p><h3 id=capacity>Capacity</h3><p><strong>Capacity</strong>, in this context, is the ability to
reserve infrastructure elements to allow the passage of a train.</p><p>Capacity is expressed in both space and time:
the reservation of an element can block a specific zone
that becomes inaccessible to other trains, and this reservation
lasts for a given time interval.</p><p>It can be displayed
on a chart, with the time on the horizontal axis
and the distance traveled on the vertical axis.</p><p><img src=space_time_chart.png alt="Space-time chart"></p><blockquote><p>Example of a space-time chart displaying the passage of a train.</p><p>The colors here represent aspects of the signals, but
display a consumption of the capacity as well:
when these blocks overlap for two trains, they conflict.</p></blockquote><p>There is a <strong>conflict</strong> between two trains when they reserve
the same object at the same time, in incompatible configurations.</p><p><img src=conflict.png alt="Space-time chart with conflict"></p><blockquote><p>Example of a space-time graph with a conflict: the second train
is faster than the first one, they are in conflict at the end
of the path, when the rectangles overlap.</p><p>When simulating this timetable, the second train would be
slowed down by the yellow signals, caused by the
presence of the first train.</p></blockquote><h3 id=train-slots>Train slots</h3><p>A <strong>train slot</strong> corresponds to a capacity reservation
for the passage of a train. It is fixed in space and time:
the departure time and the path taken are known.
On the space-time charts in this page, a train slot corresponds
to the set of blocks displayed for a train.</p><blockquote><p>Note: in English-speaking countries, these are often simply called &ldquo;train paths&rdquo;.
But in this context, this name would be ambiguous with the
physical path taken by the train.</p></blockquote><p>The usual procedure is for the infrastructure manager
(e.g. SNCF Réseau) to offers train slots for sale to
railway companies (e.g. SNCF Voyageurs).</p><p>At a given date before the scheduled day of operation,
all the train paths are allocated. But <strong>there may be
enough capacity to fit more trains</strong>. Trains can fit between
scheduled slots,
when they are sufficiently far apart or have not found a buyer.</p><p>The remaining capacity after the allocation of train paths is called
<strong>residual capacity</strong>. This section explains how OSRD looks
for train slots in this residual capacity.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f0e665bd09334507f4e0f2438621834b>2.3.2 - Train slot search module</h1><p>This module handles the search for solutions.</p><p>To reduce the problem to its simplest form and for easy and efficient
testing, inputs and outputs are strongly simplified and abstracted.</p><p>To summarize its behavior:
the solution space is described as a graph that encodes locations,
time, and speed. A pathfinding is run on this graph to find a solution.</p><p>This graph could, in a way, be seen as a decision tree,
but different paths can lead to the same node.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-397a7d0b773c457d82f0a20b928d52b4>2.3.2.1 - Infrastructure exploration</h1><p>The first thing we need to define is <em>how we move through the infrastructure</em>,
without dealing with conflicts yet.</p><p>We need a way to define and enumerate the different possible paths and
explore the infrastructure graph, with several constraints:</p><ol><li>The path must be compatible with the given rolling stock
(loading gauge / electrification / signaling system)</li><li>At any point, we need to access path properties from its start up to the
considered point. This includes block and route lists.</li><li>We sometimes need to know where the train will go <em>after</em> the
point currently being evaluated, for proper conflict detection</li></ol><p>To do this, we have defined the class <code>InfraExplorer</code>. It uses blocks
(sections from signal to signal) as a main subdivision.
It has 3 sections: the current block, predecessors, and a &ldquo;lookahead&rdquo;.</p><p><img src=infra_explorer.svg alt="InfraExplorer structure"></p><p>In this example, the green arrows are the predecessor blocks.
What happens there is considered to be immutable.</p><p>The red arrow is the current block. This is where we run
train and signaling simulations, and where we deal with conflicts.</p><p>The blue arrows are part of the lookahead. This section hasn&rsquo;t
been simulated yet, its only purpose is to know in advance
where the train will go next. In this example, it would tell us
that the bottom right signal can be ignored entirely.
The top path is the path being currently evaluated.
<strong>The bottom section of the path will be evaluated in a different
and already instanciated <code>InfraExplorer</code></strong></p><p>The <code>InfraExplorer</code> is manipulated with two main functions
(the accessors have been removed here for clarity):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span><span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>InfraExplorer</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * Clone the current object and extend the lookahead by one route, for each route starting at
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * the current end of the lookahead section. The current instance is not modified.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fun</span> <span style=color:#000>cloneAndExtendLookahead</span><span style=color:#000;font-weight:700>():</span> <span style=color:#000>Collection</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#000>InfraExplorer</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * Move the current block by one, following the lookahead section. Can only be called when the
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     * lookahead isn&#39;t empty.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fun</span> <span style=color:#000>moveForward</span><span style=color:#000;font-weight:700>():</span> <span style=color:#000>InfraExplorer</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p><code>cloneAndExtendLookahead()</code> is the method that actually enumerates the
different paths, returning clones for each possibility.
It&rsquo;s called when we need a more precise lookahead to properly identify
conflicts, or when it&rsquo;s empty and we need to move forward.</p><p>A variation of this class can also keep track of the train simulation
and time information (called <code>InfraExplorerWithEnvelope</code>).
This is the version that is actually used to explore the infrastructure.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-47b91c7f9ce15fcf0e7131cd9fc9dc37>2.3.2.2 - Conflict detection</h1><p>Once we know what paths we can use, we need to know when they
can actually be used.</p><p>The <a href=https://osrd.fr/en/docs/reference/design-docs/conflict-detection/ title=documentation>documentation</a>
of the conflict detection module explains how it&rsquo;s done internally.
Generally speaking, a train is in conflict when it has to slow down
because of a signal. In our case, that means the solution would not
be valid, we need to arrive later (or earlier) to see the signal
when it&rsquo;s not restrictive anymore.</p><p>The complex part is that we need to do the conflict detection <em>incrementally</em>
Which means that:</p><ol><li>When running simulations up to t=x, we need to know all of the conflicts
that happen before x, <em>even if they&rsquo;re indirectly caused by a
signal seen at t > x</em> down the path.</li><li>We need to know the conflicts and resource uses right as they start
even if their end time can&rsquo;t be defined yet.</li></ol><p>For that to be possible, we need to know where the train will go
<em>after</em> the section that is being simulated (see
<a href=https://osrd.fr/en/docs/reference/design-docs/stdcm/pathfinding_module/infrastructure_exploration/ title="infra exploration">infra exploration</a>:
we need some elements in the lookahead section).</p><p>To handle it, the conflict detection module
returns an error when more lookahead is required. When it happens
we extend it by cloning the infra explorer objets.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-12bb8a99ebcc826ad37983a300610aed>2.3.2.3 - Encoding the solution space</h1><h4 id=general-principle>General principle</h4><p>The problem is still a pathfinding problem in a given graph.
Once the problem is encoded as a graph search, it is possible to reuse
our existing tools for this purpose.</p><p>We consider the <em>product graph</em> of position, time, and speed.
This means that every graph element contains these 3 variables
(among other things)</p><p>Every graph edge is computed using
<a href=https://osrd.fr/en/docs/explanation/running_time_calculation/ title="running-time calculation">running-time calculation</a>
to get speed and positions as functions of time.</p><h4 id=graphical-representation>Graphical representation</h4><p>Space is encoded with a graph that contains the physical infrastructure.</p><p><img src=routes_time_1.png alt="product graph (1/3)"></p><p>It is then &ldquo;duplicated&rdquo; at different times.</p><p><img src=routes_time_2.png alt="product graph (2/3)"></p><p>The nodes are then linked together in a way that reflects travel time.</p><p><img src=routes_time_3.png alt="product graph (3/3)"></p><h4 id=notes>Notes</h4><ul><li>The graph is constructed on the fly as it is explored.</li><li>It is <em>discretized</em> in time, to evaluate which nodes have already
been visited. We keep full accuracy of time values, but two nodes
at the same place and close times are considered identical.</li><li>Every edge is computed with a running time computation.</li><li>Speed isn&rsquo;t discretized or considered to check visited nodes,
it&rsquo;s only used to compute time.</li><li>By default, the train always goes as fast as it can
(while still following standard allowances).
It only slows down when necessary.</li></ul><h4 id=example>Example</h4><p>For example, with the following infrastructure, using the track graph:
<img src=example_infra.svg alt="Example infra"></p><p>Exploring the solution graph can give the following result:
<img src=example_graph.svg alt="Représentation du graphe"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-74094845d6db946e31db476ef1c506a2>2.3.2.4 - Discontinuities and backtracking</h1><h4 id=the-discontinuity-problem>The discontinuity problem</h4><p>When a new graph edge is visited, a simulation is run to evaluate
its speed. But it is not possible to see beyond the current edge.
This makes it difficult to compute braking curves, because
they can span over several edges.</p><p><img src=discontinuity.png alt=Discontinuity></p><blockquote><p>This example illustrates the problem: by default
the first edge is explored by going at maximum speed.
The destination is only visible once the second edge is visited,
which doesn&rsquo;t leave enough distance to stop.</p></blockquote><h4 id=solution--backtracking>Solution : backtracking</h4><p>To solve this problem, when an edge is generated with a
discontinuity in the speed envelopes, the algorithm goes back
over the previous edges to create new ones that include the
decelerations.</p><p>To give a simplified example, on a path of 4 edges
where the train can accelerate or decelerate by 10km/h per edge:</p><p><img src=backtracking_1.png alt="Discontinuity (edge version, 1/2)"></p><p>For the train to stop at the end of route 4, it must be at most
at 10km/h at the end of edge 3. A new edge is then created on
edge 3, which ends at 10km/h. A deceleration is computed
backwards from the end of the edge back to the start,
until the original curve is met (or the start of the edge).</p><p>In this example, the discontinuity has only been moved to the
transition between edges 2 and 3. The process is then repeated
on edge 2, which gives the following result:</p><p><img src=backtracking_2.png alt="Discontinuity (edge version, 2/2)"></p><p>Old edges are still present in the graph as they can lead to other solutions.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-615ce0cf6c404cd85469e6285e5feb90>2.3.2.5 - Conflict avoidance</h1><p>While exploring the graph, it is possible to end up in locations that would
generate conflicts. They can be avoided by adding delay.</p><h4 id=shifting-the-departure-time>Shifting the departure time</h4><p>The departure time is defined as an interval in the module parameters:
the train can leave at a given time, or up to <code>x</code> seconds later.
Whenever possible, delay should be added by shifting the departure time.</p><blockquote><p>for example : a train can leave between 10:00 et 11:00. Leaving
at 10:00 would cause a conflict, the train actually needs to enter the
destination station 15 minutes later. Making the train leave at
10:15 solves the problem.</p></blockquote><p>In OSRD, this feature is handled by keeping track, for every edge,
of the maximum duration by which we can delay the departure time.
As long as this value is enough, conflicts are avoided this way.</p><p>This time shift is a value stored in every edge of the path.
Once a path is found, the value is summed over the whole path.
This is added to the departure time.</p><blockquote><p>For example :</p><ul><li>a train leaves between 10:00 and 11:00. The initial maximum
time shift is 1:00.</li><li>At some point, an edge becomes unavailable 20 minutes after the
train passage. The value is now at 20 for any edge accessed from here.</li><li>The departure time is then delayed by 5 minutes to avoid a conflict.
The maximum time shift value is now at 15 minutes.</li><li>This process is applied until the destination is found,
or until no more delay can be added this way.</li></ul></blockquote><h4 id=engineering-allowances>Engineering allowances</h4><p>Once the maximum delay is at 0, the delay needs to be added
between two points of the path.</p><p><img src=engineering_allowance.png alt="Engineering allowances (1/2)"></p><p>The idea is the same as the one used to fix speed discontinuities:
new edges are created, replacing the previous ones.
The new edges have an engineering allowance, to add the delay where
it is possible.</p><p><img src=engineering_allowance_edges.png alt="Engineering allowances (2/2)"></p><p>computing an
<a href=https://osrd.fr/en/docs/explanation/running_time_calculation/allowances/ title=allowances>engineering allowance</a>
is a feature of the running-time
calculation module. It adds a given delay between two points of
a path, without affecting the speeds on the rest of the path.</p><h2 id=post-processing>Post-processing</h2><p>We <strong>used to</strong> compute the engineering allowances during the graph
exploration, but that process was far too expensive. We used to
run binary searches on full simulations, which would sometimes
go back for a long distance in the path.</p><p>What we <em>actually need</em> is to know whether an engineering allowance
is <em>possible</em> without causing any conflict. We can use heuristics
here, as long as we&rsquo;re on the conservative side: we can&rsquo;t
say that it&rsquo;s possible if it isn&rsquo;t, but missing solutions with
extremely tight allowances isn&rsquo;t a bad thing in our use cases.</p><p>But this change means that, once the solution is found, we can&rsquo;t
simply concatenate the simulation results. We need to run
a full simulation, with actual engineering allowances,
that avoid any conflict. This step has been merged
with the one described on the
<a href=https://osrd.fr/en/docs/reference/design-docs/stdcm/pathfinding_module/standard_allowance/ title="standard allowance">standard allowance</a>
page, which is now run even when no standard allowance
have been set.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ed97b39b0c3816e4f1073f363957a3e3>2.3.2.6 - Standard allowance</h1><p>The STDCM module must be usable with
<a href=https://osrd.fr/en/docs/explanation/running_time_calculation/allowances/ title="marge de régularité">standard allowances</a>.
The user can set an allowance value, expressed either as a function of
the running time or the travelled distance. This time must be added to the
running time, so that it arrives later compared to its fastest possible
running time.</p><blockquote><p>For example: the user can set a margin of 5 minutes per 100km.
On a 42km long path that would take 10 minutes at best,
the train should arrive 12 minutes and 6 seconds after leaving.</p></blockquote><p>This can cause problems to detect conflicts, as an allowance would move
the end of the train slot to a later time.
The allowance must be considered when we compute conflicts as
the graph is explored.</p><p>The allowance must also follow the <a href=/pdf/MARECO.pdf>MARECO</a> model:
the extra time isn&rsquo;t added evenly over the whole path,
it is computed in a way that requires knowing the whole path.
This is done to optimize the energy used by the train.</p><h4 id=during-the-exploration>During the exploration</h4><p>The main implication of the standard allowance is during
the graph exploration, when we identify conflicts.
It means that we need to scale down the speeds. We still need
to compute the maximum speed simulations (as they define
the extra time), but when identifying at which time we see
a given signal, all speeds and times are scaled.</p><p>This process <em>is not exact</em>. It doesn&rsquo;t properly account for
the way the allowance is applied (especially for MARECO).
But at this point we don&rsquo;t need exact times, we just need
to identify whether a solution would exist at this approximate time.</p><div class="alert alert-info" role=alert>This slightly inexact process may seem like a problem, but in
reality (for SNCF) standard allowances actually have some
tolerance between arbitrary points on the path. e.g. if
we should aim for 5 minutes per 100km, any value between
3 and 7 would be valid. The actual tolerance is not something
we can or want to encode as they&rsquo;re too many specificities,
but it means we can be off by a few seconds.</div><h4 id=post-processing>Post-processing</h4><p>The process to find the actual train simulation is as follows:</p><ol><li>We define points at which the time is fixed, initialized
at first with the time of each train stop. This is an input
of the simulation and indirectly calls the standard allowance.</li><li>If there are conflict, we try to remove the first one.</li><li>We add a fixed time point <em>at the location where that conflict
happened</em>. We use the time considered during the exploration
(with linear scaling) as reference time.</li><li>This process is repeated iteratively until no conflict is found.</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-460b1be4e2f2584372a451ceef833731>2.3.2.7 - Implementation details</h1><p>This page is about implementation details.
It isn&rsquo;t necessary to understand general principles,
but it helps before reading the code.</p><h4 id=stdcmedgebuilder>STDCMEdgeBuilder</h4><p>This refers to
<a href=https://github.com/osrd-project/osrd/blob/dev/core/src/main/java/fr/sncf/osrd/stdcm/graph/STDCMEdgeBuilder.java>this class</a>
in the project.</p><p>This class is used to make it easier to create instances of
<code>STDCMEdge</code>, the graph edges. Those contain many attributes,
most of which can be determined from the context (e.g. the
previous node).
The <code>STDCMEdgeBuilder</code> class makes some parameters optional
and automatically computes others.</p><p>Once instantiated and parametrized, an <code>STDCMEdgeBuilder</code> has two methods:</p><ul><li><p><code>Collection&lt;STDCMEdge> makeAllEdges()</code> can be used to create all
the possible edges in the given context for a given route.
If there are several &ldquo;openings&rdquo; between occupancy blocks, one edge
is instantiated for each opening. Every conflict, their avoidance,
and their related attributes are handled here.</p></li><li><p><code>STDCMEdge findEdgeSameNextOccupancy(double timeNextOccupancy)</code>:
This method is used to get the specific edges that uses a certain
opening (when it exists), identified here with the time of the next
occupancy block. It is called whenever a new edge must be re-created
to replace an old one. It calls the previous method.</p></li></ul><h3 id=pathfinding>Pathfinding</h3><p>The methods mentioned here are defined in
<a href=https://github.com/osrd-project/osrd/blob/dev/core/src/main/java/fr/sncf/osrd/stdcm/graph/STDCMPathfinding.java>this class</a>.</p><h4 id=cost-function>Cost function</h4><p>The function used to define pathfinding cost sets which path
is used over another. The result is always the one that minimizes
this cost (as long as the heuristic is admissible).</p><p>Here, two parameters are used: total run time and departure time.
The latter has a very small weight compared to the former,
so that the fastest path is found. More details
are explained in the documentation of those methods.</p><h4 id=heuristics>Heuristics</h4><p>The algorithm used to find a path is an A*, with a heuristic based
on geographical coordinates.</p><p>However, the coordinates of generated infrastructures are arbitrary
and don&rsquo;t reflect the track distance. It means that,
for the generated infrastructures, the path may not always be the
shortest one.</p><p>It would be possible to use this heuristic to determine whether
the current node can lead to a path that doesn&rsquo;t take
longer than the maximum allowed total run time. But for the same
reason, adding this feature would break any STDCM test on generated
infras. More details in
<a href=https://github.com/osrd-project/osrd/issues/2818>this issue</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-4d0f19ea5ea7b131826269e88f6b283d>2.4 - Timetable v2</h1><div class=lead>Describes evolutions to the new <strong>timetable</strong> and <strong>train schedule</strong> models</div><p><img src=timetable.svg alt=Test></p><h2 id=design-decisions>Design decisions</h2><p>Some major changes were made between our first version of the timetable and the new one:</p><ul><li>Isolate the timetable table. It can be used in a scenario or in other contexts</li><li>Have a soft reference from train schedule to rolling stock (to be able to create a train schedule with unknown rolling stock)</li><li>Consider path and simulation output as cache (that don&rsquo;t require to be stored in DB)</li><li>We can compute pathfinding without having to store data</li><li>All input needed to compute a path is stored in the train schedule (we can recompute it if needed)</li><li>All input needed to run a simulation is stored in the train schedule (we can recompute it if needed)</li></ul><h1 id=train-schedule-v2>Train schedule v2</h1><h2 id=requirements>Requirements</h2><ul><li><code>front</code>: easy to keep consistent during edition</li><li><code>front</code>: intermediate invalid states than can be reached during edition have to be encodable</li><li><code>front</code>: when deleting a waypoint that is referenced by margins, the position of the deleted waypoint within the path must be preserved until the situation is resolved</li><li><code>import</code>: path waypoint locations can be specified using UIC operational point codes</li><li><code>import</code>: support fixed scheduled arrival times at stops and arbitrary points</li><li><code>import</code> <code>edition</code>: train schedules must be self-contained: they cannot be described using the result of pathfinding or simulations</li></ul><h2 id=design-decisions-1>Design decisions</h2><h3 id=path-waypoints-have-an-identity>Path waypoints have an identity</h3><p>At some point in the design process, the question was raised of whether to reference location of stops and margin transitions by name, or by value. That is, should stops hold the index of the waypoint where the stop occurs, or a description of the location where the stop occurs?</p><p>It was decided to add identifiers to path waypoints, and to reference those identifiers where referencing a path location is needed. This has multiple upsides:</p><ul><li>you can&rsquo;t reference a location outside of the path</li><li>when changing a waypoint&rsquo;s location, for example from one station&rsquo;s platform to another, no additional maintenant work is needed to keep the path consistent</li><li>if a path goes to the same place multiple times, the identifier reference makes it clear which path location is referenced</li><li>it makes keeping data consistent while editing easier, as all locations are kept in a single place</li></ul><h3 id=invalid-train-schedules-and-soft-deletes>Invalid train schedules and soft deletes</h3><p>If an user deletes a waypoint, what happens? Is it the front-end&rsquo;s responsibility to only save valid schedules, or can invalid schedules be represented in the data model? We decided that it wasn&rsquo;t just the front-end&rsquo;s responsibility, as we want to be able to model inconsistent states, until the user comes back to fix it.</p><p>One key observation was that don&rsquo;t want to loose the ability to locate within the path waypoints that were deleted, until all references are gone. How is the front-end supposed to display margin bounds or stops for a waypoint that&rsquo;s gone, if it&rsquo;s not there anymore?</p><p>We thus decided to add a <code>deleted</code> soft-delete flag to waypoints. When this flag is set, the back-end run simulations on the path, but still allows saving it. Once all references to a deleted waypoint are gone, it can be removed from the path. The backend can deny train schedules with stale deleted waypoints.</p><h3 id=separating-path-and-stops>Separating path and stops</h3><p>This decision was hard to make, as there are little factors influencing this decision. Two observations led us to this decision:</p><ul><li>when deleting a waypoint, the end user may want to preserve the associated stop. Making the separation clear in the data model helps with implementing this behavior correctly, if deemed relevant</li><li>bundling stops into the path makes it harder to describe what fields <code>path</code> waypoints should have, and what should have a separate object and reference. It was decided that keeping <code>path</code> a simple list of <code>Location</code>, with no strings attached, made things a little clearer.</li></ul><h3 id=no-more-engineering-margins>No more engineering margins?</h3><p>In the legacy model, we had engineering margins. These margins had the property of being able to overlap. It was also possible to choose the distribution algorithm for each margin individually.</p><p>We asked users to comment on the difference and the usefulness of retaining these margins with scheduled points. The answer is that there is no fundamental difference, and that the additional flexibility offered by engineering margins makes no pratical sense (overlap and choice of distribution&mldr;).</p><h3 id=arrival-times-are-durations-since-departure-time>Arrival times are durations since departure time</h3><ul><li>this allows shifting the departure time without having to change arrival times</li><li>we don&rsquo;t have to parse dates and compute date differences within a single trip</li></ul><p>We also discussed whether to use seconds or ISO 8601 durations. In the end, ISO 8601 was choosen, despite the simplicity of seconds:</p><ul><li>it preserves the user&rsquo;s choice unit for specifying duration</li><li>it interfaces nicely with the ISO 8601 departure time</li><li>it does not suffer from potential integer-float serialization related precision loss</li></ul><h3 id=invalid-and-outdated-train-schedules>Invalid and outdated train schedules</h3><p>Reasons for a train schedule to be <strong>invalid</strong>:</p><ul><li>Inconsitent train schedule (contains deleted waypoint)</li><li>Rolling stock not found</li><li>Path waypoint not found</li><li>The path cannot be found</li></ul><p>Reasons for a train schedule to be <strong>outdated</strong>:</p><ul><li>The train path changed</li><li>The train running time changed</li></ul><p>What we can do about outdated trains:</p><ol><li>Nothing, they&rsquo;re updated without notification</li><li>We can notify the user that a train schedule is outdated:<ul><li>Nothing can be done except acknoledge the change</li><li>We can not check what changed between the old and new version</li><li>We can not know the cause of this change (RS, Infra, Algorithms&mldr;)</li></ul></li></ol><p>Note: The outdated status is a nice to have feature (it won&rsquo;t be implemented right now).</p><h2 id=creation-fields>Creation fields</h2><p>These fields are required at creation time, but cannot be changed afterwards.
They are returned when the train schedule is queried.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>timetable_id</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>42</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=modifiable-fields>Modifiable fields</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>train_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;ABC3615&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>rolling_stock_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>R2D2</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># labels are metadata. They&#39;re only used for display filtering</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;tchou-tchou&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;choo-choo&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># used to select speed limits for simulation</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>speed_limit_tag</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;MA100&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># the start time is an ISO 8601 datetime with timezone. it is not always the</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># same at the departure time, as there may be a stop at the starting point</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>start_time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2023-12-21T08:51:11.914897+00:00&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> </span>- {<span style=color:#204a87;font-weight:700>id: a, uic</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>87210</span>}<span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># Any operational point matching the given uic</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> </span>- {<span style=color:#204a87;font-weight:700>id: b, track: foo, offset</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10000</span>}<span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># 10m on track foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> </span>- {<span style=color:#204a87;font-weight:700>id: c, deleted: true, trigram</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ABC}</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># Any operational point matching the trigram ABC</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> </span>- {<span style=color:#204a87;font-weight:700>id: d, operational_point</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>X}</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># A specified operational point</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># the algorithm used for distributing margins and scheduled times</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>constraint_distribution</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>MARECO</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># or LINEAR</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># all durations and times are specified using ISO 8601</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># we don&#39;t supports months and years duration since it&#39;s ambiguous</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># times are defined as time elapsed since start. Even if the attribute is omitted,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># a scheduled point at the starting point is infered to have departure=start_time</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># the &#34;locked&#34; flag is ignored by the backend.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># To force stop-signal on stop&#39;s arrival, you can use the &#34;on_stop_signal&#34; flag.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>schedule</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> </span>- {<span style=color:#204a87;font-weight:700>at: a, stop_for: PT5M, locked</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span>}<span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># infered arrival to be equal to start_time</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> </span>- {<span style=color:#204a87;font-weight:700>at: b, arrival: PT10M, stop_for</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PT5M}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> </span>- {<span style=color:#204a87;font-weight:700>at: c, stop_for</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PT5M}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> </span>- {<span style=color:#204a87;font-weight:700>at: d, arrival: PT50M, locked: true, on_stop_signal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>margins</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># This example encodes the following margins:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>#   a --- 5% --- b --- 3% --- d</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># /!\ all schedule points with either an arrival or departure time must also be</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># margin boundaries. departure and arrival waypoints are implicit boundaries. /!\</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># boundaries delimit margin sections. A list of N boundaries yields N + 1 sections.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>boundaries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>b]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># the following units are supported:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>#  - none is a special value which indicates no margin. It&#39;s the default</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>#  - % means added percentage of the base simulation time</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>#  - min/100km means minutes per 100 kilometers</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>values</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;5%&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;3%&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;4.5min/100km&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># train speed at simulation start, in meters per second.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># must be zero if the train starts at a stop</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>initial_speed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>2.5</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>power_restrictions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline> </span>- {<span style=color:#204a87;font-weight:700>from: b, to: c, value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;M1C1&#34;</span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>comfort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AIR_CONDITIONING</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># or HEATING, default STANDARD</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># Should we use electrical profiles to select rolling stock speed effort curves</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>use_electrical_profiles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h1 id=combining-margins-and-schedule>Combining margins and schedule</h1><p>Margins and scheduled points are two ways to add time constraints to a train&rsquo;s schedule.
Therefore, there most be a clear set of rules to figure out how these two interfaces interact.</p><p>The end goal is to make the target schedule and margins consistent with each other. This is achieved by:</p><ul><li>computing what the schedule would look like if only margins were applied</li><li>compare that to the target schedule</li><li>correct the margin schedule so that it matches the target schedule</li></ul><p>The path is partitionned as follows:</p><ul><li><strong>known time sections</strong> span between locations where the arrival time is known.
If there are <code>N</code> such locations, there are <code>N - 1</code> known time sections.
In these sections, margins need to be adjusted to match the target schedule.</li><li>If the arrival time at destination is unknown, the section from the last known
arrival time point and the destination is called the <strong>relaxed time section</strong> has no bound.
Margins can be applied directly.</li></ul><p>As <strong>margins cannot span known time section boundaries</strong>, each known time section can be
further subdivided into margin sections. Margins cover the entire path.</p><p><strong>The end goal is to find the target arrival time at the end of each margin section</strong>.
This needs to be done while preserving consistency with the input schedule.</p><p><img src=schedule.svg alt="Schedule building algorithm"></p><p>The final schedule is computed as follows:</p><ul><li>A <strong>base simulation</strong> is computed, without any time constraint (other than stops). It&rsquo;s used to compute provisional margin values.</li><li>Make a <strong>provisional time table</strong>, which ignores target arrival times but includes provisional margin values.</li><li>For each <strong>known time section</strong>, compute the adjustment required to make the provisional schedule match the target schedule.</li><li>Distribute this difference into the known time section&rsquo;s margin sections, proportionally to margin section running time.
After distributing the adjustment into margin sections, the <strong>final schedule</strong> should be compatible with the target schedule.</li></ul><h2 id=error-handling>Error handling</h2><p>Some errors may happen while building the timetable:</p><ul><li>if a known time section&rsquo;s required adjustment is negative, a warning must be raised, as margins will have to be lowered</li><li>if a margin section&rsquo;s final running time is tighter than the base simulation, it cannot be achieved, and a warning should be raised</li></ul><p>Other errors can happen at runtime:</p><ul><li>target margin values can be too low, as transitions from high density margin to low margin section force the train to loose
time after it has exited to high density margin section.</li><li>target margin values can also be too high, as the train may not have time to slow down enough, or drive so slow as to be
unacceptable.</li></ul><p>During simulation, <strong>if a target arrival time cannot be achieved, the rest of the schedule still stands</strong>.</p><h2 id=endpoints>Endpoints</h2><h3 id=timetable>Timetable</h3><pre tabindex=0><code>POST /v2/timetable
GET /v2/timetable/ # Paginated list timetable
PUT /v2/timetable/ID
DELETE /v2/timetable/ID
GET /v2/timetable/ID # Timetable with list of train schedule ids attached to it
</code></pre><h3 id=train-schedule>Train Schedule</h3><pre tabindex=0><code>POST /v2/timetable/ID/train_schedule # A batch creation
GET /v2/train_schedule/ID
PUT /v2/train_schedule/ID # Update a specific train schedule
DELETE /v2/train_schedule # A batch deletion
</code></pre><h3 id=path>Path</h3><pre tabindex=0><code>POST /v2/infra/ID/pathfinding/topo # Not required now can be move later
POST /v2/infra/ID/pathfinding/blocks
# takes a pathfinding result and a list of properties to extract
POST /v2/infra/ID/path_properties?props[]=slopes&amp;props[]=gradients&amp;props[]=electrifications&amp;props[]=geometry&amp;props[]=operational_points
GET /v2/train_schedule/ID/path?infra_id=42 # Retrieve the path from a train schedule
</code></pre><h3 id=simulation-results>Simulation results</h3><pre tabindex=0><code># Retrieve the list of conflict of the timetable (invalid trains are ignored)
GET /v2/timetable/ID/conflicts?infra=N
# Retrieve the space, speed and time curve of a given train
GET /v2/train_schedule/ID/simulation?infa=N
# Retrieves simulation information for a given train list. Useful for finding out whether pathfinding/simulation was successful.
GET /v2/train_schedule/simulations_sumary?infa=N&amp;ids[]=X&amp;ids[]=Y
# Projects the space time curves and paths of a number of train schedules onto a given path
POST /v2/train_schedule/project_path?infra=N&amp;ids[]=X&amp;ids[]=Y
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-d68749890c12f16864453cedb0b81cde>2.5 - Authentication and authorization</h1><h2 id=context-and-requirements>Context and requirements</h2><ul><li>authentication (<code>authn</code>) is the process of figuring out an user&rsquo;s identity.</li><li>authorization (<code>authz</code>) is the process of figuring out whether an user can do something.</li></ul><p>This design project started as a result of a feature request coming from SNCF users
and stakeholders. After some interviews, we believe the overall needs to be as follows:</p><ul><li>controlling access to features<ul><li>some users are supposed to only view results of operational studies</li><li>some users only get access to part of the app</li><li>not everyone can have access to the admin panel</li><li>it could be nice to be able to roll experimental features out incrementaly</li></ul></li><li>controlling access to data<ul><li>some infrastructures shall only be changed by automated import jobs</li><li>users might want to control who can mess with what they&rsquo;re currently working on</li><li>rolling stock, infrastructure and timetable data may be confidential</li></ul></li></ul><h2 id=overall-architecture>Overall architecture</h2><pre class=mermaid>flowchart LR
  subgraph gateway
    auth([authentication])
  end

  subgraph editoast
  subgraph authorization
    roles([role check])
    permissions([permission check])
  end
  end

  subgraph decisions
    permit
    deny
  end

  request --&gt; auth --&gt; roles --&gt; permissions
  auth --&gt; deny
  roles --&gt; deny
  permissions --&gt; permit &amp; deny</pre><h2 id=authentication>Authentication</h2><p>The app&rsquo;s backend is not responsible for authenticating the user: it gets all required information
from <code>gateway</code>, the authenticating reverse proxy which stands between it and the front-end.</p><ul><li>at application start-up, the front-end redirects to the login page if the user is not logged in</li><li>if the user is already authenticated, the gateway returns user metadata</li><li>otherwise, the gateway initiates the authentication process, usually with OIDC.
The implementation was designed to allow new backends to be added easily.</li><li>once the user is authenticated, all requests to the backend can expect the following headers to be set:<ul><li><code>x-remote-user-identity-id</code> contain a unique identifier for this identity. It can be thought of as an opaque <code>(auth_method, user_id)</code> tuple.</li><li><code>x-remote-user-name</code> contain an username</li></ul></li></ul><p>When editoast receives a request, it has to match the remote user ID with a
database user, creating it as needed.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authn_subject</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>bigserial</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>generated</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>always</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>identity</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>primary</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authn_user</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87>bigint</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>primary</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>references</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>auth_subject</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>delete</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cascade</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>identity_id</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87>text</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87>text</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authn_group</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>id</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>bigint</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>primary</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>references</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>auth_subject</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>delete</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cascade</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>name</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>text</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- add a trigger so that when a group is deleted, the associated authn_subject is deleted too
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- add a trigger so that when an user is deleted, the associated authn_subject is deleted too
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authn_group_membership</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87>bigint</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>references</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>auth_user</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>delete</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cascade</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87>bigint</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>references</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>auth_group</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>delete</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cascade</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>unique</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=group-and-role-management-api>Group and role management API</h3><div class="alert alert-warning" role=alert>Users cannot be directly created. The authenticating reverse proxy is in charge of user management.</div><ul><li>role management is protected by the <code>role:admin</code> role.</li><li>groups management is subject to permissions.</li></ul><h4 id=get-information-about-an-user>Get information about an user</h4><pre tabindex=0><code>GET /authn/me
GET /authn/user/{user_id}
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>42</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Foo Bar&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;groups&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;A&#34;</span><span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;B&#34;</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;app_roles&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;ops&#34;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;builtin_roles&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;infra:read&#34;</span><span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p><a href=#builtin-roles>Builtin roles</a> are deduced from app roles, and thus cannot be directly edited.</p><h4 id=add-roles-to-an-user-or-group>Add roles to an user or group</h4><p>This endpoint can only be called if the user has the <code>role:admin</code> builtin role.</p><pre tabindex=0><code>POST /authn/user/{user_id}/roles/add
POST /authn/group/{group_id}/roles/add
</code></pre><p>Takes a list of app roles:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;ops&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;stdcm&#34;</span><span style=color:#000;font-weight:700>]</span>
</span></span></code></pre></div><h4 id=remove-roles-from-an-user-or-group>Remove roles from an user or group</h4><p>This endpoint can only be called if the user has the <code>role:admin</code> builtin role.</p><pre tabindex=0><code>POST /authn/user/{user_id}/roles/remove
</code></pre><p>Takes a list of app roles to remove:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;ops&#34;</span><span style=color:#000;font-weight:700>]</span>
</span></span></code></pre></div><h4 id=create-a-group>Create a group</h4><p>This endpoint can only be called if the user has the <code>group:create</code> builtin role.
When an user creates a group, it becomes its owner.</p><pre tabindex=0><code>POST /authn/group
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Foo&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#34;app_roles&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;ops&#34;</span><span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Returns the group ID.</p><h4 id=add-users-to-a-group>Add users to a group</h4><p>Can only be called if the user has <code>Writer</code> access to the group.</p><pre tabindex=0><code>POST /authn/group/{group_id}/add
</code></pre><p>Takes a list of user IDs</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>]</span>
</span></span></code></pre></div><h4 id=remove-users-from-a-group>Remove users from a group</h4><p>Can only be called if the user has <code>Writer</code> access to the group.</p><pre tabindex=0><code>POST /authn/group/{group_id}/remove
</code></pre><p>Takes a list of user IDs</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>]</span>
</span></span></code></pre></div><h4 id=delete-a-group>Delete a group</h4><p>Can only be called if the user has <code>Owner</code> access to the group.</p><pre tabindex=0><code>DELETE /authn/group/{group_id}
</code></pre><h2 id=authorization>Authorization</h2><p>As shown in the overall architecture section, to determine if a subject is
allowed to conduct an action on a ressource, two checks are performed:</p><ol><li>We check that the <strong>roles</strong> of the subject allows the action.</li><li>We check that the subject has the <strong>minimum privileges</strong> on the ressource(s) that are required to perform the action.</li></ol><h3 id=roles>Roles</h3><p>Subject can have any number of roles. Roles allow access to features. Roles do not give rights on specific objects.</p><p>Both the frontend and backend require some roles to be set to allow access to parts of the app.
In the frontend, roles guard features, in the backend, roles guard endpoints or group of endpoints.</p><p>There are two types of roles:</p><ul><li><strong>Builtin roles</strong> are bundled with OSRD. Only builtin roles can be required by endpoints. These roles <strong>cannot</strong> directly be assigned to users.</li><li><strong>Application roles</strong> can be assigned to users. These roles are defined in a configuration file that editoast reads at startup.</li></ul><p>Here is an example of what builtin roles might look like:</p><ul><li><code>role:admin</code> allows assigning roles to users and groups</li><li><code>group:create</code> allows creating user groups</li><li><code>infra:read</code> allows access to the map viewer module</li><li><code>infra:write</code> implies <code>infra:read</code>. it allows access to the infrastructure editor.</li><li><code>rolling-stock:read</code></li><li><code>rolling-stock:write</code> implies <code>rolling-stock:read</code>. Allows access to the rolling stock editor.</li><li><code>timetable:read</code></li><li><code>timetable:write</code> implies <code>timetable:read</code></li><li><code>operational-studies:read</code> allows read only access to operational studies. it implies <code>infra:read</code>, <code>timetable:read</code> and <code>rolling-stock:read</code></li><li><code>operational-studies:write</code> allows write access to operational studies. it implies <code>operational-studies:read</code> and <code>timetable:write</code></li><li><code>stdcm</code> implies <code>infra:read</code>, <code>timetable:read</code> and <code>rolling-stock:read</code>. it allows access to the short term path request module.</li><li><code>admin</code> gives access to the admin panel, and implies all other roles</li></ul><p>Given these builtin roles, application roles may look like:</p><ul><li><code>operational-studies-customer</code> implies <code>operational-studies:read</code></li><li><code>operational-studies-analyst</code> implies <code>operational-studies:write</code></li><li><code>stdcm-customer</code> implies <code>stdcm</code></li><li><code>ops</code> implies <code>admin</code></li></ul><p>Roles are <em>hierarchical</em>. This is a necessity to ensure that, for example, if we are to introduce a new action related to scenarios, each subject with the role &ldquo;exploitation studies&rdquo; gets that new role automatically.
We&rsquo;d otherwise need to edit the appropriate existing roles.</p><p>Their hierarchy could ressemble:</p><pre class=mermaid>%%{init: {&#34;flowchart&#34;: {&#34;defaultRenderer&#34;: &#34;elk&#34;}} }%%
flowchart TD
  subgraph application roles
    operational-studies-analyst
    operational-studies-customer
  end

  subgraph builtin roles
    rolling-stock:read
    rolling-stock:write
    infra:read
    infra:write
    timetable:read
    timetable:write
    operational-studies:read
    operational-studies:write
  end

  operational-studies-analyst --&gt; operational-studies:write
  operational-studies-customer --&gt; operational-studies:read

  infra:write --&gt; infra:read
  rolling-stock:write --&gt; rolling-stock:read
  operational-studies:read --&gt; infra:read &amp; timetable:read &amp; rolling-stock:read
  operational-studies:write --&gt; operational-studies:read &amp; timetable:write
  timetable:write --&gt; timetable:read

  classDef app fill:#333,color:white,font-style:italic
  classDef builtin fill:#992233,color:white,font-style:bold

  class stdcm,exploitation,infra,project,study,scenario app
  class infra_read,infra_edit,infra_delete,project_create,study_delete,scenario_create,scenario_update builtin</pre><h3 id=permissions>Permissions</h3><p>Permission checks are done by the backend, even though the frontend may use the effective privilege level
of an user to decide whether to allow modifying / changing permissions for a given object.</p><p>Permissions are checked per resource, after checking roles.
A single request may involve multiple resources, and as such involve multiple permission checks.</p><p>Permission checks are performed as follows:</p><ul><li>for each request, before any resource is accessed, compute which resources need access and required privilege levels</li><li>figure out, for the request&rsquo;s user, its effective privilege level for every involved resource</li><li>if the user&rsquo;s privilege level does not meet expectations, raise an error <strong>before any change is made</strong></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>EffectivePrivLvl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Owner</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// all operations allowed, including granting access and deleting the resource
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Writer</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#8f5902;font-style:italic>// can change the resource
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Creator</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>// can create new subresources
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Reader</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#8f5902;font-style:italic>// can read the resource
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>MinimalMetadata</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// is indirectly aware that the resource exists
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>trait</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Resource</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[must_use]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>get_privlvl</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>resource_pk</span>: <span style=color:#204a87;font-weight:700>u64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>user</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#000>UserIdentity</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>EffectivePrivLvl</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>The backend may therefore perform one or more privilege check per request:</p><ul><li>pathfinding:<ul><li><code>Reader</code> on the infrastructure</li></ul></li><li>displaying a timetable:<ul><li><code>Reader</code> on each rolling stock</li></ul></li><li>batch train creation:<ul><li><code>Creator</code> on the timetable</li></ul></li><li>conflict detection:<ul><li><code>Reader</code> on the infrastructure</li><li><code>Reader</code> on the timetable</li><li><code>Reader</code> on every involved rolling stock</li></ul></li><li>simulation results:<ul><li><code>Reader</code> on the infrastructure</li><li><code>Reader</code> on the rolling stock</li></ul></li></ul><p>A grant is a right, given to an user or group on a specific resource.
Users get privileges through grants. There are two types of grants:</p><ul><li>explicit grants are explicitly attached to resources</li><li>implicit grants automatically propagate explicit grants for objects which belong to a hierarchy:<ul><li>if a subject owns a project, it also owns all studies and scenarios</li><li>if a subject can read a scenario, it knows the parent study and project exist</li></ul></li></ul><h4 id=explicit-grants>Explicit grants</h4><ul><li>can be edited from the frontend</li><li>any user holding grants over a resource can add new ones</li><li>when a resource is created, <code>Owner</code> is granted to the current user</li><li>not all objects type can have explicit grants: train schedule inherit their timetable&rsquo;s grants</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- this type is the same as EffectivePrivLvl, except that MinimalMetadata is absent,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- as it cannot be granted directly. mere knowledge that an object exist can only be
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- granted using implicit grants.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grant_privlvl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enum</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;Owner&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Writer&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Creator&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;Reader&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- this table is a template, which other grant tables are
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- designed to be created from. it must be kept empty.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authz_template_grant</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>-- if subject is null, this grant applies to any subject
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>subject</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87>bigint</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>references</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authn_subject</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>delete</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cascade</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>grant</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#000>grant_privlvl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>granted_by</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87>bigint</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>references</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authn_user</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>delete</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>granted_at</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>timestamp</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>CURRENT_TIMESTAMP</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- these indices speed up cascade deletes
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>index</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authz_template_grant</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>subject</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>index</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authz_template_grant</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>granted_by</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- create a new grant table for infrastructures
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>table</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authz_grant_EXAMPLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>like</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authz_template_grant</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>including</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>resource</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>bigint</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>references</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EXAMPLE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>delete</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>cascade</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>null</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>unique</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nulls</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>not</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>distinct</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>resource</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>subject</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>-- raise an error if grants are inserted into the template
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>function</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authz_grant_insert_error</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>RETURNS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>trigger</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#a40000>$</span><span style=color:#000>err$</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>BEGIN</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>RAISE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>EXCEPTION</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;authz_grant is a template, which other grant &#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#4e9a06>&#39;tables are designed to inherit from. it must be kept empty.&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#a40000>$</span><span style=color:#000>err$</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>LANGUAGE</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>plpgsql</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>trigger</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>before</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>insert</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authz_template_grant</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>execute</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>function</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authz_grant_insert_error</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h4 id=implicit-grants>Implicit grants</h4><div class="alert alert-info" role=alert>Implicit grants only apply to the operational studies module, <strong>not</strong> timetables, infrastructures and rolling stocks.</div><p>Implicit grants propagate explicit grants to related objects. There are two types of implicit grants:</p><ul><li>explicit grants propagate downwards within hierarchies: <code>Owner</code>, <code>Reader</code>, <code>Writer</code> propagate as is, <code>Creator</code> is reduced to <code>Reader</code></li><li><code>MinimalMetadata</code> propagates up within project hierarchies, so that read access to a study or scenario allows having the name and description of the parent project</li></ul><p>The following objects have implicit grants:</p><ul><li><code>project</code> gets <code>MinimalMetadata</code> if the user has any right on a child study or scenario</li><li><code>study</code> gets:<ul><li><code>MinimalMetadata</code> if the user has any right on a child scenario</li><li><code>Owner</code>, <code>Reader</code>, <code>Writer</code> if the user has such right on the parent study. <code>Creator</code> is reduced to <code>Reader</code>.</li></ul></li><li><code>scenario</code> gets <code>Owner</code>, <code>Reader</code>, <code>Writer</code> if the user has such right on the parent study or project. <code>Creator</code> is reduced to <code>Reader</code>.</li><li><code>train-schedule</code>s have the same grants as their timetable</li></ul><h3 id=permission-meta-model>Permission meta-model</h3><h4 id=get-the-privilege-level-of-the-current-user>Get the privilege level of the current user</h4><pre tabindex=0><code>GET /authz/{resource_type}/{resource_id}/privlvl
</code></pre><h4 id=get-all-grants-for-a-resource>Get all grants for a resource</h4><pre tabindex=0><code>GET /authz/{resource_type}/{resource_id}/grants
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;subject&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>&#34;kind&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;group&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>42</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Bar&#34;</span><span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;implicit_grant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Owner&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;implicit_grant_source&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;project&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;subject&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>&#34;kind&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>42</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Foo&#34;</span><span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;grant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Writer&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;subject&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span><span style=color:#204a87;font-weight:700>&#34;kind&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;user&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>&#34;id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>42</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Foo&#34;</span><span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;grant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Writer&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;implicit_grant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;MinimalMetadata&#34;</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;implicit_grant_source&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;project&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>]</span>
</span></span></code></pre></div><p>Implicit grants cannot be edited, and are only displayed to inform the end user.</p><h4 id=add-a-new-grant>Add a new grant</h4><pre tabindex=0><code>POST /authz/{resource_type}/{resource_id}/grants
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;subject_id&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>42</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;grant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Writer&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=change-a-grant>Change a grant</h4><pre tabindex=0><code>PATCH /authz/{resource_type}/{resource_id}/grants/{grant_id}
</code></pre><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87;font-weight:700>&#34;grant&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;Reader&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=revoke-a-grant>Revoke a grant</h4><pre tabindex=0><code>DELETE /authz/{resource_type}/{resource_id}/grants/{grant_id}
</code></pre><h2 id=implementation-plan>Implementation plan</h2><h3 id=phase-1-ground-work>Phase 1: ground work</h3><p>Back-end:</p><ul><li>pass the proper headers from the reverse proxy to editoast</li><li>implement the authn / authz model into the database</li><li>get / create users on the fly using reverse proxy headers</li><li>implement the role parsing and book-keeping (it can be parsed on startup and leaked into a static lifetime)</li><li>implement a proof of concept for roles using <code>role:admin</code> and role management</li><li>implement a proof of concept for permissions by implementing group management</li><li>implement a middleware within editoast which:<ul><li>attaches a UserInfo object to each request</li><li>ensures that role / permission checks were performed. Implement two modules: log on missing check, abort on missing check.</li><li>injects which checks were performed into response headers so it can be tested</li></ul></li><li>introduce the concept of rolling stock collections to enable easier rolling stock permission checking</li><li>write a migration guide to help OSRD developpers navigate the authorization APIs</li></ul><p>Front-end:</p><ul><li>take into account builtin roles to decide which features to unlock</li><li>design, validate and build a permission editor</li><li>prepare graceful handling of 403s</li></ul><h3 id=phase-2-migration>Phase 2: migration</h3><p>Back-end:</p><ul><li>incrementally migrate all endpoints, using the middleware to find missing checks</li><li>switch the default action on missing permission check to abort</li></ul><p>Front-end:</p><ul><li>add the permission editor to all relevant objects</li><li>handle 403s, especially on scenarios, where read access on the timetable, infra, rolling stock collections and electrical profile is required</li></ul><h2 id=design-decisions>Design decisions</h2><h3 id=simultaneous-rbac-and-abac>Simultaneous RBAC and ABAC</h3><p>RBAC: role based access control (users have roles, actions require roles)
ABAC: attribute based access control (resources have attributes, user + actions require attributes). ACLs are a kind of ABAC.</p><p>After staring at what users asked for and established authorization models allow,
we figured out that while no one model is a good fit on its own:</p><ul><li>just RBAC would not allow fine grained, per object access control</li><li>just ABAC would not allow guarding off access to entire features</li></ul><p>We decided that each authorization model could be used where it shows its strength:</p><ul><li>RBAC is used to authorize access to frontend features and backend endpoints</li><li>ABAC is used to authorize actions on specific objects</li></ul><p>We found no success in our attempts to find a unifying model.</p><h3 id=not-using-any-policy-language>Not using any policy language</h3><p>At first, we assumed that using a policy language would assist with correctly implementing authorization. After further consideration, we concluded that:</p><ul><li>no user asked for policy flexibility nor policy as code, and there does not seem to be any obvious use case not already covered by RBAC + ABAC</li><li>the main policy language considered, cedar, makes it very awkward to implement single pass RBAC + ABAC</li><li>the primary benefit of policy languages, policy flexibility, is still very much constrained by the data the policy engine is fed: for OSRD,
feeding all grants, all users, all groups and all roles to the policy engine is not practical. we thus need filtering and careful modeling,
which almost guarantees changes will be required if a new authz rule type were to be requested by a customer. Worse yet, these changes seem
to require more effort than adapting the authz system if there were not policy language at all.</li><li>as policy languages only deal with evaluating the policy, one can be introduced later if so desired</li></ul><h3 id=no-implicit-grants-for-infra-timetable-and-rolling-stock>No implicit grants for infra, timetable and rolling stock</h3><p>We felt like this feature would be hard to implement, and be likely to introduce confidentiality and performance issues:</p><ul><li>these objects may not be part of any operational studies, or multiple operational studies</li><li>implicit grants are hard to implement, and risk introducing vulnerabilities</li><li>infra, timetable and rolling stock are likely to be confidential</li></ul><p>Instead, we plan to:</p><ul><li>delay implementing this feature until we figure out if the lack thereof is an UX issue</li><li>if deemed required, implement it by checking, within the permission editor, whether all
users having access to a scenario can access associated data, and suggesting associated
permission changes</li></ul><h3 id=all-resource-types-share-the-same-permission-management-endpoints>All resource types share the same permission management endpoints</h3><p>We considered two patterns for permission management endpoints:</p><ul><li>a single set of endpoints for all resource types: <code>/authz/{resource_type}/{resource_id}/grants/...</code></li><li>separate set of endpoints per resource type: <code>/v2/infra/{infra_id}/grants/...</code></li></ul><p>We found that:</p><ul><li>having separate set of endpoints per resource types brought extra back-end and front-end complexity</li><li>the only constraint of unified permission management endpoints is that all resource types need globaly unique IDs</li><li>the globaly unique ID constraint is less costly than the extra complexity of separate endpoints</li></ul><h3 id=dynamically-enforce-permission-checks>Dynamically enforce permission checks</h3><p>Ideally, there would be static checks enforcing permission checks.
However, we found no completly fool proof way to statically do so.</p><p>Instead, we decided that all permission checks will be registered
with a middleware, which will either log or raise an error when a
handler performs no check.</p><ul><li>during local development, the middleware logs missing permission checks as errors</li><li>during continuous integration checks and production deployments, the middleware aborts on missing checks</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ad1fe861914919710a4ff4f68d0c334d>2.5.1 - Editoast internal authorization API</h1><div class="pageinfo pageinfo-warn"><p>This document is an annex to the <a href=..>main authorization design document</a></p></div><div class="pageinfo pageinfo-info"><p>This design document is not intended to describe the exact editoast authorization API.
The actual implementation may slightly differ. If major limitations were uncovered, please
update this document.</p></div><h2 id=context-and-requirements>Context and requirements</h2><p>The following invariants were deemed worth validating:</p><ul><li>(high priority) role and privilege checks were performed</li><li>(low priority) privilege checks are performed before changes are made / data is returned</li><li>(low priority) access patterns match privilege checks</li></ul><p>Other design criterias have an impact:</p><ul><li>(high priority) misuse potential</li><li>(high priority) usage complexity and developer experience</li><li>(medium priority) ease of migration</li><li>(low priority) static checks are prefered</li></ul><h2 id=data-model>Data model</h2><h3 id=builtin-roles>Builtin roles</h3><p>First, we define an enum for all our builtin roles:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#[derive(Roles, EnumSetType, Copy)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>BuiltinRole</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[role(tag = </span><span style=color:#4e9a06>&#34;infra:read&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>InfraRead</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[role(tag = </span><span style=color:#4e9a06>&#34;infra:write&#34;</span><span style=color:#8f5902;font-style:italic>, implies = [InfraRead])]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>InfraWrite</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[role(tag = </span><span style=color:#4e9a06>&#34;rolling-stock:read&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>RollingStockRead</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[role(tag = </span><span style=color:#4e9a06>&#34;rolling-stock:write&#34;</span><span style=color:#8f5902;font-style:italic>, implies = [RollingStockRead])]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>RollingStockWrite</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[role(tag = </span><span style=color:#4e9a06>&#34;timetable:read&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>TimetableRead</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[role(tag = </span><span style=color:#4e9a06>&#34;timetable:write&#34;</span><span style=color:#8f5902;font-style:italic>, implies = [TimetableRead])]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>TimetableWrite</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[role(tag = </span><span style=color:#4e9a06>&#34;operational-studies:read&#34;</span><span style=color:#8f5902;font-style:italic>, implies = [TimetableRead, InfraRead, RollingStockRead])]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>OperationalStudiesRead</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>#[role(tag = </span><span style=color:#4e9a06>&#34;operational-studies:write&#34;</span><span style=color:#8f5902;font-style:italic>, implies = [OperationalStudiesRead, TimetableWrite])]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>OperationalStudiesWrite</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>which could expand to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#[derive(EnumSetType, Copy)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>BuiltinRole</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>InfraRead</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>InfraWrite</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>RollingStockRead</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>RollingStockWrite</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>TimetableRead</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>TimetableWrite</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>OperationalStudiesRead</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>OperationalStudiesWrite</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>const</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ROLES</span>: <span style=color:#000>phf</span>::<span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;&amp;</span><span style=color:#204a87>&#39;static</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>str</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BuiltinRole</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>phf</span>::<span style=color:#000>phf_map!</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#34;infra:read&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>Self</span>::<span style=color:#000>InfraRead</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#34;infra:write&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>Self</span>::<span style=color:#000>InfraWrite</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#34;rolling-stock:read&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>Self</span>::<span style=color:#000>RollingStockRead</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#34;rolling-stock:write&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>Self</span>::<span style=color:#000>RollingStockWrite</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#34;timetable:read&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>Self</span>::<span style=color:#000>TimetableRead</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#34;timetable:write&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>Self</span>::<span style=color:#000>TimetableWrite</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#34;operational-studies:read&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>Self</span>::<span style=color:#000>OperationalStudiesRead</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#4e9a06>&#34;operational-studies:write&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>Self</span>::<span style=color:#000>OperationalStudiesWrite</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>};</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>BuiltinRole</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>parse_tag</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tag</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>str</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Option</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BuiltinRole</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>ROLES</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tag</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>tag</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#204a87>&#39;static</span> <span style=color:#204a87;font-weight:700>str</span> <span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>match</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#3465a4>Self</span>::<span style=color:#000>InfraRead</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;infra:read&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#3465a4>Self</span>::<span style=color:#000>InfraWrite</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;infra:write&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#3465a4>Self</span>::<span style=color:#000>RollingStockRead</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;rolling-stock:read&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#3465a4>Self</span>::<span style=color:#000>RollingStockWrite</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;rolling-stock:write&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#3465a4>Self</span>::<span style=color:#000>TimetableRead</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;timetable:read&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#3465a4>Self</span>::<span style=color:#000>TimetableWrite</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;timetable:write&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#3465a4>Self</span>::<span style=color:#000>OperationalStudiesRead</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;operational-studies:read&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#3465a4>Self</span>::<span style=color:#000>OperationalStudiesWrite</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;operational-studies:write&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>implies</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[</span><span style=color:#3465a4>Self</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>match</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#3465a4>Self</span>::<span style=color:#000>InfraRead</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[</span><span style=color:#3465a4>Self</span>::<span style=color:#000>InfraRead</span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#3465a4>Self</span>::<span style=color:#000>InfraWrite</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[</span><span style=color:#3465a4>Self</span>::<span style=color:#000>InfraRead</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>Self</span>::<span style=color:#000>InfraWrite</span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#3465a4>Self</span>::<span style=color:#000>RollingStockRead</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[</span><span style=color:#3465a4>Self</span>::<span style=color:#000>RollingStockRead</span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#3465a4>Self</span>::<span style=color:#000>RollingStockWrite</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[</span><span style=color:#3465a4>Self</span>::<span style=color:#000>RollingStockRead</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>Self</span>::<span style=color:#000>RollingStockWrite</span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#3465a4>Self</span>::<span style=color:#000>TimetableRead</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[</span><span style=color:#3465a4>Self</span>::<span style=color:#000>TimetableRead</span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#3465a4>Self</span>::<span style=color:#000>TimetableWrite</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[</span><span style=color:#3465a4>Self</span>::<span style=color:#000>TimetableRead</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>Self</span>::<span style=color:#000>TimetableWrite</span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#3465a4>Self</span>::<span style=color:#000>OperationalStudiesRead</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[</span><span style=color:#3465a4>Self</span>::<span style=color:#000>TimetableRead</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>Self</span>::<span style=color:#000>InfraRead</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>Self</span>::<span style=color:#000>RollingStockRead</span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#3465a4>Self</span>::<span style=color:#000>OperationalStudiesWrite</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[</span><span style=color:#3465a4>Self</span>::<span style=color:#000>OperationalStudiesRead</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>Self</span>::<span style=color:#000>TimetableWrite</span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=application-roles>Application roles</h3><p>Application roles are loaded from a yaml file at application startup:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>application_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ops</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;DevOps&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Software engineers in charge of operating and maintaining the app&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>implies</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>admin]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>stdcm-customer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;STDCM customer&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>implies</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>stdcm]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>operational-studies-customer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Operational studies customer&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>implies</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>operational-studies:read]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>operational-studies-analyse</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Operational studies analyse&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>implies</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>operational-studies:write]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Once loaded into editoast, app roles are resolved to a set of user roles:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>UserRoles</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EnumSet</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>BuiltinRole</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>AppRoleResolver</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>HashMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>UserRoles</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/// The API does not allow querying app roles, as it should have no impact on authorization:
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/// only the final resolved set of builtin roles matters.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AppRoleResolver</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>load_from_config</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>path</span>: <span style=color:#000>Path</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#3465a4>Self</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>resolve</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>app_role_tag</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>str</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UserRoles</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>E</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=resources-and-grants>Resources and grants</h3><p>TODO: decide where to process implicit grants: database or editoast?</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>ResourceType</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Group</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Project</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Study</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Scenario</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Timetable</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Infra</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>RollingStockCollection</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Grant</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>grant_id</span>: <span style=color:#204a87;font-weight:700>u64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>subject</span>: <span style=color:#000>SubjectId</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>privlvl</span>: <span style=color:#000>GrantPrivLvl</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>granted_by</span>: <span style=color:#000>UserId</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>granted_at</span>: <span style=color:#000>Timestamp</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>all_grants</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>resource_type</span>: <span style=color:#000>ResourceType</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>resource_id</span>: <span style=color:#204a87;font-weight:700>u64</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Grant</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>applicable_grants</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>resource_type</span>: <span style=color:#000>ResourceType</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>resource_id</span>: <span style=color:#204a87;font-weight:700>u64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>subject_ids</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SubjectId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Grant</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>revoke_grant</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>resource_type</span>: <span style=color:#000>ResourceType</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grant_id</span>: <span style=color:#204a87;font-weight:700>u64</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>update_grant</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>resource_type</span>: <span style=color:#000>ResourceType</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grant_id</span>: <span style=color:#204a87;font-weight:700>u64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>privlvl</span>: <span style=color:#000>GrantPrivLvl</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=low-level-authorization-api>Low level authorization API</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>PrivCheck</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>resource_type</span>: <span style=color:#000>ResourceType</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>resource_id</span>: <span style=color:#204a87;font-weight:700>u64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>minimum_privlvl</span>: <span style=color:#000>EffectivePrivLvl</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/// The authorizer is injected into each request by a middleware.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/// The middleware finds the user ID associated with the request.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>/// At the end of each request, it ensures roles and privileges were checked.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Authorizer</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>user_id</span>: <span style=color:#204a87;font-weight:700>u64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>checked_roles</span>: <span style=color:#204a87>Option</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>UserRoles</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>checked_privs</span>: <span style=color:#204a87>Option</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PrivCheck</span><span style=color:#ce5c00;font-weight:700>&gt;&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>};</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>FromRequest</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Authorizer</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Authorizer</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>check_roles</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>conn</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#000>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DatabaseConnection</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>required_roles</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>BuiltinRole</span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>bool</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>check_privs</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>conn</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#000>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DatabaseConnection</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>required_privs</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>PrivCheck</span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87;font-weight:700>bool</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>This API is then used as follows:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#[post(</span><span style=color:#4e9a06>&#34;/project/{project_id}/study/{study_id}/scenario&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>create_scenario</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>path</span>: <span style=color:#000>Path</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>authz</span>: <span style=color:#000>Authorizer</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>db_pool</span>: <span style=color:#000>web</span>::<span style=color:#000>Data</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DatabasePool</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Json</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>form</span><span style=color:#000;font-weight:700>)</span>: <span style=color:#000>Json</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ScenarioCreateForm</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Response</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>db_pool</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>().</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>project_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>study_id</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>into_inner</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// validate that study.scenario == scenario
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>authz</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>check_roles</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>BuiltinRoles</span>::<span style=color:#000>OperationalStudiesWrite</span><span style=color:#000;font-weight:700>]).</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>authz</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>check_privs</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[(</span><span style=color:#000>Study</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>study_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Creator</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>into</span><span style=color:#000;font-weight:700>()]).</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// create the object
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>Ok</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=high-level-authorization-api>High level authorization API</h2><h3 id=-proposal-fully-dynamic-checks>🤔 Proposal: fully dynamic checks</h3><p>This proposal suggests dynamically enforcing all authorization invariants:</p><ul><li><em>role and privilege checks were performed</em>: The authorizer records all checks, and panics / logs an error if no check is made</li><li><em>privilege checks are performed before changes are made / data is returned</em>: checked database accesses
(the default) cannot be made before commiting authorization checks. No more authorization check can be made after commiting.</li><li><em>access patterns match privilege checks</em>: Check database access functions ensure a prior check was
made using the Authorizer&rsquo;s check log.</li></ul><p>Each database access method thus gets two variants:</p><ul><li><p>a checked variant (the default), which takes the Authorizer as a parameter. This variants panics if:</p><ul><li>a resource is accessed before authorization checks are commited</li><li>a resource is accessed without a prior authorizer check.</li></ul></li><li><p>an unchecked variant. its use should be limited to:</p><ul><li>fetching data for authorization checks</li><li>updating modification dates</li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#[post(</span><span style=color:#4e9a06>&#34;/project/{project_id}/study/{study_id}/scenario&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>create_scenario</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>path</span>: <span style=color:#000>Path</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>authz</span>: <span style=color:#000>Authorizer</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>db_pool</span>: <span style=color:#000>web</span>::<span style=color:#000>Data</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DatabasePool</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Json</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>form</span><span style=color:#000;font-weight:700>)</span>: <span style=color:#000>Json</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ScenarioCreateForm</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Response</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>db_pool</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>().</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>project_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>study_id</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>into_inner</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// Check if the project and the study exist
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>project</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>study</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>check_project_study_conn</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>project_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>study_id</span><span style=color:#000;font-weight:700>).</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>authz</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>check_roles</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>BuiltinRoles</span>::<span style=color:#000>OperationalStudiesWrite</span><span style=color:#000;font-weight:700>])</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>authz</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>check_privs</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[(</span><span style=color:#000>Study</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>study_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Creator</span><span style=color:#000;font-weight:700>).</span><span style=color:#000>into</span><span style=color:#000;font-weight:700>()])</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// all checks done, checked database accesses allowed
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>authz</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>commit</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// create the scenario
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>scenario</span>: <span style=color:#000>Scenario</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>data</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>into_scenario</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>study_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timetable_id</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>scenario</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>scenario</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>create</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>db_pool</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>clone</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>authz</span><span style=color:#000;font-weight:700>).</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// Update study last_modification field
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>study</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>update_last_modified</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>).</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// Update project last_modification field
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>project</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>update_last_modified</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>).</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>Ok</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=bonus-proposal-require-roles-using-macros>Bonus proposal: require roles using macros</h3><p>TODO: check if this is worth keeping</p><p>Then, we annotate each endpoint that require role restrictions with <code>requires_roles</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#[post(</span><span style=color:#4e9a06>&#34;/scenario&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[requires_roles(BuiltinRoles::OperationalStudiesWrite)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>create_scenario</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>user</span>: <span style=color:#000>web</span>::<span style=color:#000>Header</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>GwUserId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>db_pool</span>: <span style=color:#000>web</span>::<span style=color:#000>Data</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DatabasePool</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Response</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>todo!</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>which may expand to something similar to:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>create_scenario</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>user</span>: <span style=color:#000>web</span>::<span style=color:#000>Header</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>GwUserId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>db_pool</span>: <span style=color:#000>web</span>::<span style=color:#000>Data</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DatabasePool</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Response</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>conn</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>db_pool</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>().</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>required_roles</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>BuiltinRoles</span>::<span style=color:#000>OperationalStudiesWrite</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>!</span><span style=color:#000>editoast_models</span>::<span style=color:#000>check_roles</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>user_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>required_roles</span><span style=color:#000;font-weight:700>).</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>return</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>Err</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>403</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>move</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>todo!</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}.</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=-proposal-static-access-control>🤔 Proposal: Static access control</h3><div class="pageinfo pageinfo-info"><p>This proposal aims at improving the <code>Authorizer</code> descibed above by building on it a safety layer that encodes granted permissions into the type system.</p><p>This way, if access patterns do not match the privilege checks performed beforehand, the program will fail to compile and precisely pinpoint the privilege override as a type error.</p></div><p>To summarize, the <code>Authorizer</code> allows us to:</p><ol><li>Pre-fetch the user of the request and its characteristics as a middleware</li><li>Check their roles</li><li>Maintain a log of authorization requests on specific ressources, and check if they hold</li><li>Guarantees that no authorization will be granted passed a certain point (<code>commit</code> function)</li><li>At the end of an endpoint, checks that permissions were granted or <code>panic!</code>s otherwise</li></ol><p>While all these checks are performed at runtime, those can be tested rather trivially in unit tests.</p><p>However, the <code>Authorizer</code> cannot check that the endpoints actually respect the permission level they asked for when they access the DB. For example, an endpoint might ask for <code>Read</code> privileges on a <code>Timetable</code>, only to delete it afterwards. This is trivial to check if the privilege override happens in the same function, but it can be much more vicious if that happens conditionally, in another function, deep down the call stack. For the same reasons, refactoring code subject to authorizations becomes much more risky and error prone.</p><p>Hence, for both development and review experience, to ease writing and refactoring authorizing code, to be confident our system works, and for general peace of mind, we need a way to ensure that an endpoint won&rsquo;t go beyond the privilege level it required for all of its code paths.</p><p>We can do that either statically or dynamically.</p><h4 id=dynamic-access-pattern-checks>Dynamic access pattern checks</h4><p>Let&rsquo;s say we keep the <code>Authorizer</code> as the high-level API for authorization.
It holds a log of grants. Therefore, any DB operation that needs to be authorized must, in addition to the <code>conn</code>, take an <code>Arc&lt;Authorizer></code> parameter and let the operation check that it&rsquo;s indeed authorized. For example, every <code>retrieve(conn, authorizer, id)</code> operation would ask the authorizer the permission before querying the DB.</p><p>This approach works and has the benefit of being easy to understand, but does not provide any guarantee that the access paterns match the granted authorizations and that privilege override cannot happen.
A way to ensure that would be to thoroughly test each endpoint and ensure that the DB accesses <code>panic</code> in expected situations. Doing so manually is extremely tedious and fragile in the long run, so let&rsquo;s focus on automated tests.
To make sure that, at any moment, each endpoint doesn&rsquo;t override its privileges, we&rsquo;d need a test for each releveant privilege level and for each code path accessing ressources. Admittedly this would be great, but:</p><ul><li>it <strong>heavily depends on test coverage</strong> (which we don&rsquo;t have) to make sure no code path is left out, i.e. that no test is missing</li><li>it&rsquo;s unrealistic given the current state of things and how fast editoast changes</li><li>tests would be extremely repetitive, and mistakes will happen</li><li>the test suite of an endpoint now not only depends on what it should do, but also on <strong>how</strong> it should do it: i.e. to know how to test your endpoint, you need to know precisely what DB operations will be performed, under what conditions, on all code paths, and replicate that</li><li>when refactoring code subject to authorization that&rsquo;s shared across several endpoints, the tests of each of these endpoints would need to be examined to ensure no check goes missing</li><li>unless we postpone the creation of these tests and accept a lower level of confidence in our system, even temporarily(TM), the authz migration would be slowed down significantly</li></ul><p>Or we could just accept the risk.</p><p>Or we could statically ensure that no endpoint override its requested privileges, using the typesystem, and be sure that such issues can (almost) never arise.</p><h4 id=static-checks>Static checks</h4><p>The idea is to provide an high-level API for authorization, on top of the <code>Authorizer</code>. It encodes granted privileges into the typesystem. For example,
for a request <code>GET /timetable/42</code>, the endpoint will ask from the <code>Authorizer</code> an <code>Authz&lt;Timetable, Read></code> object:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timetable_authz</span>: <span style=color:#000>Authz</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Timetable</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Read</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authorizer</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>authorize</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>42</span><span style=color:#000;font-weight:700>])</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>The authorizer does two things here:</p><ol><li>Checks that the privilege level of the user allows them to <code>Read</code> on the timetable ID#42.</li><li>Builds an <code>Authz</code> object that stores the ID#42 for later checks, which encodes in the type system that we have a <code>Read</code> authorization on <em>some</em> <code>Timetable</code> ressources.</li></ol><p>Then, after we <code>authorizer.commit();</code>, we can use the <code>Authz</code> to effectively request the timetable:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timetable</span>: <span style=color:#000>Timetable</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timetable_authz</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>retrieve</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>42</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>The <code>Authz</code> checks that the ID#42 is indeed authorized before forwarding the call the <code>modelv2::Retrieve::retrieve</code> function that performs the query.
However, if by mistake we wrote:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timetable</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timetable_authz</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>delete</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>42</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>we&rsquo;d get a compilation error such as <code>Trait AuthorizedDelete is not implemented for Authz&lt;Timetable, Read></code>, effectively preventing a privilege override statically.</p><p>On a more realistic example:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Scenario</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>remove</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>conn</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#000>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DatabaseConnection</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>scenario_authz</span>: <span style=color:#000>Authz</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#3465a4>Self</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Delete</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>study_authz</span>: <span style=color:#000>Authz</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Study</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Update</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic>// open transaction
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>scenario_authz</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>delete</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>id</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cs</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Study</span>::<span style=color:#000>changeset</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>last_update</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Datetime</span>::<span style=color:#000>now</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>study_authz</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>update</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>study_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cs</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87>Ok</span><span style=color:#000;font-weight:700>(())</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>This approach brings several advantages:</p><ul><li><strong>correctness</strong>: the compiler will prevent any privilege override for us</li><li><strong>readability</strong>: if a function requires some form of authorization, it will show in its prototype</li><li><strong>ease of writing</strong>: we can&rsquo;t write DB operations that ultimately wouldn&rsquo;t be authorized, avoiding a potential full rewrite once we notice the problem (and linting is on our side to show problems early)</li><li><strong>more declarative</strong>: if you want to read an object, you ask for a <code>Read</code> permission, the system is then responsible for checking the privilege level and map that to a set of allowed permissions. This way we abstract a little over the hierarchy of privileges a ressource can have.</li><li><strong>ease of refactoring</strong>: thanks rustc ;)</li><li><strong>flexibility</strong>: since the <code>Authz</code> has a reference to the <code>Authorizer</code>, the API mixes well with more dynamic contexts (should we need that in the future)</li><li><strong>migration</strong><ul><li>shouldn&rsquo;t be too complex or costly since the <code>Authz</code> wraps the <code>ModelV2</code> traits</li><li><em>will require changes in the same areas that would be impacted by a dynamic checker</em>, no more, no less (even in the dynamic context mentioned above we still need to pass the <code>Arc&lt;Authorizer></code> down the call stack)</li></ul></li><li><strong>contamination</strong>: admittedly, this API is slightly more contaminating than just passing an <code>Arc&lt;Authorizer></code> everywhere. However, this issue is mitigated on several fronts:<ul><li>most endpoints in editoast either access the DB in the endpoint function itself, or in at most one or two function calls deep. So the contamination likely won&rsquo;t spread far and the migration shouldn&rsquo;t take much more time.</li><li>if we notice that a DB call deep down the call stack requires an <code>Authz&lt;T, _></code> that we need to forward through many calls, it&rsquo;s probably pathological of a bad architecture</li></ul></li></ul><hr><p>The following sections explore how to use this API:</p><ul><li>to define authorized ressources</li><li>implement the effective privilege level logic</li><li>to deal with complex ressources (here <code>Study</code>) which need custom authorization rules and that are not atomic (the budgets follow different rules than the rest of the metadata)</li><li>to implement an endpoint that require different permissions (<code>create_scenario</code>)</li></ul><h5 id=actions>Actions</h5><p>We define all actions our <code>Authz</code> is able to expose at both type-level and at runtime (classic CRUD + Append for exploitation studies).</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>mod</span> <span style=color:#000>action</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Create</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Read</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Update</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Delete</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Append</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>Cruda</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>Create</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>Read</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>Update</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>Delete</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>Append</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>trait</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AuthorizedAction</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>as_cruda</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Cruda</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AuthorizedAction</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Create</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AuthorizedAction</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Read</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AuthorizedAction</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Update</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AuthorizedAction</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Delete</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AuthorizedAction</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Append</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>The motivation behind this is that at usage, we don&rsquo;t usually care about the privilege of a user over a ressource. We only care, if we&rsquo;re about to read a ressource, whether the user has a privilege level <strong>high enough</strong> to do so.</p><p>The proposed paradigm here is to ask the permission to to an <strong>action over a ressource</strong>, and let the ressource definition module decide (using its own effective privilege hierarchy) whether the action is authorized or not.</p><h5 id=standard-and-custom-effective-privileges>Standard and custom effective privileges</h5><p>We need to define the effective privilege level for each ressource. For most
ressources, a classic <code>Reader &lt; Writer &lt; Owner</code> is enough. So we expose that by default, leaving the choice to each ressource to provide their own.</p><p>We also define an enum providing the origin of a privilege, which is a useful
information for permission sharing.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// built-in the authorization system
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#[derive(PartialOrd, PartialEq)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>StandardPrivilegeLevel</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Read</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Write</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Own</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>StandardPrivilegeLevelOrigin</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// It&#39;s an explicit privilege
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>User</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// The implicit privilege comes from a group the user belongs to
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Group</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// The implicit privilege is granted publicly (authz_grant_xyz.subject IS NULL)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Public</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>trait</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PrivilegeLevel</span>: <span style=color:#204a87>PartialOrd</span> <span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>PartialEq</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Origin</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PrivilegeLevel</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StandardPrivilegeLevel</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Origin</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StandardPrivilegeLevelOrigin</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h5 id=grant-definition>Grant definition</h5><p>Then we need to associate to each grant in DB its effective privilege level and origin.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// struct AuthzGrantInfra is a struct that models the table authz_grant_infra
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EffectiveGrant</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AuthzGrantInfra</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>EffectivePrivilegeLevel</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StandardPrivilegeLevel</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>fetch_grants</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>conn</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#000>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DbConnection</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>subject</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#000>Subject</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>keys</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>GrantMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#3465a4>Self</span>::<span style=color:#000>EffectivePrivilegeLevel</span><span style=color:#ce5c00;font-weight:700>&gt;?</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>crate</span>::<span style=color:#000>tables</span>::<span style=color:#000>authz_grants_infra</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>filter</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>where <code>GrantMap&lt;PrivilegeLevel></code> is an internal representation of a collection of grants (implicit and explicit) with some privilege level hierarchy (custom or not).</p><h5 id=ressource-definition>Ressource definition</h5><p>Each ressource is then associated to a model and a grant type. We also declare which actions are allowed based on how we want the model to be used given the effective privilege of the ressource in DB.</p><p>The <code>RessourceType</code> is necessary for the dynamic context of the underlying <code>Authorizer</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Ressource</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Infra</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Grant</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AuthzGrantInfra</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>const</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TYPE</span>: <span style=color:#000>RessourceType</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RessourceType</span>::<span style=color:#000>Infra</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// Returns None is the action is prohibited
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>minimum_privilege_required</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>action</span>: <span style=color:#000>Cruda</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Option</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#3465a4>Self</span>::<span style=color:#000>Grant</span>::<span style=color:#000>EffectivePrivilegeLevel</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>use</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Cruda</span>::<span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>use</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StandardPrivilegeLevel</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lvl</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87>Some</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>match</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>action</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>Read</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lvl</span>::<span style=color:#000>Read</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>Create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Update</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Append</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lvl</span>::<span style=color:#000>Write</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>Delete</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lvl</span>::<span style=color:#000>Own</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>})</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>And that&rsquo;s it!</p><p>The rest of the mechanics are located within the authorization system.</p><h5 id=a-more-involved-example-studies>A more involved example: Studies</h5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>//////// Privilege levels
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>StudyPrivilegeLevel</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>ReadMetadata</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// a scenario of the study has been shared
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Read</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Append</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// can only create scenarios
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Write</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Own</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>StudyPrivilegeLevelOrigin</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>User</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Group</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Project</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// the implicit privilege comes from the user&#39;s grants on the study&#39;s project
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Public</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PrivilegeLevel</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StudyPrivilegeLevel</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Origin</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StudyPrivilegeLevelOrigin</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>///////// Effective grant retrieval
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>EffectiveGrant</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AuthzGrantStudy</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>EffectivePrivilegeLevel</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StudyrivilegeLevel</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>fetch_grants</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>conn</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#000>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>DbConnection</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>subject</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#000>Subject</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>keys</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>GrantMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#3465a4>Self</span>::<span style=color:#000>EffectivePrivilegeLevel</span><span style=color:#ce5c00;font-weight:700>&gt;?</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic>// We implement here the logic of implicit privileges where an owner
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#8f5902;font-style:italic>// of a project is also owner of all its studies
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>crate</span>::<span style=color:#000>tables</span>::<span style=color:#000>authz_grants_study</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>filter</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000;font-weight:700>.)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inner_join</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>crate</span>::<span style=color:#000>tables</span>::<span style=color:#000>study</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>on</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000;font-weight:700>.))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inner_join</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>crate</span>::<span style=color:#000>tables</span>::<span style=color:#000>project</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>on</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000;font-weight:700>.))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inner_join</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>crate</span>::<span style=color:#000>tables</span>::<span style=color:#000>authz_grants_project</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>on</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000;font-weight:700>.))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>//////// Authorized ressources
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/// Budgets of the study (can be read and updated by owners)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>StudyBudgets</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Ressource</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StudyBudgets</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Grant</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AuthzGrantStudy</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>const</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TYPE</span>: <span style=color:#000>RessourceType</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RessourceType</span>::<span style=color:#000>Study</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>minimum_privilege_required</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>action</span>: <span style=color:#000>Cruda</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Option</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>StudyPrivilegeLevel</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>use</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Cruda</span>::<span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>use</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StudyPrivilegeLevel</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lvl</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87>Some</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>match</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>action</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>Read</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Update</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lvl</span>::<span style=color:#000>Own</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>_</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>return</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>None</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>})</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/// Non-sensitive metadata available to users with privilege level MinimalMetadata (can only be read)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>StudyMetadata</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Ressource</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StudyMetadata</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Grant</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AuthzGrantStudy</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>const</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TYPE</span>: <span style=color:#000>RessourceType</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RessourceType</span>::<span style=color:#000>Study</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>minimum_privilege_required</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>action</span>: <span style=color:#000>Cruda</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Option</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>StudyPrivilegeLevel</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>use</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Cruda</span>::<span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>use</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StudyPrivilegeLevel</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lvl</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87>Some</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>match</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>action</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>Read</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lvl</span>::<span style=color:#000>ReadMetadata</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>_</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>return</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87>None</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>})</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/// A full study (can be created, read, updated, appended and deleted)
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Study</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#000;font-weight:700>.</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>impl</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Ressource</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Study</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Grant</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AuthzGrantStudy</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>const</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>TYPE</span>: <span style=color:#000>RessourceType</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RessourceType</span>::<span style=color:#000>Study</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>minimum_privilege_required</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>action</span>: <span style=color:#000>Cruda</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Option</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>StudyPrivilegeLevel</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>use</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Cruda</span>::<span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>use</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StudyPrivilegeLevel</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>as</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lvl</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87>Some</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>match</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>action</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>Read</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lvl</span>::<span style=color:#000>Read</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>Append</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lvl</span>::<span style=color:#000>Append</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>Create</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lvl</span>::<span style=color:#000>Create</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>Update</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lvl</span>::<span style=color:#000>Write</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#000>Delete</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lvl</span>::<span style=color:#000>Own</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000;font-weight:700>})</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h5 id=concrete-endpoint-definition>Concrete endpoint definition</h5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#[post(</span><span style=color:#4e9a06>&#34;/scenario&#34;</span><span style=color:#8f5902;font-style:italic>)]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>create_scenario</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>authorizer</span>: <span style=color:#000>Arc</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Authorizer</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>conn</span>: <span style=color:#000>DatabaseConnection</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>db_pool</span>: <span style=color:#000>web</span>::<span style=color:#000>Data</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>DatabasePool</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Json</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>form</span><span style=color:#000;font-weight:700>)</span>: <span style=color:#000>Json</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ScenarioCreateForm</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>path</span>: <span style=color:#000>Path</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>i64</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>authz</span>: <span style=color:#000>Authorizer</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#204a87>Result</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Response</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Error</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>db_pool</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>get</span><span style=color:#000;font-weight:700>().</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>project_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>study_id</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>path</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>into_inner</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ScenarioCreateForm</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>infra_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>timetable_id</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>..</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>form</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>authorizer</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>authorize_roles</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>BuiltinRoles</span>::<span style=color:#000>OperationalStudiesWrite</span><span style=color:#000;font-weight:700>]).</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authorizer</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>authorize</span>::<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Timetable</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Read</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>timetable_id</span><span style=color:#000;font-weight:700>]).</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>_</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authorizer</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>authorize</span>::<span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Infra</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Read</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>infra_id</span><span style=color:#000;font-weight:700>]).</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>study_authz</span>: <span style=color:#000>Authz</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Study</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Append</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>authorizer</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>authorize</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>study_id</span><span style=color:#000;font-weight:700>]).</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>authorizer</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>commit</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>response</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>transaction</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>move</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#000>conn</span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>let</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>scenario</span>: <span style=color:#000>Scenario</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>study_authz</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>mut</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>form</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>into</span><span style=color:#000;font-weight:700>()).</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>scenario</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>into_response</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>}).</span><span style=color:#204a87;font-weight:700>await</span><span style=color:#ce5c00;font-weight:700>?</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87>Ok</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>Json</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>response</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-7bd41c6c5ba86329c3d475a15fc8fc73>2.6 - Scalable async RPC</h1><p>TODO: create another document describing RPC interactions between core and editoast</p><h2 id=context-and-requirements>Context and requirements</h2><p>Without this proposal, editoast directly makes calls to core using http.
Using k8s, if multiple core workers are started, requests are randomly
distributed to core workers.</p><p>This architecture brings a number of issues:</p><ul><li>To respond to a request, the core worker need to hold the request&rsquo;s full infrastructure in memory.
Workers do not have enough memory to hold all infrastructures in memory.
Requests thus need to be routed to core workers specialized by infrastructure, which cannot be easily done using http.</li><li>If too many requests are dispatched to a busy core worker, they will just time out.</li><li>There is no easy way to scale up the number of workers to react to increased load.</li><li>Because calls need to complete within the timeout of the client&rsquo;s http requests,
the system falls appart when latency increases due to load.</li></ul><p>This proposal intends to address these issues by introducing an RPC system which:</p><ul><li>manages <a href=#worker-key>specialized</a> workers</li><li>automatically scales specialized workers</li></ul><h3 id=goals>Goals</h3><ul><li><code>high priority</code> the RPC protocol between editoast and core should be the same for development and production setups</li><li><code>high priority</code> requests are dispatched to specialized workers</li><li><code>high priority</code> the RPC system should be stateless and failure-resilient</li><li><code>low priority</code> the complexity of the local development setup should not increase</li></ul><h3 id=non-goals>Non-goals</h3><ul><li><code>not a goal</code> streaming events to the front-end</li><li><code>not a goal</code> reliable response processing</li><li><code>not a goal</code> caching</li></ul><h2 id=concepts>Concepts</h2><pre class=mermaid>flowchart TD
client
osrdyne
worker-pool
worker-group
worker-group-queue
worker


worker-pool -- contains --&gt; worker-group
worker-group -- contains and manages --&gt; worker
client -- pub --&gt; worker-group-queue
worker-group -- has a --&gt; worker-group-queue
worker -- sub --&gt; worker-group-queue
osrdyne -- manages --&gt; worker-pool
osrdyne -- manages --&gt; worker-group
osrdyne -- manages --&gt; worker-group-queue</pre><h3 id=client>Client</h3><p>Clients submit RPC <a href=#client-protocol>requests</a> to the message queue. RPC requests are published using AMQP 0.9.1.</p><p>For example, <code>editoast</code> would be a client.</p><h3 id=worker-key>Worker key</h3><p>Every submitted request includes a requested <code>worker-key</code>, as the message&rsquo;s <code>routing-key</code>.</p><p><strong>The key is what identifies which worker group will process the request</strong>.</p><p>Workers known their worker key at startup. All workers in a worker group have the same worker key.
It is an arbitrary utf-8 string set by the client, whose meaning is not defined by the RPC protocol:</p><ul><li>It could just be a way to have separate processing queues. In this case, workers may not care about what their is.</li><li>There could be an extra layer of protocol between client and worker about how the key is meant to be interpreted</li></ul><p>Here are some <strong>examples</strong> of how such protocols may work:</p><ul><li>it could be the identifier of a resource to act upon: <code>42</code></li><li>it could be the identifiers of multiple resources: <code>infra=42,timetable=24</code></li><li>it could even be, even though that&rsquo;s probably <strong>not a good idea</strong>, random worker settings:
<code>log_level=debug</code></li></ul><h3 id=worker-pools>Worker pools</h3><p>Worker pools are collections of workers of the same type, which can be specialized by key.
osrdyne creates an exchange for each worker pool, where clients can submit requests.</p><p>For example, <code>core</code> would be a worker pool.</p><h3 id=worker-group>Worker group</h3><p>Worker groups are collections of workers of the same pool and key, processing messages from the same queue.
<strong>Worker groups are responsible for scaling the number of workers depending on queue length and processing rate.</strong></p><p>Worker groups are managed by osrdyne. osrdyne should support multiple worker group drivers:</p><ul><li>a <a href=https://keda.sh>keda</a> k8s driver</li><li>a k8s autoscaler driver</li><li>a docker driver</li><li>a subprocess driver, where a single worker is started as a subprocess for each worker group</li><li>a systemd template unit driver</li><li>a noop driver, where workers have to be started manually</li></ul><p>For example, each <code>core</code> worker group handles a given infrastructure.</p><h3 id=worker>Worker</h3><p>A worker is a server processing requests from its worker group queue. Worker have a key.
For example, <code>core</code> workers are keyed by infrastructure.</p><h3 id=osrdyne>osrdyne</h3><ul><li>manages all exchanges, policies, queues and bindings</li><li>starts and stops worker groups as needed</li><li>generates error responses if the worker group fails to respond</li></ul><p>Each osrdyne instance manages a worker pool. See the <a href=#osrdyne-architecture>dedicated section</a>.</p><h2 id=rpc-protocol>RPC protocol</h2><h3 id=client-protocol>Client protocol</h3><p>Requests are submitted using AMQP 0.9.1&rsquo;s <code>basic.publish</code>:</p><table><thead><tr><th>AMQP field</th><th>semantics</th></tr></thead><tbody><tr><td><code>exchange</code></td><td><a href=#worker-pools>worker pool</a> identifier</td></tr><tr><td><code>routing-key</code></td><td><a href=#worker-key>requested key</a></td></tr><tr><td><code>correlation-id</code></td><td>an optional request id. The response will copy this field.</td></tr><tr><td><code>reply-to</code> property</td><td>optional response queue</td></tr><tr><td><code>mandatory</code></td><td><code>true</code> to ensure an error is returned if the message cannot be routed</td></tr></tbody></table><p>The body of the request will be dispatched to a worker of the requested pool and key.
The request is guaranteed to be dispatched <strong>at least once</strong></p><p>The response format is as follows:</p><table><thead><tr><th>AMQP field</th><th>semantics</th></tr></thead><tbody><tr><td><code>correlation-id</code></td><td>the correlation ID from the request</td></tr><tr><td><code>x-status</code> property</td><td>either <code>ok</code>, <a href=https://www.rabbitmq.com/docs/dlx#effects>or the reason for dead lettering</a>, taken from the request&rsquo;s <code>x-first-death-reason</code></td></tr><tr><td>body</td><td>optional response data</td></tr></tbody></table><h3 id=worker-protocol>Worker protocol</h3><p>When starting workers, the worker group driver provides:</p><table><thead><tr><th>Variable name</th><th>semantics</th></tr></thead><tbody><tr><td><code>WORKER_ID</code></td><td>a unique identifier for this worker</td></tr><tr><td><code>WORKER_KEY</code></td><td>the <a href=#worker-key>worker key</a></td></tr><tr><td><code>WORKER_POOL</code></td><td>the name of the worker pool</td></tr><tr><td><code>WORKER_REQUESTS_QUEUE</code></td><td>the queue to consume work from</td></tr><tr><td><code>WORKER_ACTIVITY_EXCHANGE</code></td><td>the exchange to publish events to</td></tr></tbody></table><p>Workers then have to:</p><ul><li>publish a <code>started</code> <a href=#worker-activity-reports>activity report message</a></li><li>subcribe to <code>WORKER_REQUESTS_QUEUE</code> using <code>basic.consume</code></li><li>for each request message:<ul><li>publish a <code>request-received</code> <a href=#worker-activity-reports>activity report message</a></li><li>if the worker cannot process the request, it can request a requeue using <code>basic.reject</code> with <code>requeue=true</code></li><li>build and publish a response to the <a href=https://www.rabbitmq.com/tutorials/amqp-concepts#exchange-default>default exchange</a></li><li><code>basic.ack</code> the request</li></ul></li></ul><h4 id=worker-response-protocol>Worker response protocol</h4><p>Responses are submitted using AMQP 0.9.1&rsquo;s <code>basic.publish</code>:</p><table><thead><tr><th>AMQP field</th><th>semantics</th></tr></thead><tbody><tr><td><code>exchange</code></td><td><a href=#worker-pools>worker pool</a> identifier</td></tr><tr><td><code>routing-key</code></td><td><a href=#worker-key>requested key</a></td></tr><tr><td><code>reply-to</code> property</td><td>optional response queue</td></tr></tbody></table><h4 id=worker-activity-reports>Worker activity reports</h4><p>Workers report the following activity events:</p><ul><li><code>started</code>: the worker is about to start processing requests</li><li><code>request-received</code>: a request was received</li></ul><table><thead><tr><th>AMQP field</th><th>value</th></tr></thead><tbody><tr><td><code>exchange</code></td><td><code>WORKER_ACTIVITY_EXCHANGE</code></td></tr><tr><td><code>routing-key</code></td><td><code>WORKER_KEY</code></td></tr><tr><td><code>x-event</code> property</td><td>the event type</td></tr></tbody></table><h2 id=message-passing-architecture>Message passing architecture</h2><p><img src=message-passing-architecture.svg alt="Message passing architecture"></p><p>For a full reference of all exchanges and queues, see the <a href=#exchange-and-queues>exchanges and queues</a> section</p><h2 id=message-lifetime>Message lifetime</h2><pre class=mermaid>flowchart TD
received
processed

received --&gt; requests
received -- alternate exchange --&gt; orphans
orphans -- controller starts worker group --&gt; requests
requests -- dead letter --&gt; dlx
dlx -- controller generates error --&gt; processed
requests -- worker responds --&gt; processed</pre><h2 id=service-architecture>Service architecture</h2><pre class=mermaid>flowchart TD

client

subgraph RPC layer
rabbitmq[RabbitMQ]
osrdyne[osrdyne]
end

subgraph worker-group[worker group]
worker
end

client -- enqueues --&gt; rabbitmq
osrdyne -- sub orphan messages --&gt; rabbitmq
osrdyne -- manages queues --&gt; rabbitmq
osrdyne -- starts and stops --&gt; worker-group
osrdyne -- sub activity events --&gt; rabbitmq
worker -- sub requests --&gt; rabbitmq
worker -- pub responses --&gt; rabbitmq
worker -- pub activity events --&gt; rabbitmq</pre><ul><li><code>osrdyne</code> stops and starts worker groups following demand</li><li><code>worker</code> processes requests dequeued from rabbitmq</li></ul><h2 id=life-of-an-rpc-call>Life of an RPC call</h2><p>In this example:</p><ul><li><code>editoast</code> is the client</li><li>it makes a request to the <code>core</code> worker pool</li><li>the <code>core</code> worker pool is keyed on infrastructures</li></ul><h3 id=fast-path>Fast path</h3><ul><li>Editoast publishes a request message to <code>exchange=core</code> with <code>routing_key=42</code>. If the message expects a reply, <code>reply-to</code> is set.</li><li>If the <code>core</code> exchange already has binding for worker group <code>42</code>, a worker picks up the request</li><li>The worker processes the request, and uses the <code>reply-to</code> field to submit a response.</li><li>The worker ACKs the request.</li></ul><h3 id=worker-group-startup>Worker group startup</h3><p>These steps only occur if the worker group / queue has not yet started:</p><ul><li>If there is no queue bound to routing key <code>42</code>, the message is routed to the <code>core-orphan-xchg</code> exchange.
This exchange is a fanout exchange with a single queue, where <code>osrdyne</code> processes messages.</li><li><code>osrdyne</code> processes the message:<ul><li>creates queue <code>core-req-42</code>, binds it to the <code>core</code> exchange on routing key <code>42</code></li><li>forward the message to exchange <code>core</code></li><li>ACK the original message once the original is forwarded</li><li>start worker group <code>core</code> key <code>42</code></li></ul></li><li>the worker group starts up and processes the request</li></ul><h2 id=osrdyne-architecture>osrdyne architecture</h2><pre class=mermaid>flowchart TD


%% inputs
activity-queue([activity queue])
orphan-queue([orphan queue])
dead-letter-queue([dead letter queue])
rabbitmq-api[RabbitMQ HTTP API]

%% components
orphan-processor[orphan processor]
dead-letter-responder[dead letter responder]

subgraph pool manager
pool-state-tracker[pool state tracker]
wgs-control-loop[worker groups control loop]
req-queues-control-loop[request queues control loop]
end
wg-driver[worker group driver]

%% outputs
request-xchg([request exchange])
poison-inventory([poison request inventory])
response([response queue])


%% relations

dead-letter-queue -- sub --&gt; dead-letter-responder --&gt; response &amp; poison-inventory
orphan-queue -- sub --&gt; orphan-processor -- forward --&gt; request-xchg
orphan-processor -- request worker group start --&gt; pool-state-tracker
orphan-processor -- wait for execution --&gt; req-queues-control-loop
rabbitmq-api -- initial queue list --&gt; pool-state-tracker
activity-queue -- worker activity --&gt; pool-state-tracker
pool-state-tracker -- expected state --&gt; wgs-control-loop &amp; req-queues-control-loop
wgs-control-loop -- start / stop --&gt; wg-driver</pre><ul><li><p>the <strong>pool manager</strong> is the most complex component of osrdyne. It is in charge of creating,
deleting request queues, and deciding which worker groups should be running at any given time. To make such decisions, it needs:</p><ul><li>the ability to list existing queues at startup, which is done using the RabbitMQ HTTP API</li><li>worker activity events, to know which queues are active</li><li>queue creation commands from the orphan processor</li></ul><p>The pool manager runs two control loops:</p><ul><li>the <strong>worker groups control loop</strong> starts and stops worker groups using the <strong>worker group driver</strong></li><li>the <strong>request queues control loop</strong> creates and deletes request queues</li></ul></li><li><p>the <strong>orphan processor</strong> reacts to orphan messages by sending worker group start commands to the worker group manager</p></li><li><p>the <strong>dead letter responder</strong>:</p><ul><li>responds errors to dead lettered messages following the <a href=#worker-protocol>worker protocol</a></li><li>if a message is deemed to have caused repeated worker crashes, publish to the poison inventory</li></ul></li></ul><p>On worker pool startup:</p><ul><li>create and bind all <a href=#exchanges-and-queues>exchanges and queues</a></li><li>configure the TTL, delivery timeout and delivery limit policies using the HTTP API</li><li>start the <strong>orphan processsor</strong>, <strong>dead letter responder</strong> and <strong>worker group manager</strong></li></ul><h3 id=exchanges-and-queues>Exchanges and queues</h3><p>osrdyne creates a number of exchanges and queues. Most of the setup is done
per worker pool, except for worker group request queues.</p><p>Worker pool exchanges:</p><ul><li>pool requests exchange <code>{pool}-req-xchg</code>, type <code>direct</code>:<ul><li>alternate exchange is <code>{pool}-orphan-xchg</code></li><li>dead letter exchange is <code>{pool}-dl-xchg</code></li><li>worker group request queues are bound to this exchange</li></ul></li><li>orphan exchange <code>{pool}-orphan-xchg</code>, type <code>fanout</code></li><li>dead letter exchange <code>{pool}-dl-xchg</code>, type <code>fanout</code></li><li>activity queue <code>{pool}-activity-xchg</code>, type <code>fanout</code></li></ul><p>Worker pool queues:</p><ul><li>dead letter queue <code>{pool}-dl</code>, bound to <code>{pool}-dl-xchg</code> (<strong>exclusive</strong>)</li><li>orphan queue <code>{pool}-orphan</code>, bound to <code>{pool}-orphan-xchg</code> (<strong>exclusive</strong>)</li><li>worker activity queue <code>{pool}-activity</code>, bound to <code>{pool}-activity-xchg</code></li><li>poison queue <code>{pool}-poison</code>. Used to collect messages which could not be processed, supposedly due to worker crash</li></ul><p>Worker group queues:</p><ul><li>request queue <code>{pool}-req-{key}</code>, bound by key to <code>{pool}-req-xchg</code></li></ul><h3 id=worker-group-manager>Worker group manager</h3><p>The worker group manager has three internal components:</p><ul><li>the <strong>pool state tracker</strong> tracks the expected status of worker groups</li><li>the <strong>request queues control loop</strong> applies changes to worker group request queues</li><li>the <strong>worker groups control loop</strong> applies changes to worker groups</li></ul><p>The state tracker assigns a 64 bit generation identifier to each expected state.
The two control loops report the last synchronized state.</p><p>When the orphan processor wants to start a worker group, it has to:</p><ul><li>tell the <strong>state tracker</strong>, which gives a generation identifier for the new expected state</li><li>wait until the <strong>request queue control loop</strong> has caught up to this generation <strong>and</strong> has
created the queue (which may be delayed due to networking issues)</li></ul><h4 id=pool-state-tracker>Pool state tracker</h4><pre class=mermaid>stateDiagram-v2
Inactive --&gt; Active: received request
Active --&gt; Unbound: unbind delay elapsed
Unbound --&gt; Inactive: stop delay elapsed
Unbound --&gt; Active: received request</pre><p>Two time constants govern how the expected state of worker groups evolves:</p><ul><li><code>UNBIND_DELAY</code> delay until the queue transitions from <code>Active</code> to <code>Unbound</code></li><li><code>STOP_DELAY</code> delay until the worker group is stopped</li></ul><p>The state tracker has the following API:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>WGStatus</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Active</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Unbound</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Generation</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>u64</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>PoolState</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>generation</span>: <span style=color:#000>Generation</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>wgs</span>: <span style=color:#000>im</span>::<span style=color:#000>OrdMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>WGStatus</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>trait</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PoolStateTracker</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>initial_worker_groups</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>String</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Self</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// Require some worker group to be active. The extra lifetime adds active duration compared to the configured spooldown schedule.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// This allows the worker activity processor to debounce activity events without lowering the active time of worker groups.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// Returns the state generation where this worker group starts being active.
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>require_worker_group</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>key</span>: <span style=color:#204a87;font-weight:700>&amp;</span><span style=color:#204a87;font-weight:700>str</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>extra_lifetime</span>: <span style=color:#000>Duration</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Generation</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/// Subscribe to a stream of target pool state updates
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>async</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>subscribe</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>tokio</span>::<span style=color:#000>sync</span>::<span style=color:#000>watch</span>::<span style=color:#000>Receiver</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PoolState</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=request-queues-control-loop>Request queues control loop</h3><p>The request queue control loop takes care of creating, binding, unbinding and stopping request queues.
It subscribes to the pool state tracker, and reacts to state changes.</p><p>It exposes the following API, which is used by the orphan processor to wait for updates to propagate:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ReqQueueStatus</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>expected</span>: <span style=color:#204a87>Option</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>WGStatus</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>actual</span>: <span style=color:#204a87>Option</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>WGStatus</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>ReqQueuesState</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>generation</span>: <span style=color:#000>Generation</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>queues</span>: <span style=color:#000>im</span>::<span style=color:#000>OrdMap</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#204a87>String</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ReqQueueStatus</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>trait</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RequestQueueControlLoop</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>new</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>target</span>: <span style=color:#000>tokio</span>::<span style=color:#000>sync</span>::<span style=color:#000>watch</span>::<span style=color:#000>Receiver</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>PoolState</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>Self</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>subscribe</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#3465a4>self</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>tokio</span>::<span style=color:#000>sync</span>::<span style=color:#000>watch</span>::<span style=color:#000>Receiver</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>ReqQueuesState</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>it runs the following control loop:</p><ul><li>fetch the set of <code>current</code>ly active request queues</li><li>control loop:<ul><li>for each queue in <code>expected</code> and not in <code>current</code>:<ul><li>attempt to create the queue</li><li>if successful, update the current set</li></ul></li><li>for each queue in <code>current</code> and not in <code>expected</code>:<ul><li>attempt to remove the queue, if empty and unused</li><li>if successful, update the current set</li></ul></li><li>for each waiting orphan processor, release if the condition is met</li></ul></li></ul><p>The control loop runs when <code>current</code> != <code>expected</code>, or when <code>expected</code> changes.</p><h3 id=worker-groups-control-loop>Worker groups control loop</h3><p>osrdyne is responsible for starting and stopping worker groups following demand.
<strong>It it NOT responsible for scaling the number of workers per worker group</strong>.</p><p>osrdyne runs the following control loop:</p><ul><li>receive the set of <code>expected</code> worker groups from the <strong>pool state tracker</strong></li><li>build the set of <code>running</code> worker groups: query running worker groups from the <strong>worker group driver</strong>. If this fails, log and continue to the next iteration of the control loop.</li><li>make both sets converge:<ul><li>for each worker group in <code>expected</code> and not in <code>running</code>:<ul><li>use the docker / kubernetes API to start the worker group. This must be idempotent. <strong>do not retry</strong> <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></li></ul></li><li>for each worker group in <code>running</code> and not in <code>expected</code>:<ul><li>use the docker / kubernetes API to attemps to stop the worker group. This must be idempotent. <strong>do not retry</strong> <sup id=fnref1:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></li></ul></li></ul></li></ul><h3 id=worker-activity-processor>Worker activity processor</h3><p>As the number of worker activity events could be very high, we may not want to forward all of these to the pool state tracker:
if multiple messages are received within a short time span, only the first one is relevant. A separate actor can be used to receive
and dedup activity messages, and forward a low bandwidth summary to the pool state tracker.</p><h2 id=failure-mode-analysis>Failure mode analysis</h2><h3 id=the-worker-fails-to-parse-a-message>The worker fails to parse a message</h3><p>This is an application layer error:
the worker must respond, and indicate that something went wrong</p><h3 id=the-worker-dies-or-stalls-when-processing-a-message>The worker dies or stalls when processing a message</h3><p>RabbitMQ will wait until the message TTL expires, and re-queues it.
A limit must be set on the number of times a message can be re-queued using a <a href=https://www.rabbitmq.com/docs/quorum-queues#poison-message-handling><code>delivery-limit</code></a>.
When this limit is reached, the poison message is sent to the dead letter exchange, and the client times out.</p><h3 id=osrdyne-fails-to-start>osrdyne fails to start</h3><ul><li>If exchanges are not setup, the client cannot publish messages</li><li>If the appropriate work group is operational, the <a href=#fast-path>fast path</a> can proceed</li><li>Otherwise, requests pile up in the orphan queue, and the client ends up timing out</li></ul><h3 id=invalid-worker-key>Invalid worker key</h3><p>Because the key is an arbitrary string set by the client, it has to be processed carefully:</p><ul><li>the format is defined as a convention between the client and workers. If the format isn&rsquo;t right,
it is up to the worker to publish a response to the client.</li><li>key validity conditions is also up to the worker: if the key is supposed to be some
object ID, but the object does not exist, the worker needs to start up and respond</li></ul><p><strong>Even if the key does not conform to the convention established between the client and the
worker, the worker needs to start and respond to all requests.</strong></p><h3 id=workers-fails-to-start>Workers fails to start</h3><p><strong>A <a href=https://www.rabbitmq.com/blog/2014/01/23/preventing-unbounded-buffers-with-rabbitmq#per-queue-message-ttl>per-queue message TTL</a>
should be set to avoid requests accumulating indefinitly.</strong></p><p>Workers failing to start will cause:</p><ul><li>messages to accumulate in the queue.</li><li>when message TTL is reached, it will get transfered to the dead letter queue</li><li>the client will time out awaiting a response</li></ul><h3 id=multiple-ordyne-daemons-are-started-on-the-same-pool>Multiple ordyne daemons are started on the same pool</h3><p>It shouldn&rsquo;t be an issue, as:</p><ul><li>all operations done on startup are idempotent</li><li>before doing anything, the daemon has to start listening as an <strong>exclusive consumer of the dead letter and orphan queues</strong></li></ul><h2 id=known-limitations>Known limitations</h2><h3 id=latency-publisher-confirms-and-reliability>Latency, publisher confirms and reliability</h3><p>Without publisher confirms, networker or broken failure can result in message loss.
However, publisher confirms add quite a bit of latency (about 200ms), as it ensures messages are persisted to disk if the queue is durable.</p><p><strong>We should use publisher confirms for responses and orphan transfers, and leave the decision of whether to do it for requests to the client.</strong></p><h3 id=at-least-once-semantics>At least once semantics</h3><p>Most things in this protocol have at least once semantics if publisher confirms are used:</p><ul><li><code>request delivery to workers</code>: if osrdyne is restarted while transfering an orphan to its destination, the orphan may be transfered twice</li><li><code>response delivery to clients</code>: if a worker takes slightly too long to ACK a message, but still responds, it may be requeued and re-processed, and thus responded to twice</li></ul><h2 id=design-decisions>Design decisions</h2><h3 id=using-rabbitmq>Using RabbitMQ</h3><p>To implement this solution, we rely on a combination of <a href=https://www.rabbitmq.com/docs/extensions>features unique to RabbitMQ</a>:</p><ul><li>each worker type needs a separate <strong>exchange</strong> and configuration</li><li>when a message cannot be routed within a worker type&rsquo;s exchange, it is redirected to an <strong>alternate exchange</strong> managed by the worker manager</li><li><strong>dead lettering</strong> is leveraged to generate protocol errors</li><li>the worker manager uses the <strong>RabbitMQ HTTP API</strong> to list queues</li></ul><p>In addition to its attractive feature set, RabbitMQ has:</p><ul><li>various useful quality of life features, such as direct reply and per-message TTL</li><li>long demonstrated its <strong>reliability</strong></li><li>multiple engineers on staff <strong>experience</strong>d with the tool</li></ul><h3 id=queues-are-created-by-osrdyne>Queues are created by osrdyne</h3><p>At some point, we explored the possibility of RPC clients creating queues.
osrdyne would react to queue creation by starting workers. If the
queue were to be unused for a while, osrdyne would stop workers and
delete the queue.</p><p>This creates a race condition on queue deletion:</p><ul><li>osrdyne sees that the queue is empty</li><li>the client ensures the queue is created</li><li>osrdyne deletes the queue</li><li>the client attempts to publish a message to the now deleted queue</li></ul><p>We thus decided to move the responsibility of queue management to the
osrdyne, and implement a mechanism to ensure messages cannot be
dropped due to a missing queue.</p><h3 id=osrdyne-republishes-orphan-messages>osrdyne republishes orphan messages</h3><p>Initially, we though of a solution whereby osrdyne&rsquo;s orphan processor uses <a href=https://www.rabbitmq.com/docs/dlx>dead lettering</a>
to send messages back to their original exchange. This is in fact a bad idea, as dead lettering <a href=https://www.rabbitmq.com/docs/dlx#effects>inhibits per message TTL</a>.</p><p>Instead, the orphan processor has to proxy messages back to their original exchange.
<strong>This proxying process can cause requests to get delivered multiple times to the target queue</strong>.</p><h3 id=osrdyne-responds-to-dead-lettered-messages>osrdyne responds to dead lettered messages</h3><p>If a message is dead lettered for some reason (expired TTL, delivery limit, max queue length),
we figured it would be best to give the client some idea that something went wrong.</p><p>The <a href=#worker-protocol>worker protocol</a> thus has to allow the client to distinguish protocol errors from worker responses.</p><h3 id=messages-are-only-acked-by-workers-once-processed>Messages are only ACKed by workers once processed</h3><p>If messages are ACKed on reception:</p><ul><li>processing time is not limited by message timeout (which is arguably not a feature)</li><li>the broker does not attempt re-delivery if the worker were to stop and not respond for some reason</li></ul><p>If messages are ACKed once processed:</p><ul><li>messages whose processing time exceeds TTL will be re-queued, even if the worker is still processing the message. <strong>This can result in multiple responses being delivered</strong>.</li><li>if the worker crashes or is stopped, the message will be re-queued</li></ul><p>We decided to rely on a <a href=https://www.rabbitmq.com/docs/quorum-queues#poison-message-handling><code>delivery-limit</code> policy</a> to handle poison messages, and ACK messages once processed.</p><h3 id=report-worker-activity-using-amqp>Report worker activity using AMQP</h3><p>osrdyne needs to maintain queue usage statistics in order to know when worker groups can be stopped.
At first, we considered having workers use redis to store the timestamp of the last processed message for the queue.
We decided against it as:</p><ul><li>it would mean the workers store a timestamp directly in database, read by a supervisor process. it&rsquo;s a pretty bad design</li><li>it adds an additional database to the RPC architecture, for little to no benefit compared to just using rabbitmq</li><li>if one of the workers has its clock drift by more than the worker group expiration time compared to osrdyne, the worker group will get stopped</li><li>any worker can get the pool deleted by forcing the timestamp to an old value</li><li>it adds a failure mode: if osrdyne / workers are unable to reach redis, weird bugs may ensue</li></ul><p>Instead, we decided to require worker to publish activity updates to a dedicated queue.
This queue can be watched by osrdyne, which can use these events to know when to stop a worker group.</p><h3 id=make-worker-group-lifetime-decisions-in-a-separate-actor>Make worker group lifetime decisions in a separate actor</h3><p>The lifetime of worker groups is influenced by three types of asynchronous events:</p><ul><li>worker activity</li><li>orphan requests</li><li>worker group spooldown deadlines</li></ul><p>When the orphan processor gets a request, it needs to create the worker group&rsquo;s request
queue before it can proceed to forward the message.</p><p>If queues were created and deleted asynchronously when these events are received, it would introduce a race condition:</p><ul><li>the orphan processor creates the queue</li><li>the queue gets deleted because it expired at the same time</li><li>the orphan processor forwards the message, which gets lost</li></ul><p>We found multiple solutions for this issue:</p><ul><li>process all asynchronous events in a single actor. This was not deemed viable because worker activity processing is work intensive, and orphan request processing is latency sensitive.</li><li>having a single actor create and delete queues (the <a href=#request-queues-control-loop><strong>request queues control loop</strong></a>) and making the orphan processor wait until the control loop creates the queue</li></ul><h3 id=unbind-the-queue-and-wait-before-stopping-workers>Unbind the queue and wait before stopping workers</h3><p>In a previous design, we tried to delete work queue in one go. It created a race condition issue on queue deletion,
caused by the fact ordyne does not get direct notifications of when messages are received on a work queue:</p><ul><li>we decide to stop the worker group</li><li>work is received on the queue, but we aren&rsquo;t made aware as no worker is up</li><li>we try to delete the queue, but cannot do so without loosing messages</li></ul><p>We could think of two fixes for this issue:</p><ul><li>implement a two stage shutdown, where no work can get to the queue for a while before workers are stopped</li><li>detect that the queue still has messages after workers have stopped, and start workers back up</li></ul><p>We decided to implement two stage worker group shutdown:</p><ul><li>if no activity is register for <code>UNBIND_DELAY</code>, unbind the work queue</li><li>wait for a while to see if any worker picks up work from the queue and notifies osrdyne, which would rebind the queue</li><li>if no orphan nor worker activity is registered for <code>STOP_DELAY</code>, stop workers and delete the queue</li></ul><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>The control loop is designed to make the state of all worker groups converge at once.
Retrying convergence for one worker group adds latency to convergence for all worker groups.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-end text-xs-center order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/osrd-project/osrd aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2"><span>&copy; 2024 OSRD contributors. All Rights Reserved</span></div></div></div></footer></div><style>.markmap>svg{width:100%;height:300px}</style><script>window.markmap={autoLoader:{manual:!0,onReady(){const{autoLoader:e,builtInPlugins:t}=window.markmap;e.transformPlugins=t.filter(e=>e.name!=="prism")}}}</script><script src=https://cdn.jsdelivr.net/npm/markmap-autoloader></script><script src=https://cdn.jsdelivr.net/npm/mermaid@9.3.0/dist/mermaid.min.js integrity="sha512-ku2nmBrzAXY5YwohzTqLYH1/lvyMrpTVxgQKrvTabd/b/uesqltLORdmpVapYv6QhZVCLUX6wkvFaKOAY4xpUA==" crossorigin=anonymous></script><script src=/js/main.min.4261519102c0270f3bdd4edcd2b45867ee7a584a0ea82c94f59e4f991c6337a1.js integrity="sha256-QmFRkQLAJw873U7c0rRYZ+56WEoOqCyU9Z5PmRxjN6E=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.f724d3de49218995223b7316aa2e53e2b34bf42026bf399ebb21bb02212402d1.js integrity="sha256-9yTT3kkhiZUiO3MWqi5T4rNL9CAmvzmeuyG7AiEkAtE=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>