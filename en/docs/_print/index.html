<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.100.2"><link rel=canonical type=text/html href=https://osrd.fr/en/docs/><link rel=alternate type=application/rss+xml href=https://osrd.fr/en/docs/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>Documentation | OSRD</title><meta name=description content="Whether you would like to use OSRD, understand it or contribute, this is the right place!
"><meta property="og:title" content="Documentation"><meta property="og:description" content="Open Source Railway Designer"><meta property="og:type" content="website"><meta property="og:url" content="https://osrd.fr/en/docs/"><meta property="og:image" content="https://osrd.fr/en/docs/_print/featured-background.jpg"><meta property="og:site_name" content="OSRD"><meta itemprop=name content="Documentation"><meta itemprop=description content="Open Source Railway Designer"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://osrd.fr/en/docs/_print/featured-background.jpg"><meta name=twitter:title content="Documentation"><meta name=twitter:description content="Open Source Railway Designer"><link rel=preload href=/scss/main.min.2630e74a757979ae8749757fe871a2cda0da39b3bb48e31e858fd5b3e754a6f7.css as=style><link href=/scss/main.min.2630e74a757979ae8749757fe871a2cda0da39b3bb48e31e858fd5b3e754a6f7.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.6.0.min.js integrity=sha384-vtXRMe3mGCbOeY7l30aIg8H9p3GdeSe4IFlP6G8JMa7o7lXvnz3GFKzPxzJdPfGK crossorigin=anonymous></script>
<script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/en/><span class=navbar-logo><svg xmlns="http://www.w3.org/2000/svg" id="svg35" width="110.674" height="22"><style id="style1">.st9{fill:#fff}</style><g id="ok" transform="translate(-14.662 -25.176) scale(.12964)"><g id="g29"><path id="path23" d="M170.1 317.5c-2.9 12-4.3 25.1-4.3 39.2v7.2h24.5c-4.2-19.6-11.5-34.7-20.2-46.4z" class="st9"/><path id="path24" d="M113.1 279.2v29.4c4.5 1.7 9.3 3.9 14 6.8 12.6 7.8 22.2 18.6 28.6 32.3v-45.8c-5.1-4.5-10.2-8.1-15.2-11.1-9.5-5.6-19-9.2-27.4-11.6z" class="st9"/><path id="path25" d="M165.7 297.5c6.3-16.6 15.7-31.1 28-43.4v-59.9h-28z" class="st9"/><path id="path26" d="M173.5 305.6c7.8 9.1 14.9 20.5 20.3 34.5v-71.2c-8.9 10.7-15.7 22.9-20.3 36.7z" class="st9"/><path id="path27" d="M261.9 194.2h-58.1v51c17.4-13.8 36.5-21.4 52.5-25.5 2.7-.7 5.4.9 6.1 3.6.7 2.7-.9 5.3-3.6 6-16.8 4.3-37.4 12.8-55.1 29.1v46.9c4.3-9.2 9.9-17.4 16.8-24.3 13.9-13.8 31.1-20.9 45-24.5 2.7-.7 5.4.9 6.1 3.6.7 2.7-.9 5.4-3.6 6-7 1.8-14.9 4.6-22.7 8.8-28 15.2-41.6 42-41.6 81.7v7.2h58.1c11.5.0 20.8-9.3 20.8-20.8V215c.1-11.5-9.2-20.8-20.7-20.8z" class="st9"/><path id="path28" d="M145.7 282.3c3.3 2 6.7 4.2 10.1 6.8v-94.8H134c-11.5.0-20.8 9.3-20.8 20.8v53.8c9.6 2.4 21 6.5 32.5 13.4z" class="st9"/><path id="path29" d="M121.1 323.5c-2.7-1.6-5.4-2.9-8-4.1V343c0 11.5 9.3 20.8 20.8 20.8h17.2c-5.4-18.1-15.4-31.6-30-40.3z" class="st9"/></g><g id="g30"><path id="path30" d="M411.2 355.3c-45.6.0-79.4-31.3-79.4-77.5.0-46.8 33.8-76.3 79.4-76.3 45.8.0 79.6 29.5 79.6 76.3.0 46.2-33.8 77.5-79.6 77.5zm0-122.1c-24.7.0-41.7 19-41.7 44.5.0 26.4 17.1 45.4 41.7 45.4s41.9-19 41.9-45.4c-.1-25.5-17.2-44.5-41.9-44.5z" class="st9"/></g><g id="g32"><g id="g31"><path id="path31" d="M607.3 243.3c-6-7.6-16.9-12.6-26-12.6s-20.4 3.1-20.4 14.6c0 9.7 8.7 12.8 22.5 17.1 19.8 6.4 45.4 14.8 45.4 43.9.0 33.6-27 48.7-55.9 48.7-20.8.0-41.9-7.6-54.6-21l23.1-23.5c7 8.9 20 15.5 31.5 15.5 10.7.0 20.2-4.1 20.2-15.9.0-11.1-11.1-14.6-30.3-20.8-18.6-6-37.3-15.5-37.3-41.9.0-32.4 29.3-45.8 56.5-45.8 16.5.0 35.1 6.2 47.8 17.9z" class="st9"/></g></g><g id="g34"><g id="g33"><path id="path32" d="m753.3 351.4-31.5-57.9h-12v57.9h-34.6v-146h55.7c28 0 55.9 10.7 55.9 44.1.0 19.6-11.5 33.6-30.3 39.4l38.1 62.5zm-25-117.5h-18.8v34h16.7c11.3.0 25.6-2.9 25.6-17.7.0-13.7-13-16.3-23.5-16.3z" class="st9"/></g></g><g id="g35"><path id="path34" d="M884.9 351.4h-54.4v-146h52.8c41.4.0 83.5 17.3 83.5 72.6-.1 51.3-41.7 73.4-81.9 73.4zm-2.5-115.9h-17.5v85.4h16.7c25.2.0 48.5-10.3 48.5-42.9-.1-32.8-23.4-42.5-47.7-42.5z" class="st9"/></g></g></svg></span><span class=font-weight-bold>OSRD</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/en/about/><span>About</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/en/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/en/blog/><span>Blog</span></a></li><li class="nav-item dropdown mr-4 d-none d-lg-block"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>English</a><div class=dropdown-menu aria-labelledby=navbarDropdownMenuLink><a class=dropdown-item href=/fr/docs/>Français</a></div></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=/offline-search-index.47ff26c1ac2e033057dcefaeadf1f532.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This is the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=/en/docs/>Return to the regular view of this page</a>.</p></div><h1 class=title>Documentation</h1><ul><li>1: <a href=#pg-efa24ea182f6b96c6de2891c1787e164>Tutorials</a></li><ul></ul><li>2: <a href=#pg-0f647dfa795c2a3848006b8409f95352>Explanations</a></li><ul><li>2.1: <a href=#pg-a151e2a634dc5820b05191ae97d90e14>Models</a></li><ul><li>2.1.1: <a href=#pg-f205938bbebab94d2a57f42f781e4fb1>Infrastructure example</a></li><li>2.1.2: <a href=#pg-d8a9003e9780b0213913d2b62364ed28>Neutral Sections</a></li></ul><li>2.2: <a href=#pg-d0b32c1c59097b608e257ee86e580a19>Running time calculation</a></li><ul><li>2.2.1: <a href=#pg-0fa7914af29cb313adb8b16f8dc2bcc0>Physical modeling</a></li><li>2.2.2: <a href=#pg-ea6d32407559a3426f098dbe1408c955>Numerical integration</a></li><li>2.2.3: <a href=#pg-4ea0de1a5a62574096209d692bf76d42>Envelopes system</a></li><li>2.2.4: <a href=#pg-8a7d650e7008d319d63327b9d7bb4ff5>Pipeline</a></li><li>2.2.5: <a href=#pg-1e84eea96c6b439c99ded337aa3be95b>Allowances</a></li></ul></ul><li>3: <a href=#pg-f94607d1fa8cd3ff18c7a975b41a1e82>How-to Guides</a></li><ul><li>3.1: <a href=#pg-3ce54efed8813f1db94e060b5c4d3dba>Contribute to OSRD</a></li><ul><li>3.1.1: <a href=#pg-447ef90d37a1cd8a734c648d8c6dfc8e>Report issues</a></li><li>3.1.2: <a href=#pg-6b7c59f2efb6c7b3add25b04a63e3942>Contribute code</a></li><li>3.1.3: <a href=#pg-6a4bbd8a33a31373a2271e2003cd8d5f>Style guide</a></li><ul><li>3.1.3.1: <a href=#pg-d807e8178df334af7c93ed0e4b021fdd>Back-end</a></li><li>3.1.3.2: <a href=#pg-53dd3533e7509ff0ea0773799bcd2e23>Front-end</a></li><li>3.1.3.3: <a href=#pg-c279934946faaf1b9c53231507b4a433>Tests</a></li></ul><li>3.1.4: <a href=#pg-dd4202c260f5c017918a0012ac43efba>Review code</a></li></ul></ul><li>4: <a href=#pg-eb3604af7a44b351ff5c384e457c40c6>Technical reference</a></li><ul><li>4.1: <a href=#pg-956c746a8215379d75cfcf5474a683e3>Architecture</a></li><ul><li>4.1.1: <a href=#pg-563493d51cba2cf0991bc456da66a1b1>Data-flow</a></li><li>4.1.2: <a href=#pg-8c50df3d62cb7d3b188a4daf7e4536fd>Services</a></li></ul><li>4.2: <a href=#pg-9bd47f930a6befba383b5f079fd5620d>Design documents</a></li><ul><li>4.2.1: <a href=#pg-0289c7adf583e85ce535e627617fcb3a>Signaling</a></li><li>4.2.2: <a href=#pg-6802b8721cfb6034a773e0771f4b7493>Conflict detection</a></li><li>4.2.3: <a href=#pg-5c302d0351a984c31f1516d7661b618f>Search for last-minute train slots (STDCM)</a></li><ul><li>4.2.3.1: <a href=#pg-947b82c2b20e8d312398ef2a5634cd3c>Business context</a></li><li>4.2.3.2: <a href=#pg-f0e665bd09334507f4e0f2438621834b>Train slot search module</a></li><ul><li>4.2.3.2.1: <a href=#pg-a4f78c201b7f1d0e1991144fff21f26a>Input format</a></li><li>4.2.3.2.2: <a href=#pg-12bb8a99ebcc826ad37983a300610aed>Encoding the solution space</a></li><li>4.2.3.2.3: <a href=#pg-74094845d6db946e31db476ef1c506a2>Discontinuities and backtracking</a></li><li>4.2.3.2.4: <a href=#pg-615ce0cf6c404cd85469e6285e5feb90>Conflict avoidance</a></li><li>4.2.3.2.5: <a href=#pg-ed97b39b0c3816e4f1073f363957a3e3>Standard allowance</a></li><li>4.2.3.2.6: <a href=#pg-460b1be4e2f2584372a451ceef833731>Implementation details</a></li></ul><li>4.2.3.3: <a href=#pg-8ee6423983b11793e61c99ce092f6373>Signaling interface</a></li></ul></ul><li>4.3: <a href=#pg-c963971a74112cd3ec208d3977cd25e5>APIs</a></li><ul><li>4.3.1: <a href=#pg-20edb78a2f57bbf0e0aadeb2bd6baaab>JSON Schemas</a></li><ul></ul></ul></ul><li>5: <a href=#pg-b5672eea755d8e1fc4d23b2baf6867df>Railway Wiki</a></li><ul><li>5.1: <a href=#pg-c10f498cbf37ef82f2252bc49b20abb3>Glossary</a></li><ul></ul></ul></ul><div class=content><p>Whether you would like to use OSRD, understand it or contribute, this is the right place!</p></div></div><div class=td-content><h1 id=pg-efa24ea182f6b96c6de2891c1787e164>1 - Tutorials</h1><div class=lead>Step by step, start to finish guides</div><p>Tutorials take you by the hand through a series of steps to complete small projects. Start here if you’re new to OSRD. Also look at the &ldquo;First steps&rdquo;.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0f647dfa795c2a3848006b8409f95352>2 - Explanations</h1><div class=lead>Learn more about key concepts</div><p>Explanations discuss key topics and concepts at a fairly high level and provide useful background information and explanation.</p></div><div class=td-content><h1 id=pg-a151e2a634dc5820b05191ae97d90e14>2.1 - Models</h1><div class=lead>What is modeled in OSRD, and how it is modeled</div></div><div class=td-content><h1 id=pg-f205938bbebab94d2a57f42f781e4fb1>2.1.1 - Infrastructure example</h1><div class=lead>Explains using an example how infrastructure data is structured</div><font color=#aa026d><h3 id=introduction>Introduction</h3></font><p>This page gives an example of how the data formats are used to describe an infrastructure in <strong>OSRD</strong>.</p><p>For this purpose, let&rsquo;s take as an example the following toy infrastructure:</p><p><img src=svg_diagrams/small_infra_diagram.drawio.en.svg alt="Toy infrastructure diagram"></p><div class="alert alert-info" role=alert><h4 class=alert-heading>Tip</h4>To zoom in on diagrams, click on the edit button that appears when hovering over it.</div><p>This diagram is an overview of the infrastructure with lines and stations only.</p><p>This infrastructure is not meant to be realistic, but rather meant to help illustrate OSRD&rsquo;s data model.
This example will be created step by step and explained along the way.</p><h4 id=the-infrastructure-generator>The infrastructure generator</h4><p>In the <a href=https://github.com/osrd-project/osrd><em>OSRD</em> repository</a> is a <a href=https://github.com/osrd-project/osrd/tree/dev/python/railjson_generator>python library</a> designed to help generate infrastructures in a format understood by <em>OSRD</em>.</p><p>The infrastructure discussed in this section can be generated thanks to <a href=https://github.com/osrd-project/osrd/blob/dev/python/railjson_generator/railjson_generator/scripts/examples/small_infra.py>small_infra.py</a> file. To learn more about the generation scripts, you can check out the related <a href=https://github.com/osrd-project/osrd/blob/dev/python/railjson_generator/README.md>README</a>.</p><font color=#aa026d><h3 id=tracks>Tracks</h3></font><h4 id=track-sections>Track sections</h4><p>The first objects we need to define are <code>TrackSections</code>. Most other objects are positioned relative to track sections.</p><p>A track section is a section of rail (switches not included). One can chose to divide the tracks of their infrastructure in as many track sections as they like. Here we chose to use the longest track sections possible, which means that between two switches there is always a single track section.</p><p>Track sections is what simulated trains roll onto. They are the abstract equivalent to physical rail sections. Track sections are bidirectional.</p><p>In this example, we define two tracks for the line between the West and North-East stations. We also have overpassing tracks at the North and Mid-West stations for added realism. Finally, we have three separate tracks in the West station, since it&rsquo;s a major hub in our imaginary infrastructure.</p><p><img src=svg_diagrams/small_infra_rails.drawio.en.svg alt="Track sections diagram"></p><div class="alert alert-warning" role=alert><h4 class=alert-heading>Important</h4><p><code>TrackSections</code> are represented as arrows in this diagram to stress the fact that they have a <strong>start</strong> and an <strong>end</strong>. It matters as objects positioned on track sections are located using their distance from the <strong>start</strong> of their track section.</p><p>Therefore, to locate an object at the beginning of its track section, set its offset to 0. To move it to the end of its track section, set its offset to the <code>length</code> of the track section.</p></div><p>These attributes are required for the track section to be complete:</p><ul><li><code>length</code>: the length of the track section in meters.</li><li><code>geo</code>: the coordinates in real life (geo is for geographic), in the <a href=https://en.wikipedia.org/wiki/GeoJSON>GeoJSON</a> format.</li><li><code>sch</code>: the coordinates in the schematic view (sch for schematic), also in <a href=https://en.wikipedia.org/wiki/GeoJSON>GeoJSON</a> format.</li><li>cosmetic attributes: <code>line_name</code>, <code>track_name</code>, <code>track_number</code> which are used to indicate the name and labels that were given to the tracks / lines in real life.</li></ul><p>For all track sections in our infrastructure, the <code>geo</code> and <code>sch</code> attributes are identical, and very much resemble the given diagram.</p><p>For most track sections, their <code>length</code> is proportional to what can be seen in the diagram. To preserve readability, exceptions were made for <em>TA6</em>, <em>TA7</em>, <em>TD0</em> and <em>TD1</em> (which are 10km and 25km).</p><h4 id=track-section-links>Track Section Links</h4><p>At the moment we only created track sections, which are not connected to each other (geospacial data is not used to deduce which tracks connect).</p><p><code>TrackSectionLinks</code> are used to connect two track sections together, just like a weld joint would in real life. In an OSRD simulation, a train can go from one track section to another only if they are connected by a <code>TrackSectionLink</code> (or by a <code>Switch</code>).</p><p>To connect more than two <code>TrackSections</code> together, use the <a href=#switches><code>Switches</code></a>.</p><p>In our infrastructure, since we chose to have our track sections as long as possible, we do not actually need to use <code>TrackSectionLinks</code>.
<code>TrackSectionLinks</code> are always optional: two track sections connected by a link behave just like a single track section.</p><h4 id=switches>Switches</h4><p>A <code>Switch</code> represents just what you would expect: railway switches.</p><p>Switches can be thought of as a collections of track section links, partitioned into groups. Each group represents for a switch state. Switching group can take time, and at most one link can be ready to use at a time.</p><p>In the real world, switches are not unique, but rather instances of existing models.
Thus, links and groups are not part of the switch itself, but in a <code>SwitchType</code> object, which is shared by switches of the same model.</p><h5 id=switch-types>Switch Types</h5><p><code>SwitchTypes</code> have two mandatory attributes:</p><ul><li><code>ports</code>: A list of port names. A port is an endpoint which can be connected to a track section.</li><li><code>groups</code>: A mapping from group names to lists of links between two ports.</li></ul><p>At any time, all switches have an active group, and may have an active link, which always belongs to the active group. If there is an active link, it is active in a given direction. During a simulation, changing active link inside a group is instantaneous, but changing active link across groups takes configurable time.
This is because a switch is a physical object, and changing active link can involve moving parts of it. <code>Groups</code> are designed to represent the different positions that a switch can have. Each <code>group</code> contains the links that can be used in the associated switch position.</p><p>The duration needed to change group is stored inside the <code>Switch</code>, since it can vary depending on the physical implementation of the switch.</p><p>Our examples currently use three switch types. Switch types are just like other objects, and can easily be added as needed.</p><p><strong>1) The Point Switch</strong></p><p>The ubiquitous Y switch, which can be thought of as either two tracks merging, or one track splitting.</p><p>This switch type has three ports: <em>base</em>, <em>left</em> and <em>right</em>.</p><p><img src=svg_diagrams/point_switch.en.svg alt="Point switch diagram"></p><p>There are two groups, each with one connection in their list: <code>LEFT</code>, which connects <em>base</em> to <em>left</em>, and <code>RIGHT</code> which connects <em>base</em> to <em>right</em>.</p><p>Thus, at any given moment, a train can go from <em>base</em> to <em>left</em> or from <em>base</em> to <em>right</em> but never to both at the same time. A train cannot go from <em>left</em> to <em>right</em>.</p><p>A Point Switch only has two positions:</p><p><img src=svg_diagrams/point_switch_positions.en.svg alt="Point switch positions diagram"></p><p><strong>2) The Cross Switch</strong></p><p>This is simply two tracks crossing each other.</p><p>This type has four ports: <em>north</em>, <em>south</em>, <em>east</em> and <em>west</em>.</p><p><img src=svg_diagrams/cross_switch.en.svg alt="Cross switch diagram"></p><p>It has only one group containing two connections: <em>north</em> to <em>south</em> and <em>west</em> to <em>east</em>. Indeed this kind of switch is <em>passive</em>: it has no moving parts. Despite having a single group, it is still used by the simulation to enforce route reservations.</p><p>Here are the two different connections that this switch type has:</p><p><img src=svg_diagrams/cross_switch_positions.en.svg alt="Cross switch positions diagram"></p><p><strong>3) The Double cross switch</strong></p><p>This one is more like two point switches back to back. It has four ports: <em>south1</em>, <em>south2</em>, <em>north1</em> and <em>north2</em>.</p><p><img src=svg_diagrams/double_cross_switch.en.svg alt="Double cross switch diagram"></p><p>However, it has four groups, each with one connection. The four groups are represented in the following diagram:</p><p><img src=svg_diagrams/double_cross_switch_positions.en.svg alt="Double cross switch positions diagram"></p><h5 id=back-to-switches>Back to switches</h5><p>A <code>Switch</code> has three attributes:</p><ul><li><code>switch_type</code>: the <a href=#switch-types><code>SwitchType</code></a> identifier for this switch.</li><li><code>ports</code>: a mapping from port names to track sections extremities.</li><li><code>group_change_delay</code>: the time it takes to change which group of the switch is activated.</li></ul><p>The port names must match the ports of the switch type chosen. The track section endpoints can be start or end, be careful to chose the appropriate ones.</p><p>Most of our example&rsquo;s switches are regular point switches. The path from North station to South station has two cross switches, and there is a double cross switch right before the main line splits into the North-East and South-East lines.</p><p><img src=svg_diagrams/small_infra_rails_n_points.drawio.en.svg alt="Track sections and points diagram"></p><h4 id=curves-and-slopes>Curves and slopes</h4><p><code>Curves</code> and <code>Slopes</code> are instrumental to realistic simulations. These objects are defined as a range between a <code>begin</code> and <code>end</code> offsets of one track section. If a curve / slope spans more than one track section, it has to be added to all of them.</p><p>The slope / curve values are constant on their entire range. For varying curves / slopes, one needs to create several objects.</p><p>Slope values are measured in <em>meters per kilometers</em>, and the curve values are measured in <em>meters</em> (the radius of the curve).</p><div class="alert alert-primary" role=alert>Mind that the <code>begin</code> value should always be smaller than the <code>end</code> value. That is why the curve / slope values can be negative: an uphill slope of 1 going from offset 10 to 0 is the same as a downhill slope of -1 going from offsets 0 to 10.</div><p>In the <a href=https://github.com/osrd-project/osrd/blob/dev/python/railjson_generator/railjson_generator/scripts/examples/small_infra.py>small_infra.py</a> file, we have slopes on the track sections <em>TA6</em>, <em>TA7</em>, <em>TD0</em> and <em>TD1</em>.</p><p>There are curves as well, on the track sections <em>TE0</em>, <em>TE1</em>, <em>TE3</em> and <em>TF1</em>.</p><font color=#aa026d><h3 id=interlocking>Interlocking</h3></font><p>All objects so far contributed to track topology (shape). Topology would be enough for trains to navigate the network, but not enough to do so safely. to ensure safety, two systems collaborate:</p><ul><li>Interlocking ensures trains are allowed to move forward</li><li>Signaling is the mean by which interlocking communicates with the train</li></ul><h4 id=detectors>Detectors</h4><p>These objects are used to create <a href="https://ressources.data.sncf.com/explore/dataset/lexique-des-acronymes-sncf/table/?sort=abreviation&q=TVD">TVD</a> sections (Track Vacancy Detection section): the track area in between detectors is a TVD section. When a train runs into a detector, the section it is entering becomes occupied. The only function of TVD sections is to locate trains.</p><p>In real life, detectors can be <a href=https://en.wikipedia.org/wiki/Axle_counter>axle counters</a> or <a href=https://en.wikipedia.org/wiki/Track_circuit>track circuits</a> for example.</p><p>For this mean of location to be efficient, detectors need to be placed regularly along your tracks, not too many because of cost, but not too few, because then TVD sections would be very large and trains would need to be very far apart to be told apart, which reduces capacity.</p><p>There often are detectors close to all sides of switches. This way, interlocking is made aware pretty much immediately when a switch is cleared, which is then free to be used again.</p><div class="alert alert-info" role=alert>Let&rsquo;s take a cross switch as an example: if train A is crossing it <em>north</em> to <em>south</em> and train B is coming to cross <em>west</em> to <em>east</em>, then as soon as train A&rsquo;s last car has passed the crossing, B should be able to go, since A is now on a completely unrelated track section.</div><p>In <em>OSRD</em>, detectors are point objects, so all the attributes it needs are its <code>id</code>, and track location (<code>track</code> and <code>offset</code>).</p><p><img src=svg_diagrams/small_infra_detectors.drawio.en.svg alt="Infra diagram with all detectors"></p><div class="alert alert-info" role=alert>The clumped up squares represent many detectors at once. Indeed, because some track sections are not represented with their full length, we could not represent all the detectors on the corresponding track section.</div><p>Some notes:</p><ul><li>Between some points, we added only one detector (and not two), because they were really close together, and it would have made no sense to create a tiny TVDS between the two. This situation happened on track sections (<em>TA3</em>, <em>TA4</em>, <em>TA5</em>, <em>TF0</em> and <em>TG3</em>).</li><li>In our infrastructure, there is relatively few track sections which are long enough to require more detectors than just those related to switches. Namely, <em>TA6</em>, <em>TA7</em>, <em>TDO</em>, <em>TD1</em>, <em>TF1</em>, <em>TG1</em> and <em>TH1</em>. For example <em>TD0</em>, which measures 25km, has in fact 17 detectors in total.</li></ul><h4 id=buffer-stops>Buffer stops</h4><p><code>BufferStops</code> are obstacles designed to prevent trains from sliding off dead ends.</p><p>In our infrastructure, there is a buffer stop on each track section which has a loose end. There are therefore 8 buffer stops in total.</p><p>Together with detectors, they set the boundaries of TVD sections (see <a href=#detectors>Detectors</a>)</p><h4 id=routes>Routes</h4><p>A <code>Route</code> is an itinerary in the infrastructure. A train path is a sequence of routes. Routes are used to reserve section of path with the interlocking. See the <a href=/fr/docs/reference/design-docs/interlocking/>dedicated documentation</a>.</p><p>It is represented with the following attributes:</p><ul><li><code>entry_point</code> and <code>exit_point</code>: references detectors or buffer stops which mark the beginning and the end of the Route.</li><li><code>entry_point_direction</code> : Direction on a track section to start the route from the <code>entry_point</code>.</li><li><code>switches_direction</code> : A set of directions to follow when we encounter a switch on our Route, to build this Route from <code>entry_point</code> to <code>exit_point</code>.</li><li><code>release_detectors</code>: When a train clears a release detector, resources reserved from the beginning of the route until this detector are released.</li></ul><font color=#aa026d><h3 id=signaling>Signaling</h3></font><p>Thanks to interlocking, trains are located and allowed to move. It&rsquo;s a good start, but meaningless until trains are made aware of it. This is where <code>Signal</code>s come into play: signals react to interlocking, and can be seen by trains.</p><p>How trains react to signals depends on the aspect, kind of signal, and signaling system.</p><p>Here are the most important attributes for signals:</p><ul><li><code>linked_detector</code>: The linked <a href=#detectors>detector</a>.</li><li><code>type_code</code>: The type of signal.</li><li><code>direction</code>: The direction it protects, which can simply be interpreted as the way in which it can be seen by an incoming train (since there are lights only on one side&mldr;). Direction is relative to track section orientation.</li><li>Cosmetic attributes like <code>angle_geo</code> or <code>side</code> which control the way in which the signals are displayed in the front-end.</li></ul><p>Here is a visualization of how one can represent a signal, and which direction it protects.</p><p><img src=svg_diagrams/signal_dir.en.svg alt="Signal direction example"></p><br><p>The way the signals are arranged is highly dependent on both signaling system and infrastructure manager.</p><p>Here are the basic rules used for this example infrastructure:</p><ul><li>We add two spacing signals (one per direction) for each detector that is cutting a long TVD section into smaller ones.</li><li>Switch entries where a train might have to stop are protected by a signal (which is located outside of the switch TVD section). It must be visible from the direction used to approach the switch. When there are multiple switches in a row, only the first one usually needs protection, as interlocking is usually designed as not to encourage trains stopping in the middle of intersections.</li></ul><p>Note that detectors linked to at least one signal are not represented, as there are not signals without associated detectors in this example.
To get the <code>id</code> of a detector linked to a signal, take the signal&rsquo;s <code>id</code> and replace <em>S</em> by <em>D</em> (e.g. SA0 -> DA0).</p><p><img src=svg_diagrams/small_infra_signals.drawio.en.svg alt="Infra diagram with all signals"></p><div class="alert alert-info" role=alert>On <em>TA6</em>, <em>TA7</em>, <em>TD0</em> and <em>TD1</em> we could not represent all signals because these track sections are very long and have many detectors, hence many signals.</div><font color=#aa026d><h3 id=electrification>Electrification</h3></font><p>To allow electric trains to run on our infrastructure, we need to specify which parts of the infrastructure is electrified.</p><h4 id=catenaries>Catenaries</h4><p><code>Catenaries</code> are objects that represent the overhead wires that power electric trains. They are represented with the following attributes:</p><ul><li><code>voltage</code>: A string representing the type of power supply used for electrification</li><li><code>track_ranges</code>: A list of range of track sections (<code>TrackRanges</code>) covered by this catenary. A <code>TrackRange</code> is composed of a track section id, a <code>begin</code> offset and an <code>end</code> offset.</li></ul><p>In our example infrastructure, we have two <code>Catenaries</code>:</p><ul><li>One with <code>voltage</code> set to <code>"1500"</code>, which covers only <em>TA0</em>.</li><li>One with <code>voltage</code> set to <code>"25000"</code>, which covers all others except <em>TD1</em>.</li></ul><p>This means that only thermal trains can cross the <em>TD1</em> track section.</p><p>Our example also outlines that, unlike its real life counterpart, a single <code>Catenary</code> may cover the whole infrastructure.</p><h4 id=neutral-sections>Neutral Sections</h4><p>In some parts of an infrastructure, the train drivers may be instructed - mainly for safety reasons - to cut the power supply to the train.</p><p>To represent such parts, we use <code>NeutralSections</code>. They are represented mainly with the following attributes:</p><ul><li><code>track_ranges</code>: A list of <code>DirectedTrackRanges</code> (track ranges associated to a direction) which are covered by this neutral section.</li><li><code>lower_pantograph</code>: A boolean indicating whether the train&rsquo;s pantograph should be lowered while in this section.</li></ul><p>In our example infrastructure, we have three <code>NeutralSections</code>: one at the junction of the <code>"1500"</code> and <code>"25000"</code> catenaries, one on <em>TA6</em> and one on <em>TG1</em> and <em>TG4</em>.</p><p>For more details about the model see the <a href=../neutral_sections>dedicated page</a>.</p><font color=#aa026d><h3 id=miscellaneous>Miscellaneous</h3></font><h4 id=operational-points>Operational points</h4><p><code>OperationalPoints</code> are collections of points (<code>OperationalPointParts</code>) of interest.</p><p>For example, it may be convenient to store the location of platforms as parts and group them by station in operational points.</p><p>In the example infrastructure, we only used operational points to represent stations. Operational point parts are displayed as purple diamonds. Keep in mind a single operational point may contain multiple parts.</p><p><img src=svg_diagrams/small_infra_op_points.drawio.en.svg alt="Operational points examples"></p><h4 id=loading-gauge-limits>Loading Gauge Limits</h4><p>These objects are akin to <code>Slopes</code> and <code>Curves</code>: it covers a range of track section, with a <code>begin</code> and an <code>end</code> offset. It represents a restriction on the trains that can travel on the given range, by weight or by train type (freight or passenger).</p><p>We did not put any in our examples.</p><h4 id=speed-sections>Speed Sections</h4><p>The <code>SpeedSections</code> represent speed limits (in meters per second) that are applied on some parts of the tracks. One <code>SpeedSection</code> can span on several track sections, and do not necessarily cover the whole track sections. Speed sections can overlap.</p><p>In our example infrastructure, we have a speed section covering the whole infrastructure, limiting the speed to 300 km/h. On a smaller part of the infrastructure, we applied more restrictive speed sections.</p><p><img src=svg_diagrams/speed_sections.en.svg alt="Speed section examples"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-d8a9003e9780b0213913d2b62364ed28>2.1.2 - Neutral Sections</h1><div class=lead>Documentation about what they are and how they are implemented</div><h2 id=physical-object-to-model>Physical object to model</h2><h3 id=introduction>Introduction</h3><p>For a train to be able to run, it must either have an energy source on board (fuel, battery, hydrogen, &mldr;) or be supplied with energy throughout its journey.</p><p>To supply this energy, electrical cables are suspended above the tracks: the <em>catenaries</em>. The train then makes contact with these cables thanks to a conducting piece mounted on a mechanical arm: the <em>pantograph</em>.</p><h3 id=neutral-sections>Neutral sections</h3><p>With this system it is difficult to ensure the electrical supply of a train continuously over the entire length of a line. On certain sections of track, it is necessary to cut the electrical supply of the train. These portions are called <strong>neutral sections</strong>.</p><p>Indeed, in order to avoid energy losses along the catenaries, the current is supplied by several substations distributed along the tracks. Two portions of catenaries supplied by different substations must be electrically isolated to avoid short circuits.</p><p>Moreover, the way the tracks are electrified (DC or not for example) can change according to the local uses and the time of installation. It is again necessary to electrically isolate the portions of tracks which are electrified differently. The train must also (except in particular cases) change its pantograph when the type of electrification changes.</p><p>In both cases, the driver is instructed to cut the train&rsquo;s traction, and sometimes even to lower the pantograph.<br>In the French infrastructure, these zones are indicated by announcement, execution and end signs. They also carry the indication to lower the pantograph or not. The portions of track between the execution and end may not be electrified entirely, and may not even have a catenary (in this case the zone necessarily requires lowering the pantograph).<br><em>REV</em> (for reversible) signs are sometimes placed downstream of the end of zone signs. They are intended for trains that run with a pantograph at the rear of the train. These signs indicate that the driver can resume traction safely.</p><p>Additionally, it may sometimes be impossible on a short section of track to place a catenary or to raise the train&rsquo;s pantograph. In this case the line is still considered electrified, and the area without electrification (passage under a bridge for example) is considered as a neutral section.</p><h3 id=rolling-stock>Rolling stock</h3><p>After passing through a neutral section, a train must resume traction. This is not immediate (a few seconds), and the necessary duration depends on the rolling stock.</p><p>In addition, the driver must, if necessary, lower his pantograph, which also takes time (a few tens of seconds) and also depends on the rolling stock.</p><p>Thus, the coasting imposed on the train extends outside the neutral section, since these system times are to be counted from the end of the neutral section.</p><h2 id=data-model>Data model</h2><p>We have chosen to model the neutral sections as the space between the signs linked to it (and not as the precise zone where there is no catenary or where the catenary is not electrified).</p><p>This zone is directional, <em>i.e.</em> associated with a direction of travel, in order to be able to take into account different placements of signs according to the direction. The execution sign of a given direction is not necessarily placed at the same position as the end of zone sign of the opposite direction.</p><p>For a two-way track, a neutral section is therefore represented by two objects.</p><p>The schema is the following</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;lower_pantograph&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#a40000>boolean</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;track_ranges&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;track&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#a40000>string</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;start&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#a40000>number</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;end&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#a40000>number</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;direction&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#a40000>enum</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>],</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>&#34;announcement_track_ranges&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;track&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#a40000>string</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;start&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#a40000>number</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;end&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#a40000>number</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>&#34;direction&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#a40000>enum</span>
</span></span><span style=display:flex><span>        <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><ul><li><code>lower_pantograph</code>: indicates whether the pantograph should be lowered in this section</li><li><code>track_ranges</code>: list of track sections ranges where the train must not traction</li><li><code>announcement_track_ranges</code>: list of track sections ranges between the announcement sign and the execution sign</li></ul><h2 id=display>Display</h2><h3 id=map>Map</h3><p>The zones displayed in the map correspond to the <code>track_ranges</code> of neutral sections, thus are between the execution and end signs of the zone. The color of the zone indicates whether the train must lower its pantograph in the zone or not.</p><p>The direction in which the zone applies is not represented.</p><h3 id=simulation-results>Simulation results</h3><p>In the linear display, it is always the area between EXE and FIN that is displayed.</p><h2 id=pathfinding>Pathfinding</h2><p>Neutral sections are therefore portions of &ldquo;non-electrified&rdquo; track where an electric train can still run (but where it cannot traction).</p><p>When searching for a path in the infrastructure, an electric train can travel through a track section that is not covered by the <code>track_ranges</code> of a catenary object (documentation to be written) only if it is covered by the <code>track_ranges</code> of a neutral section.</p><h2 id=simulation>Simulation</h2><p>In our simulation, we approximate the driver&rsquo;s behavior as follows:</p><ul><li>The coasting is started as soon as the train&rsquo;s head passes the announcement sign</li><li>The system times (pantograph reading and traction resumption) start as soon as the train&rsquo;s head passes the end sign.</li></ul><p>In the current simulation, it is easier to use spatial integration bounds rather than temporal ones. We make the following approximation: when leaving the neutral section, we multiply the system times by the speed at the exit of the zone. The coasting is then extended over the obtained distance. This approximation is reasonable because the train&rsquo;s inertia and the almost absence of friction guarantee that the speed varies little over this time interval.</p><h2 id=improvements-to-be-made>Improvements to be made</h2><p>Several aspects could be improved:</p><ul><li>We do not model the <em>REV</em> signs, all trains therefore only have one pantograph at the front in our simulations.</li><li>System times are approximated.</li><li>The driver&rsquo;s behavior is rather restrictive (coasting could start after the announcement sign).</li><li>The display of the zones is limited: no representation of the direction or the announcement zones.</li><li>These zones are not editable.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d0b32c1c59097b608e257ee86e580a19>2.2 - Running time calculation</h1><p>OSRD can be used to perform two types of calculations:</p><ul><li><strong>Standalone train simulation:</strong> calculation of the travel time of a train on a given route without interaction between the train and the signalling system.</li><li><strong>Simulation:</strong> &ldquo;dynamic&rdquo; calculation of several trains interacting with each other via the signalling system.</li></ul><h4 id=1---the-input-data>1 - The input data</h4><p>A running time calculation is based on 5 inputs:</p><ul><li><strong>Infrastructure:</strong> Line and track topology, position of stations and passenger buildings, position and type of points, signals, maximum line speeds, corrected line profile (gradients, ramps and curves).</li></ul><p><img src=infrastructure.png alt=Infrastructure></p><blockquote><p>The blue histogram is a representation of the gradients in [‰] per position in [m]. The gradients are positive for ramps and negative for slopes.</p><p>The orange line represents the cumulative profile, i.e. the relative altitude to the starting point.</p><p>The blue line is a representation of turns in terms of radii of curves in [m].</p></blockquote><ul><li><strong>The rolling stock:</strong> The characteristics of which needed to perform the simulation are shown below.</li></ul><p><img src=mat_roulant.png alt="Rolling Stock Material"></p><blockquote><p>The orange curve, called the effort-speed curve, represents the maximum motor effort as a function of the speed of travel.</p><p>The length, mass, and maximum speed of the train are shown at the bottom of the box.</p></blockquote><ul><li><p><strong>The departure time</strong> is then used to calculate the times of passage at the various points of interest (including stations).</p></li><li><p><strong>Allowances:</strong> Time added to the train&rsquo;s journey to relax its running (see <a href=./allowances>page on allowances</a>).</p></li></ul><p><img src=marges.png alt=Allowances></p><ul><li><strong>The time step</strong> for the calculation of <a href=./numerical_integration>numerical integration</a>.</li></ul><h4 id=2---the-results>2 - The results</h4><p>The results of a running time calculation can be represented in different forms:</p><ul><li><strong>The space/time graph (GET):</strong> represents the path of trains in space and time, in the form of generally diagonal lines whose slope is the speed. Stops are shown as horizontal plates.</li></ul><p><img src=graph_espace_temps.jpg alt="Space/Time Graph"></p><blockquote><p>Example of a GET with several trains spaced about 30 minutes apart.</p><p>The <strong>x</strong> axis is the time of the train, the <strong>y</strong> axis is the position of the train in [m].</p><p>The blue line represents the most tense running calculation for the train, the green line represents a relaxed, so-called &ldquo;economic&rdquo; running calculation.</p><p>The solid rectangles surrounding the paths represent the portions of the track successively reserved for the train to pass (called blocks).</p></blockquote><ul><li><strong>The space/speed graph (SSG):</strong> represents the journey of a single train, this time in terms of speed. Stops are therefore shown as a drop in the curve to zero, followed by a re-acceleration.</li></ul><p><img src=graph_espace_vitesse.png alt="Space/Speed Graph"></p><blockquote><p>The <strong>x</strong> axis is the train position in [m], the <strong>y</strong> axis is the train speed in [km/h].</p><p>The purple line represents the maximum permitted speed.</p><p>The blue line represents the speed in the case of the most stretched running calculation.</p><p>The green line represents the speed in the case of the &ldquo;economic&rdquo; travel calculation.</p></blockquote><ul><li><strong>The timetable for the passage of the train at the various points of interest</strong>.</li></ul><p><img src="timetables.png?style=time" alt="Departure timetables"></p><style>img[src$=time]{height:70%;width:70%}</style></div><div class=td-content style=page-break-before:always><h1 id=pg-0fa7914af29cb313adb8b16f8dc2bcc0>2.2.1 - Physical modeling</h1><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css integrity=sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js integrity=sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><p>Physical modelling plays an important role in the OSRD core calculation. It allows us to simulate train traffic, and it must be as realistic as possible train traffic, and it must be as realistic as possible.</p><font color=#aa026d><h3 id=force-review>Force review</h3></font><p>To calculate the displacement of the train over time, we must first calculate its speed at each instant.
A simple way to obtain this speed is to calculate the acceleration.
Thanks to the fundamental principle of dynamics, the acceleration of the train at each instant is directly dependent on the different forces applied to it: $$ \sum \vec{F}=m\vec{a} $$</p><p><img src=../forces.png alt="Running time"></p><ul><li><p><strong>Traction</strong>: The value of the traction force \(F_{mot}\) depends on several factors:</p><ul><li>the rolling stock</li><li>the speed of the train, \(v^{\prime}x\) according to the effort-speed curve below:</li></ul><p>$$ {\vec{F_{mot}}(v_{x^{\prime}}, x^{\prime})=F_{mot}(v_{x^{\prime}}, x^{\prime})\vec{e_x^{\prime}}} $$</p><p><img src=../effort-vitesse.png alt="Running time" title="Example of a train effort-speed curve"></p><blockquote><p>The <strong>x</strong> axis represents the speed of the train in [km/h], the <strong>y</strong> axis the value of the traction force in [kN].</p></blockquote><ul><li>the action of the driver, who accelerates more or less strongly depending on where he is on his journey</li></ul></li></ul><br><ul><li><strong>Braking</strong> : The value of the braking force \(F_{brk}\) also depends on the rolling stock and the driver&rsquo;s action but has a constant value for a given rolling stock. In the current state of modelling, braking is either zero or at its maximum value.</li></ul><p>$$ \vec{F_{brk}}(x^{\prime})=-F_{brk}(x^{\prime}){\vec{e_{x^{\prime}}}} $$</p><p>A second approach to modelling braking is the so-called hourly approach, as it is used for hourly production at SNCF. In this case, the deceleration is fixed and the braking no longer depends on the different forces applied to the train. Typical deceleration values range from 0.4 to 0.7m/s².</p><br><ul><li><strong>Forward resistance</strong>: To model the forward resistance of the train, the Davis formula is used, which takes into account all the friction and aerodynamic resistance of the air. The value of the drag depends on the speed \(v^{\prime}_x\). The coefficients \(A\), \(B\), et \(C\) depend on the rolling stock.</li></ul><p>$$ {\vec{R}(v_{x^{\prime}})}=-(A+Bv_{x^{\prime}}+{Cv_{x^{\prime}}}^2){\vec{e_{x^{\prime}}}} $$</p><br><ul><li><strong>Weight (slopes + turns)</strong> : The weight force given by the product between the mass \(m\) of the train and the gravitational constant \(g\) is projected on the axes \(\vec{e_x}^{\prime}\) and \(\vec{e_y}^{\prime}\).For projection, we use the angle \(i(x^{\prime})\), which is calculated from the slope angle \(s(x^{\prime})\) corrected by a factor that takes into account the effect of the turning radius \(r(x^{\prime})\).</li></ul><p>$$
\vec{P(x^{\prime})}=-mg\vec{e_y}(x^{\prime})=
-mg\Big[sin\big(i(x^{\prime})\big){\vec{e_{x^{\prime}}}(x^{\prime})}+cos\big(i(x^{\prime})\big){\vec{e_{{\prime}}}(x^{\prime})}\Big]
$$</p><p>$$ i(x^{\prime})= s(x^{\prime})+\frac{800m}{r(x^{\prime})} $$</p><br><ul><li><strong>Ground Reaction</strong> : The ground reaction force simply compensates for the vertical component of the weight, but has no impact on the dynamics of the train as it has no component along the axis \({\vec{e_x}^{\prime}}\).</li></ul><p>$$ \vec{R_{gnd}}=R_{gnd}{\vec{e_{y^{\prime}}}} $$</p><font color=#aa026d><h3 id=forces-balance>Forces balance</h3></font><p>The equation of the fundamental principle of dynamics projected onto the axis \({\vec{e_x}^{\prime}}\) (in the train frame of reference) gives the following scalar equation:</p><p>$$
a_{x^{\prime}}(t) = \frac{1}{m}\Big
[F_{mot}(v_{x^{\prime}}, x^{\prime})-F_{brk}(x^{\prime})-(A+Bv_{x^{\prime}}+{Cv_{x^{\prime}}}^2)-mgsin(i(x^{\prime}))\Big]
$$</p><p>This is then simplified by considering that despite the gradient the train moves on a plane and by amalgamating
\(\vec{e_x}\) and \(\vec{e_x}^{\prime}\). The gradient still has an impact on the force balance, but it is assumed that the train is only moving horizontally, which gives the following simplified equation:</p><p>$$ a_{x}(t) = \frac{1}{m}\Big[F_{mot}(v_{x}, x)-F_{brk}(x)-(A+Bv_{x}+{Cv_{x}}^2)-mgsin(i(x))\Big] $$</p><font color=#aa026d><h3 id=resolution>Resolution</h3></font><p>The driving force and the braking force depend on the driver&rsquo;s action (he decides to accelerate or brake more or less strongly depending on the situation). This dependence is reflected in the dependence of these two forces on the position of the train. The weight component is also dependent on the position of the train, as it comes directly from the slopes and bends below the train.</p><p>In addition, the driving force depends on the speed of the train (according to the speed effort curve) as does the resistance to forward motion.
resistance.</p><p>These different dependencies make it impossible to solve this equation analytically, and the acceleration of the train at each moment must be calculated by numerical integration.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ea6d32407559a3426f098dbe1408c955>2.2.2 - Numerical integration</h1><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css integrity=sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js integrity=sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script>
<font color=#aa026d><h3 id=introduction>Introduction</h3></font><p>Since physical modelling has shown that the acceleration of the train is influenced by various factors that vary along the route (gradient, curvature, engine traction force, etc.), the calculation must be carried out using a numerical integration method. The path is then separated into sufficiently short steps to consider all these factors as constant, which allows this time to use the equation of motion to calculate the displacement and speed of the train.</p><p>Euler&rsquo;s method of numerical integration is the simplest way of doing this, but it has a number of drawbacks. This article explains the Euler method, why it is not suitable for OSRD purposes and which integration method should be used instead.</p><font color=#aa026d><h3 id=eulers-method>Euler&rsquo;s method</h3></font><p>The Euler method applied to the integration of the equation of motion of a train is:</p><p>$$v(t+dt) = a(v(t), x(t))dt + v(t)$$</p><p>$$x(t+dt) = \frac{1}{2}a(v(t), x(t))dt^2 + v(t)dt + x(t)$$</p><center><p><img src="../euler.png?style=method" alt="Euler&amp;rsquo;s method"></p></center><p>&nbsp;</p><h4 id=advantages-of-eulers-method><strong>Advantages of Euler&rsquo;s method</strong></h4><p>The advantages of the Euler method are that it is very simple to implement and has a rather fast calculation for a given time step, compared to other numerical integration methods (see <a href=#the-choice-of-integration-method-for-osrd>appendix</a>)</p><h4 id=disadvantages-of-the-eulers-method><strong>Disadvantages of the Euler&rsquo;s method</strong></h4><p>The Euler integration method presents a number of problems for OSRD:</p><ul><li>It is relatively imprecise, and therefore requires a small time step, which generates a lot of data.</li><li>With time integration, only the conditions at the starting point of the integration step (gradient, infrastructure parameters, etc.) are known, as one cannot predict precisely where it will end.</li><li>We cannot anticipate future changes in the directive: the train only reacts by comparing its current state with its set point at the same time. To illustrate, it is as if the driver is unable to see ahead, whereas in reality he anticipates according to the signals, slopes and bends he sees ahead.</li></ul><font color=#aa026d><h3 id=runge-kuttas-4-method>Runge-Kutta&rsquo;s 4 method</h3></font><p>The Runge-Kutta 4 method applied to the integration of the equation of motion of a train is:</p><p>$$v(t+dt) = v(t) + \frac{1}{6}(k_1 + 2k_2 + 2k_3 + k_4)dt$$</p><p>With:</p><p>$$k_1 = a(v(t), x(t))$$</p><p>$$k_2 = a\Big(v(t+k_1\frac{dt}{2}), x(t) + v(t)\frac{dt}{2} + k_1\frac{dt^2}{8}\Big)$$</p><p>$$k_3 = a\Big(v(t+k_2\frac{dt}{2}), x(t) + v(t)\frac{dt}{2} + k_2\frac{dt^2}{8}\Big)$$</p><p>$$k_4 = a\Big(v(t+k_3dt), x(t) + v(t)dt + k_3\frac{dt^2}{2}\Big)$$</p><center><p><img src="../rk4.png?style=method" alt="Runge-Kutta 4&amp;rsquo;s method"></p></center><p>&nbsp;</p><h4 id=advantages-of-runge-kuttas-4-method><strong>Advantages of Runge Kutta&rsquo;s 4 method</strong></h4><p>Runge Kutta&rsquo;s method of integration 4 addresses the various problems raised by Euler&rsquo;s method:</p><ul><li>It allows the anticipation of directive changes within a calculation step, thus representing more accurately the reality of driving a train.</li><li>It is more accurate for the same calculation time (see <a href=#the-choice-of-integration-method-for-osrd>appendix</a>), allowing for larger integration steps and therefore fewer data points.</li></ul><h4 id=disavantages-of-runge-kuttas-4-method><strong>Disavantages of Runge Kutta&rsquo;s 4 method</strong></h4><p>The only notable drawback of the Runge Kutta 4 method encountered so far is its difficulty of implementation.</p><font color=#aa026d><h3 id=the-choice-of-integration-method-for-osrd>The choice of integration method for OSRD</h3></font><h4 id=study-of-accuracy-and-speed-of-calculation><strong>Study of accuracy and speed of calculation</strong></h4><p>Different integration methods could have replaced the basic Euler integration in the OSRD algorithm. In order to decide which method would be most suitable, a study of the accuracy and computational speed of different methods was carried out. This study compared the following methods:</p><ul><li>Euler</li><li>Euler-Cauchy</li><li>Runge-Kutta 4</li><li>Adams 2</li><li>Adams 3</li></ul><p>All explanations of these methods can be found (in french) in <a href=https://github.com/osrd-project/osrd/wiki/documents/integration/MethodesNumeriques_EricGoncalves.pdf>this document</a>, and the python code used for the simulation is <a href=https://raw.githubusercontent.com/wiki/osrd-project/osrd/code/integration/Tests_precision.py>here</a>.</p><p>The simulation calculates the position and speed of a high-speed train accelerating on a flat straight line.</p><h4 id=equivalent-time-step-simulations><strong>Equivalent time step simulations</strong></h4><p>A reference curve was simulated using the Euler method with a time step of 0.1s, then the same path was simulated using the other methods with a time step of 1s. It is then possible to simply compare each curve to the reference curve, by calculating the absolute value of the difference at each calculated point. The resulting absolute error of the train&rsquo;s position over its distance travelled is as follows:</p><p><img src=../precisions_h_equivalent.png alt=precisions_h_equivalent></p><p>It is immediately apparent that the Euler method is less accurate than the other four by about an order of magnitude. Each curve has a peak where the accuracy is extremely high (extremely low error), which is explained by the fact that all curves start slightly above the reference curve, cross it at one point and end slightly below it, or <em>vice versa</em>.</p><p>As accuracy is not the only important indicator, the calculation time of each method was measured. This is what we get for the same input parameters:</p><table><thead><tr><th style=text-align:left>Integration method</th><th style=text-align:right>Calculation time (s)</th></tr></thead><tbody><tr><td style=text-align:left>Euler</td><td style=text-align:right>1.86</td></tr><tr><td style=text-align:left>Euler-Cauchy</td><td style=text-align:right>3.80</td></tr><tr><td style=text-align:left>Runge-Kutta 4</td><td style=text-align:right>7.01</td></tr><tr><td style=text-align:left>Adams 2</td><td style=text-align:right>3.43</td></tr><tr><td style=text-align:left>Adams 3</td><td style=text-align:right>5.27</td></tr></tbody></table><p>Thus, Euler-Cauchy and Adams 2 are about twice as slow as Euler, Adams 3 is about three times as slow, and RK4 is about four times as slow. These results have been verified on much longer simulations, and the different ratios are maintained.</p><h4 id=simulation-with-equivalent-calculation-time><strong>Simulation with equivalent calculation time</strong></h4><p>As the computation times of all methods depend linearly on the time step, it is relatively simple to compare the accuracy for approximately the same computation time. Multiplying the time step of Euler-Cauchy and Adams 2 by 2, the time step of Adams 3 by 3, and the time step of RK4 by 4, here are the resulting absolute error curves:</p><p><img src=../precisions_time_equivalent.png alt=precisions_time_equivalent></p><p>And here are the calculation times:</p><table><thead><tr><th style=text-align:left>Integration method</th><th style=text-align:right>Calculation time (s)</th></tr></thead><tbody><tr><td style=text-align:left>Euler</td><td style=text-align:right>1.75</td></tr><tr><td style=text-align:left>Euler-Cauchy</td><td style=text-align:right>2.10</td></tr><tr><td style=text-align:left>Runge-Kutta 4</td><td style=text-align:right>1.95</td></tr><tr><td style=text-align:left>Adams 2</td><td style=text-align:right>1.91</td></tr><tr><td style=text-align:left>Adams 3</td><td style=text-align:right>1.99</td></tr></tbody></table><p>After some time, RK4 tends to be the most accurate method, slightly more accurate than Euler-Cauchy, and still much more accurate than the Euler method.</p><font color=#aa026d><h3 id=conclusions-of-the-study>Conclusions of the study</h3></font><p>The study of accuracy and computational speed presented above shows that RK4 and Euler-Cauchy would be good candidates to replace the Euler algorithm in OSRD: both are fast, accurate, and could replace the Euler method without requiring large implementation changes because they only compute within the current time step.
<strong>It was decided that OSRD would use the Runge-Kutta 4 method because it is slightly more accurate than Euler-Cauchy and it is a well-known method for this type of calculation, so it is very suitable for an open-source simulator.</strong></p><style>img[src$=method]{height:70%;width:70%}</style></div><div class=td-content style=page-break-before:always><h1 id=pg-4ea0de1a5a62574096209d692bf76d42>2.2.3 - Envelopes system</h1><p>The envelope system is an interface created specifically for the OSRD gait calculation. It allows you to manipulate different space/velocity curves, to slice them, to end them, to interpolate specific points, and to address many other needs necessary for the gait calculation.</p><font color=#aa026d><h3 id=a-specific-interface-in-the-osrd-core-service>A specific interface in the OSRD Core service</h3></font><p>The envelope system is part of the core service of OSRD (see <a href=../architecture/_index.md>software architecture</a>).</p><p>Its main components are :</p><p><strong>1 - EnvelopePart:</strong> space/speed curve, defined as a sequence of points and having metadata indicating for example if it is an acceleration curve, a braking curve, a speed hold curve, etc.</p><p><strong>2 - Envelope:</strong> a list of end-to-end EnvelopeParts on which it is possible to perform certain operations:</p><ul><li>check for continuity in space (mandatory) and speed (optional)</li><li>look for the minimum and/or maximum speed of the envelope</li><li>cut a part of the envelope between two points in space</li><li>perform a velocity interpolation at a certain position</li><li>calculate the elapsed time between two positions in the envelope</li></ul><p><img src=../envelopes_scheme.png alt=envelope_scheme></p><p><strong>3 - Overlays :</strong> system for adding more constrained (i.e. lower speed) EnvelopeParts to an existing envelope.</p><font color=#aa026d><h3 id=given-envelopes-vs-calculated-envelopes>Given envelopes vs. calculated envelopes</h3></font><p>During the simulation, the train is supposed to follow certain speed instructions. These are modelled in OSRD by envelopes in the form of space/speed curves. Two types can be distinguished:</p><ul><li>Envelopes from <strong>infrastructure and rolling stock data</strong>, such as maximum line speed and maximum train speed. Being input data for our calculation, they do not correspond to curves with a physical meaning, as they are not derived from the results of a real integration of the physical equations of motion.</li><li>The envelopes result from <strong>real integration</strong> of the physical equations of motion. They correspond to a curve that is physically tenable by the train and also contain time information.</li></ul><p>A simple example to illustrate this difference: if we simulate a TER journey on a mountain line, one of the input data will be a maximum speed envelope of 160km/h, corresponding to the maximum speed of our TER. However, this envelope does not correspond to a physical reality, as it is possible that on certain sections the gradient is too steep for the train to be able to maintain this maximum speed of 160km/h. The calculated envelope will therefore show in this example a speed drop in the steepest areas, where the envelope given was perfectly flat.</p><font color=#aa026d><h3 id=simulation-of-several-trains>Simulation of several trains</h3></font><p>In the case of the simulation of many trains, the signalling system must ensure <strong>safety</strong>. The effect of signalling on the running calculation of a train is reproduced by superimposing dynamic envelopes on the static envelope. A new dynamic envelope is introduced for example when a signal closes. The train follows the static economic envelope superimposed on the dynamic envelopes, if any. In this simulation mode, a time check is performed against a theoretical time from the time information of the static economic envelope. If the train is late with respect to the scheduled time, it stops following the economic envelope and tries to go faster. Its space/speed curve will therefore be limited by the maximum effort envelope.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-8a7d650e7008d319d63327b9d7bb4ff5>2.2.4 - Pipeline</h1><p>The walk calculation in OSRD is a 4-step process, each using <a href=../envelopes_system>the envelopes system</a>:</p><ol><li><a href=#calculation-of-the-most-restricted-speed-profile-mrsp>Construction of the most restrictive speed profile</a></li><li><a href=#calculation-of-the-max-speed-profile>Addition of the different braking curves</a></li><li><a href=#calculation-of-the-max-effort-profile>Adding the different acceleration curves and checking the constant speed curves</a></li><li><a href=#application-of-allowances>Application of allowance(s)</a></li></ol><p>&nbsp;</p><font color=#aa026d><h3 id=calculation-of-the-most-restricted-speed-profile-mrsp>Calculation of the Most Restricted Speed Profile (MRSP)</h3></font><p>A first envelope is calculated at the beginning of the simulation by grouping all static velocity limits:</p><ul><li>maximum line speed</li><li>maximum speed of rolling stock</li><li>temporary speed limits (e.g. in case of works on a line)</li><li>speed limits by train category</li><li>speed limits according to train load</li><li>speed limits corresponding to signposts</li></ul><p>The length of the train is also taken into account to ensure that the train does not accelerate until its tail leaves the slowest speed zone. An offset is then applied to the red dashed curve. The resulting envelope (black curve) is called the <strong>Most Restricted Speed Profile (MRSP)</strong>. It is on this envelope that the following steps will be calculated.</p><p><img src=../mrsp.png alt="Most Restricted Speed Profile"></p><blockquote><p>The red dotted line represents the maximum permitted speed depending on the position.
The black line represents the MRSP where the train length has been taken into account.</p></blockquote><p>It should be noted that the different envelopeParts composing the MRSP are input data, so they do not correspond to curves with a physical reality.</p><font color=#aa026d><h3 id=calculation-of-the-max-speed-profile>Calculation of the Max Speed Profile</h3></font><p>Starting from the MRSP, all braking curves are calculated using the overlay system (see <a href=../envelopes_system/#a-specific-interface-in-the-osrd-core-service>here</a> for more details on overlays), i.e. by creating envelopeParts which will be more restrictive than the MRSP. The resulting curve is called <strong>Max Speed Profile</strong>. This is the maximum speed envelope of the train, taking into account its braking capabilities.</p><p>Since braking curves have an imposed end point and the braking equation has no analytical solution, it is impossible to predict their starting point. The braking curves are therefore calculated backwards from their target point, i.e. the point in space where a certain speed limit is imposed (finite target speed) or the stopping point (zero target speed).</p><p><img src=../msp.png alt="Max Speed Profile"></p><p>For historical reasons in hourly production, braking curves are calculated at SNCF with a fixed deceleration, the so-called hourly deceleration (typically ~0.5m/s²) without taking into account the other forces. This method has therefore also been implemented in OSRD, allowing the calculation of braking in two different ways: with this hourly rate or with a braking force that is simply added to the other forces.</p><font color=#aa026d><h3 id=calculation-of-the-max-effort-profile>Calculation of the Max Effort Profile</h3></font><p>For each point corresponding to an increase in speed in the MRSP or at the end of a stop braking curve, an acceleration curve is calculated. The acceleration curves are calculated taking into account all active forces (traction force, driving resistance, weight) and therefore have a physical meaning.</p><p>For envelopeParts whose physical meaning has not yet been verified (which at this stage are the constant speed running phases, always coming from the MRSP), a new integration of the equations of motion is performed. This last calculation is necessary to take into account possible speed stalls in case the train is physically unable to hold its speed, typically in the presence of steep ramps (see <a href=../envelopes_system/#given-envelopes-vs.-calculated-envelopes>this example</a>).</p><p>The envelope that results from the addition of the acceleration curves and the verification of the speed plates is called the <strong>Max Effort Profile</strong>.</p><p><img src=../mep.png alt="Max Effort Profile"></p><p>At this stage, the resulting envelope is continuous and has a physical meaning from start to finish. The train accelerates to the maximum, runs as fast as possible according to the different speed limits and driving capabilities, and brakes to the maximum. The resulting travel calculation is called the <strong>basic running time</strong>. It corresponds to the fastest possible route for the given rolling stock on the given route.</p><font color=#aa026d><h3 id=application-of-allowances>Application of allowance(s)</h3></font><p>After the calculation of the basic run (corresponding to the Max Effort Profile in OSRD), it is possible to apply allowances. Allowances are additions of extra time to the train&rsquo;s journey. They are used to allow the train to catch up if necessary or for other operational purposes (more details on allowances <a href=../allowances>here</a>).</p><p>A new <strong>Allowances</strong> envelope is therefore calculated using overlays to distribute the allowance requested by the user over the maximum effort envelope calculated previously.</p><p><img src=../allowances.png alt=Allowances></p><p>In the OSRD running calculation it is possible to distribute the allowances in a linear way, by lowering all speeds by a certain factor, or in an economic way, i.e. by minimising the energy consumption during the train run.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-1e84eea96c6b439c99ded337aa3be95b>2.2.5 - Allowances</h1><font color=#aa026d><h3 id=the-purpose-of-allowances>The purpose of allowances</h3></font><p>As explained in the <a href=../pipeline/#calculation-of-the-max-effort-profile>calcul du Max Effort Profile</a>, the <strong>basic running time</strong> represents the most stretched run normally achievable, i.e. the fastest possible run of the given equipment on the given route. The train accelerates to the maximum, travels as fast as possible according to the different speed limits and driving capabilities, and brakes to the maximum.</p><p>This basic run has a major disadvantage: if a train leaves 10 minutes late, it will arrive at best 10 minutes late, because by definition it is impossible for it to run faster than the basic run. Therefore, trains are scheduled with one or more allowances added. The allowances are a relaxation of the train&rsquo;s route, an addition of time to the scheduled timetable, which inevitably results in a lowering of running speeds.</p><blockquote><p>A train running in basic gear is unable to catch up!</p></blockquote><font color=#aa026d><h3 id=allowances-types>Allowances types</h3></font><p>There are two types of allowances:</p><ul><li><strong>The regularity allowance</strong>: this is the additional time added to the basic running time to take account of the inaccuracy of speed measurement, to compensate for the consequences of external incidents that disrupt the theoretical run of trains, and to maintain the regularity of the traffic. The regularity allowance applies to the whole route, although its value may change at certain intervals.</li><li><strong>The construction allowance</strong>: this is the time added/removed on a specific interval, in addition to the regularity allowance, but this time for operational reasons (dodging another train, clearing a track more quickly, etc.)</li></ul><p>A basic running time with an added allowance of regularity gives what is known as a <strong>standard walk</strong>.</p><font color=#aa026d><h3 id=allowance-distribution>Allowance distribution</h3></font><p>Since the addition of allowance results in lower speeds along the route, there are a number of possible routes. Indeed, there are an infinite number of solutions that result in the same journey time.</p><p>As a simple example, in order to reduce the running time of a train by 10% of its journey time, it is possible to extend any stop by the time equivalent to this 10%, just as it is possible to run at 1/1.1 = 90.9% of the train&rsquo;s capacity over the entire route, or to run slower, but only at high speeds&mldr;</p><p>There are currently two algorithms for margin distribution in OSRD: linear and economic.</p><font color=#aa026d><h3 id=linear-distribution>Linear distribution</h3></font><p>Linear allowance distribution is simply lowering the speeds by the same factor over the area where the user applies the allowance. Here is an example of its application:</p><p><img src=../python_plot_linear.png alt="Python plot linear"></p><p>The advantage of this distribution is that the allowance is spread evenly over the entire journey. A train that is late on 30% of its journey will have 70% of its allowance for the remaining 70% of its journey.</p><font color=#aa026d><h3 id=economic-distribution>Economic distribution</h3></font><p>The economic distribution of the allowance, presented in detail in <a href=/pdf/MARECO.pdf>this document</a> (<strong>MARECO</strong> is an algorithm designed by the SNCF research department), consists of distributing the allowance in the most energy-efficient way possible. It is based on two principles:</p><ol><li>a maximum speed, avoiding the most energy-intensive speeds</li><li>run-on zones, located before braking and steep gradients, where the train runs with the engine off thanks to its inertia, allowing it to consume no energy during this period</li></ol><p><img src=../python_plot_eco_w_slopes.png alt="Python plot eco with slopes"></p><blockquote><p>An example of economic walking. Above, the gradients/ramps encountered by the train. The areas of travel on the track are shown in blue.</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-f94607d1fa8cd3ff18c7a975b41a1e82>3 - How-to Guides</h1><div class=lead>Recipes for addressing key problems and use-cases</div><p>How-to guides are recipes. They guide you through the steps involved in addressing key problems and use-cases. They are more advanced than tutorials and assume some knowledge of how OSRD works.</p></div><div class=td-content><h1 id=pg-3ce54efed8813f1db94e060b5c4d3dba>3.1 - Contribute to OSRD</h1><div class=lead>Learn about the how we work, and how you can work with us</div><p>First off, thanks for taking the time to contribute!</p><p>The following chapters are a set of guidelines for contributing to OSRD<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. If you have already contributed to open source projects before, you probably won&rsquo;t be surprised.
If you have not, it will probably help a lot!</p><h3 id=communicate>Communicate</h3><p>Chatting with other contributors is a great way to speed things up:</p><ul><li>Join our instant messaging room on IRC at <a href=https://web.libera.chat/#osrd>libera.chat#osrd</a></li><li><a href=https://github.com/osrd-project/osrd/issues/new/choose><strong>Create an issue</strong></a> to discuss your contribution project</li></ul><h3 id=inquire>Inquire</h3><p>Just like with any project, changes rely on past work.
Before making changes, it is best to learn about what&rsquo;s already there:</p><ul><li><a href=https://osrd.fr/en/docs/>read technical documentation</a></li><li>read the existing source code related to your project</li><li>chat with developers who last worked on areas you are interested in</li></ul><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>These guidelines are mostly not strict rules, it&rsquo;s probably fine to do things slightly differently.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=td-content style=page-break-before:always><h1 id=pg-447ef90d37a1cd8a734c648d8c6dfc8e>3.1.1 - Report issues</h1><div class=lead>Report a bug or suggest an enhancement</div><p><strong>Please report anything you deem significant!</strong></p><p>Our bug tracking platform is <a href=https://github.com/osrd-project/osrd/issues>github</a>, so you have to register to report bugs.</p><p>Follow <a href=https://github.com/osrd-project/osrd/issues/new/choose>this link</a> and pick whatever template fits the best.</p><h3 id=bugs>Bugs</h3><ul><li>Bug must have a correct description and the bug&rsquo;s issue template must be filled carefully.</li><li>Bug must be tagged with (<em>for team members</em>):<ul><li><code>kind:bug</code></li><li>one or several <code>area:&lt;affected_area></code> if possible, if the affected area is not known leave it blank it will be added later by another team member.</li><li>one <code>severity:&lt;bug_severity></code> if possible, if severity is not known leave it blank it will be added later by another team member.<ul><li><code>severity:minor</code>: User can still use the feature.</li><li><code>severity:major</code>: User sometimes can&rsquo;t use the feature.</li><li><code>severity:critical</code>: User can&rsquo;t use the feature.</li></ul></li></ul></li><li>OSRD team members can change issues&rsquo; tags (severity, area, kind, &mldr;).
You may leave a comment to explain changes.</li><li>If you are working on a bug or plan to work on a bug, assign yourself to the bug.</li><li>PRs solving bugs should add a regression tests to ensure that bug will not be back in the future.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-6b7c59f2efb6c7b3add25b04a63e3942>3.1.2 - Contribute code</h1><div class=lead>Integrate changes into OSRD</div><h2 id=set-things-up>Set things up</h2><div class="alert alert-info" role=alert>Most OSRD developers use Linux (incl. <a href=https://learn.microsoft.com/en-us/windows/wsl/>WSL</a>). Windows and MacOS should work too, but you may run into some issues.</div><h3 id=get-the-source-code>Get the source code</h3><ul><li>Install <a href=https://git-scm.com/><code>git</code></a>.<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></li><li>Open a terminal<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> in the folder where the source code of OSRD will be located</li><li>Run <code>git clone git@github.com:osrd-project/osrd</code></li></ul><h3 id=launch-the-application>Launch the application</h3><p>Thanks to <code>docker</code>, one can easily compile, configure, and run all services after making a change. One can also start only a subset of the services.</p><ul><li>Install <code>docker</code>. <sup id=fnref1:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup><sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></li><li>Follow <a href=https://github.com/osrd-project/osrd#getting-started>OSRD&rsquo;s README</a>.</li></ul><h2 id=share-your-changes>Share your changes</h2><div class="alert alert-warning" role=alert><p>The source code of OSRD is available under <a href=https://choosealicense.com/licenses/lgpl-3.0/>the LGPLv3 license</a>.
By contributing to the codebase, you consent to the distribution of your changes under the project&rsquo;s license.</p><p>LGPLv3 forbids modifying source code without sharing the changes under the same license: use other people&rsquo;s work, and share yours!</p><p>This constraint does not propagate through APIs: You can use OSRD as a library, framework or API server to interface with proprietary software. Please suggest changes if you need new interfaces.</p></div><p>This chapter is about the process of integrating changes into the common code base. <strong>If you need help at any stage, open an issue or message us.</strong></p><ol><li><p>If you are not used to Git, <a href=https://learngitbranching.js.org/>follow this tutorial</a></p></li><li><p><strong>Create a branch</strong><br>If you intend to contribute regularly, you can request access to the <a href=https://github.com/osrd-project/osrd>main repository</a>. Otherwise, <a href=https://github.com/osrd-project/osrd/fork>create a fork</a>.</p></li><li><p><strong>Add changes to your branch</strong><br>Before you start working, try to split your work into macroscopic steps.
At the end of each stop, save your changes into a commit.
Try to make commits of logical and atomic units.
Try to follow <a href=../conventions/>style conventions</a>.</p></li><li><p><strong>Keep your branch up-to-date</strong></p><pre tabindex=0><code>git switch &lt;your_branch&gt;
git fetch
git rebase origin/dev
</code></pre></li><li><p><strong>Open a pull request</strong><br>Once your changes are ready, you have to request integration with the <code>dev</code> branch.
If possible, make PR of logical and atomic units too (avoid mixing refactoring, new features and bug fix at the same time).
Add a description to PRs to explain what they do and why.
Help the reviewer by following advice given in <a href=https://mtlynch.io/code-review-love/>mtlynch article</a>.
Add tags <code>Area:&lt;affected_area></code> to show which part of the application have been impacted.
It can be done through <a href=https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request>the web interface</a>.</p></li><li><p><strong>Take feedback into account</strong><br>Once your pull request is open, <a href=https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/reviewing-changes-in-pull-requests/about-pull-request-reviews>other contributors can review your changes</a>:</p><ul><li>Any user can review your changes</li><li>Your code has to be approved by a contributor <a href=https://github.com/osrd-project/osrd/blob/dev/.github/CODEOWNERS>familiar with the code</a></li><li>All users are expected to take comments into account.</li><li>Comments tend to be written in an open and direct manner.
The intent is to efficiently collaborate towards a solution we all agree on.</li><li>Once all discussions are resolved, a maintainer integrates the change.</li></ul><p>As a reviewer try to follow advice given in <a href=https://mtlynch.io/human-code-reviews-1/>mtlynch article</a>.</p></li><li><p><strong>If you believe somebody forgot to review / merge your change, please speak out, multiple times if needs be.</strong></p></li></ol><h2 id=git-commit-style>Git commit style</h2><p>The overall format for git commits is as follows:</p><pre tabindex=0><code>component: imperative description of the change

Detailed description of the change and what motivates it,
if it is not entirely obvious from the title.
</code></pre><ul><li><strong>the commit message, just like the code, must be in english</strong></li><li>all lowercase</li><li>there can be multiple components separated by <code>:</code> in case of hierarchical relationships, with <code>,</code> otherwise</li><li>the body of the commit should probably contain a detailed description of the change</li></ul><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Under Linux, use your distribution&rsquo;s package manager, such as <code>apt-get</code>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Under Windows, open <code>Git Bash</code>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Under Windows/<a href=https://learn.microsoft.com/en-us/windows/wsl/tutorials/wsl-containers>WSL</a>, <a href=https://www.docker.com/products/docker-desktop/>Docker Desktop</a> is recommended&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6a4bbd8a33a31373a2271e2003cd8d5f>3.1.3 - Style guide</h1><div class=lead>Coding style guide and best practices</div><p>OSRD application is split in multiple services written in several languages. We try to follow general code best practices and follow specificity for each languages when required.</p><h2 id=general-rules>General rules</h2><ul><li>Explain what you&rsquo;re doing and why.</li><li>Document new code with doc comments.</li><li>Include clear, simple tests.</li><li>Break work into digestible chunks.</li><li>Take the time to pick good names.</li><li>Avoid non well-known abbreviations.</li><li><strong>Control and consistency over 3rd party code reuse</strong>: Only add a dependency if it is absolutely necessary.</li><li>Every dependency we add decreases our autonomy and consistency.</li><li><strong>Don&rsquo;t reinvent every wheel</strong>: As a counter to the previous point, don&rsquo;t reinvent everything at all costs.</li><li>If there is a dependency in the ecosystem that is the &ldquo;de-facto&rdquo; standard, we should heavily consider using it.</li><li>More code general recommendations in main repository <a href=https://github.com/osrd-project/osrd>CONTRIBUTING.md</a>.</li><li>Ask for any help that you need!</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d807e8178df334af7c93ed0e4b021fdd>3.1.3.1 - Back-end</h1><div class=lead>Coding style guide and best practices for back-end</div><h1 id=python>Python</h1><p>Python code is used for some packages and integration testing.</p><ul><li>Follow <a href=https://www.python.org/dev/peps/pep-0020/>the Zen of Python</a>.</li><li>Code is linted with <a href=https://github.com/csachs/pyproject-flake8>flake8</a>.</li><li>Code is formatted with <a href=https://github.com/psf/black>Black</a>.</li><li>Imports are sorted with <a href=https://github.com/PyCQA/isort>Isort</a>.</li><li>Python tests are written using <a href=https://docs.pytest.org/>pytest</a>.</li><li>Typing is checked using <a href=https://google.github.io/pytype/>pytype</a>.</li></ul><h1 id=rust>Rust</h1><ul><li>As a reference for our API development we are using the <a href=https://rust-lang.github.io/api-guidelines/about.html>Rust API guidelines</a>.
Generally, these should be followed.</li><li>Prefer granular imports over glob imports like <code>diesel::*</code>.</li><li>Tests are written with the <a href=https://doc.rust-lang.org/book/ch11-01-writing-tests.html>built-in testing framework</a>.</li><li>Use the <a href=https://doc.rust-lang.org/rust-by-example/meta/doc.html>documentation example</a> to know how to phrase and format your documentation.</li><li>Use consistent comment style:<ul><li><code>///</code> doc comments belong above <code>#[derive(Trait)]</code> invocations.</li><li><code>//</code> comments should generally go above the line in question, rather than in-line.</li><li>Start comments with capital letters. End them with a period if they are sentence-like.</li></ul></li><li>Use comments to organize long and complex stretches of code that can&rsquo;t sensibly be refactored into separate functions.</li><li>Code is linted with <a href=https://github.com/rust-lang/rust-clippy>clippy</a>.</li><li>Code is formatted with <a href=https://github.com/rust-lang/rustfmt>fmt</a>.</li></ul><h1 id=java>Java</h1><ul><li>Code is formatted with <a href=https://checkstyle.sourceforge.io/>checkstyle</a>.</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-53dd3533e7509ff0ea0773799bcd2e23>3.1.3.2 - Front-end</h1><div class=lead>Coding style guide and best practices for front-end</div><p>Nous utilisons <strong>ReactJS</strong> et tous les fichiers doivent être écrits en <strong>Typescript</strong>.</p><p>Le code est <strong>linté</strong> avec <a href=https://eslint.org/>eslint</a>, et <strong>formaté</strong> avec <a href=https://prettier.io/>prettier</a>.</p><h2 id=nomenclature>Nomenclature</h2><p><img src=../nomenclature-front-end.svg alt="Diagramme de l&amp;rsquo;Infrastructure"></p><p>Les <strong>applications</strong> (osrd eex, osrd stdcm, éditeur infra, éditeur matériel) proposent des <strong>vues</strong> (gestion des projets, gestions des études, etc.) liées à des <strong>modules</strong> (projet, étude, etc.) qui contiennent les composants.</p><p>Ces <strong>vues</strong> sont constituées de <strong>composants</strong> et sous-composants <u>tous issus des modules</u>.
En plus de contenir les fichiers de <strong>vues</strong> des applications, elles peuvent contenir un répertoire <strong>scripts</strong> qui propose des scripts liés à ces vues. Les <strong>vues</strong> déterminent la logique et l&rsquo;<u>accès au store</u>.</p><p>Les <strong>modules</strong> sont des collections de <strong>composants</strong> rattachés à un <strong>objet</strong> (un scénario, un matériel roulant, un TrainSchedule). Ils contiennent :</p><ul><li>un répertoire <em>components</em> qui héberge <u>tous</u> les composants</li><li>un répertoire <em>styles</em> optionnel <u>par module</u> pour le style des composants en scss</li><li>un répertoire <em>assets</em> optionnel <u>par module</u> (qui contient les assets, de jeux de données par défaut par ex, spécifiques au module)</li><li>un fichier <em>reducers</em> optionnel <u>par module</u></li><li>un fichier <em>types</em> optionnel <u>par module</u></li><li>un fichier <em>consts</em> optionnel <u>par module</u></li></ul><p>Un répertoire <strong>assets</strong> (qui contient les images et autre fichiers).</p><p>Enfin, un répertoire <strong>common</strong> qui propose :</p><ul><li>un répertoire <em>utils</em> pour les fonctions utilitaires communes à l&rsquo;ensemble du projet</li><li>un fichier <em>types</em> pour les types communs à l&rsquo;ensemble du projet</li><li>un fichier <em>consts</em> pour les constantes communes à l&rsquo;ensemble du projet</li></ul><h2 id=principes-dimplémentation>Principes d&rsquo;implémentation</h2><h3 id=routage--slug>Routage & SLUG</h3><p><em>Rédaction en cours</em></p><p><code>projects/{nom du projet}/studies/{nom de l'étude}/scenarios/{nom du scenario}</code></p><h3 id=styles--scss>Styles & SCSS</h3><p><em>Rédaction en cours</em></p><h3 id=storeredux>Store/Redux</h3><p>Tout ce qui est <em>selector</em> est géré par la <strong>vue</strong> passé en props aux composants et sous-composants.</p><p>Par conséquent les appels au store en lecture et en écriture doivent être passés un niveau de la vue, en irrigant par des <em>props</em> et <em>states</em> les composants proposées par la vue.</p><h3 id=rtk>RTK</h3><p><em>Rédaction en cours</em></p><p>Utiliser les endpoints générés à partir des fichiers <code>openapi.yaml</code> pour consommer le backend.</p><h2 id=lois-et-éléments-importants>Lois et éléments importants</h2><blockquote><p><strong>Aucun composant ne doit détenir la responsabilité de mise à jour de la donnée qu&rsquo;il utilise</strong></p><p>Seules <u>les vues</u> contiennent les sélecteurs du store, donnés ensuite en props aux composants du module lié à la vue.</p></blockquote><blockquote><p><strong>Le SCSS n&rsquo;est pas scopé</strong></p><p>Un fichier <code>.scss</code> enfoui dans l&rsquo;arborescence ne vous garantit pas que les classes contenues soient seulement accessibles à cet endroit, y compris par import react (formellement interdit au passage : vous devez utiliser l&rsquo;import SCSS), toutes les classes déclarées sont accessibles partout.</p><p>Préférez un choix judicieux de nom de classe racine pour un module donné et utilisez l&rsquo;arborescence possible dans le fichier SCSS.</p></blockquote><blockquote><p><strong>Les liens des imports doivent être absolus au sein d&rsquo;une application</strong></p><p>Vous devez utiliser le <u>chemin complet</u> pour tous vos imports, même si le fichier à importer se trouve dans le même répertoire.</p></blockquote><blockquote><p><strong>Les liens des imports doivent être relatifs au sein d&rsquo;un module ou d&rsquo;un composant</strong></p><p>Au sein d&rsquo;un module ou d&rsquo;un composant, à l&rsquo;instar d&rsquo;une librairie, les liens d&rsquo;imports doivent rester relatifs afin de permettre leur utilisation n&rsquo;importe où.</p></blockquote><h2 id=typescript>TypeScript</h2><h3 id=import--export>import & export</h3><p>We recommend using typed imports and exports.</p><p>When an <code>import</code> or <code>export</code> contains only types, indicate it with the <code>type</code> keyword.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#204a87;font-weight:700>export</span> <span style=color:#204a87;font-weight:700>type</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>Direction</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>DirectionalTrackRange</span> <span style=color:#204a87;font-weight:700>as</span> <span style=color:#000>TrackRange</span> <span style=color:#000;font-weight:700>};</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#204a87;font-weight:700>type</span> <span style=color:#000;font-weight:700>{</span> <span style=color:#000>typedEntries</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ValueOf</span> <span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>from</span> <span style=color:#4e9a06>&#39;utils/types&#39;</span><span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div><p>This allows to:</p><ul><li>Improve the performance and analysis process of the compiler and the linter.</li><li>Make these declarations more readable; we can clearly see what we are importing.</li><li>Avoid dependency cycles:</li></ul><p><img src=./dependency-cycle.png alt="dependency cyle"></p><p>The error disappears with the <code>type</code> keyword</p><p><img src=./dependency-cycle-gone.png alt="dependency cyle"></p><ul><li>Make final bundle lighter (all types disappear at compilation)</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-c279934946faaf1b9c53231507b4a433>3.1.3.3 - Tests</h1><div class=lead>Recommandations for testing purpose</div><h2 id=back-end>Back-end</h2><ul><li>Integration tests are written with <a href=https://docs.pytest.org/>pytest</a> in the <code>/tests</code> folder.</li><li>Each route described in the <code>openapi.yaml</code> files must have an integration test.</li><li>The test must check both the format and content of valid and invalid responses.</li></ul><h2 id=front-end>Front-end</h2><p>The functional writing of the tests is carried out with the <em>Product Owners</em>, and the developers choose a technical implementation that precisely meets the needs expressed and fits in with the recommendations presented here.</p><p>We use <a href=https://playwright.dev/>Playwright</a> to write end-to-end tests, and <a href=https://vitest.dev/>vitest</a> to write unit tests.</p><p>The browsers tested are currently <a href=https://www.mozilla.org/fr/firefox/switch/>Firefox</a> and Chromium.</p><h3 id=basic-principles>Basic principles</h3><ul><li>Tests must be <strong>short</strong> (1min max) and go <strong>straight to the point</strong>.</li><li>Arbitrary timeouts are outlawed; a test must systematically wait for a specific event. It is possible to use <em>polling</em> (retry an action - a click for example - after a certain time) proposed in the <a href=https://playwright.dev/>Playwright&rsquo;s</a> API.</li><li>All tests must be parallelizable.</li><li>Tests must not point to or wait for text elements from the translation, prefer the <em>DOM</em> tree structure or place specific <code>id</code>.</li><li>We&rsquo;re not testing the data, but the application and its functionality. Data-specific tests should be developed in parallel.</li></ul><h4 id=data>Data</h4><p><strong>The data tested must be public data</strong>.
The data required (infrastructure and rolling stock) for the tests are offered in the application&rsquo;s <code>json</code> files, <em>injected</em> at the start of each test and deleted at the end, regardless of its result or how it is stopped, including with <code>CTRL+C</code>.</p><p>This is done by API calls in typescript before launching the actual test.</p><p>The data tested is the same, both locally and via continuous integration.</p><h4 id=atomicity-of-a-test>Atomicity of a test</h4><p>Each test must be <strong>atomic</strong>: it is self-sufficient and cannot be divided.</p><p>A test will target a single feature or component, provided it is not too large. A test will not test an entire module or application; it will necessarily be a set of tests, in order to preserve test atomicity.</p><p>If a test needs elements to be created or added, these operations must be carried out by API calls in typescript upstream of the test, as is done for adding data. These elements must be deleted at the end of the test, regardless of the result or how it is stopped, including by <code>CTRL+C</code>.</p><p>This allows tests to be parallelized.</p><p>However, in certain cases where it is relevant, a test may contain several clearly explained and justified test subdivisions (several <code>test()</code> in a single <code>describe()</code>).</p><h3 id=example-of-a-test>Example of a test</h3><p>The requirement: &ldquo;We want to test the addition of a train to a timetable&rdquo;.</p><ol><li>add the test infrastructure and rolling stock to the database <strong>by API calls</strong>.</li><li>create project, study and scenario with choice of test infrastructure <strong>by API calls</strong>.</li><li>start the test, clicking on &ldquo;add one or more trains&rdquo; until the presence of the trains in the timetable is verified</li><li>the test passes, fails or is stopped, the project, study and scenario are deleted, along with the test rolling stock and infrastructure <strong>by API calls</strong>.</li></ol><p><em>NB: the test will not test all the possibilities offered by the addition of trains; this should be a specific test which would test the response of the interface for all scenarios without adding trains.</em></p></div><div class=td-content style=page-break-before:always><h1 id=pg-dd4202c260f5c017918a0012ac43efba>3.1.4 - Review code</h1><div class=lead>How to give useful feedback</div><figure><a href=https://www.morling.dev/blog/the-code-review-pyramid/><img src=/en/docs/guides/contribute/code-reviews/images/code_review_pyramid.svg></a></figure></div><div class=td-content style=page-break-before:always><h1 id=pg-eb3604af7a44b351ff5c384e457c40c6>4 - Technical reference</h1><div class=lead>Internal machinery and APIs</div><p>Technical reference guides contain technical reference for APIs and other aspects of OSRD&rsquo;s machinery. They describe how it works and how to use it but assume that you have a basic understanding of key concepts.</p></div><div class=td-content><h1 id=pg-956c746a8215379d75cfcf5474a683e3>4.1 - Architecture</h1><div class=lead>Learn more about OSRD architecture</div><p>Architecture documents are meant to help understand how OSRD works overall.</p></div><div class=td-content><h1 id=pg-563493d51cba2cf0991bc456da66a1b1>4.1.1 - Data-flow</h1><div class=lead>OSRD&rsquo;s data-flow diagram</div><p><img src=data_flow.svg alt="Data-flow diagram"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-8c50df3d62cb7d3b188a4daf7e4536fd>4.1.2 - Services</h1><div class=lead>OSRD&rsquo;s services architecture</div><p>It is a multi-service architecture where several software components interact with each other. This choice was made to ensure the modularity of the code and to guarantee the exploitability of certain OSRD services by external applications.</p><p><img src=services.en.svg alt="Services architecture"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-9bd47f930a6befba383b5f079fd5620d>4.2 - Design documents</h1><div class=lead>Learn more about how the software was designed</div><p>Design documents are meant to help understand and participate in designing software.</p><p>Each design document describes a number of things about a piece of software:</p><ul><li>its goals</li><li>its constraints</li><li>how its inputs and outputs were modeled</li><li>how it works</li></ul></div><div class=td-content><h1 id=pg-0289c7adf583e85ce535e627617fcb3a>4.2.1 - Signaling</h1><div class=lead>Describes the signaling model</div><div class="pageinfo pageinfo-warning"><p>This document is pending review</p></div><h2 id=description>Description</h2><p>The signaling layer includes all signals, which respond to track occupancy and
reservation. Signals can be of different types, and are modularly loaded. Only
their behavior towards the state of the infrastructure and the train&rsquo;s reaction
to signaling matters.</p><p>Signals are connected to each other by blocks. Blocks define the movements
authorized by signaling.</p><h2 id=goals>Goals</h2><p>The signaling system is at the crossroads of many needs:</p><ul><li>it must allow for realistic signaling simulation in a multi-train simulation</li><li>it must allow the conflict detection system to determine which resources are required for the train</li><li>it must allow application users to edit and display signals</li><li>it must allow for visualization of signals on a map</li></ul><h2 id=design-requirements>Design requirements:</h2><p>Static data:</p><ul><li>must enable the front-end to display the signals</li><li>must enable the infrastructure editor to configure signals</li><li>must enable the back-end to simulate signals</li><li>must be close to realistic industry models</li><li>must allow for the modeling of composite signals, which carry several
logical signals within a single physical signal</li></ul><p>To simulate signaling:</p><ul><li>blocks must be generated for both user convenience and <strong>pathfinding</strong></li><li>for each signal, its <strong>next compatible signal</strong> and <strong>protected zones</strong> must be deduced</li><li>the <strong>minimum necessary information</strong> must be provided to the signaling modules for their operation</li><li>using signaling modules without having to instantiate a complete simulation must be enabled</li><li>the design of the signaling module API must allow for signals to be loaded in any order</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># unique identifier for the signaling system</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;id&#34;: </span><span style=color:#4e9a06>&#34;BAL&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;version&#34;: </span><span style=color:#4e9a06>&#34;1.0&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># a list of roles the system assumes</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;roles&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;MA&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;SPEED_LIMITS&#34;</span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># the schema of the dynamic state of signals of this type</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;signal_state&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;enum&#34;, &#34;field_name&#34;: </span><span style=color:#4e9a06>&#34;aspect&#34;</span><span style=color:#204a87;font-weight:700>, values</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;VL&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;A&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;S&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;C&#34;</span><span style=color:#000;font-weight:700>]</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: </span><span style=color:#4e9a06>&#34;ralen30&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: </span><span style=color:#4e9a06>&#34;ralen60&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: </span><span style=color:#4e9a06>&#34;ralen_rappel&#34;</span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># the schema of the settings signals of this type can read</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;signal_settings&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: &#34;Nf&#34;, &#34;display_name&#34;: </span><span style=color:#4e9a06>&#34;Non-franchissable&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: &#34;has_ralen30&#34;, &#34;default&#34;: false, &#34;display_name&#34;: </span><span style=color:#4e9a06>&#34;Ralen 30&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: &#34;has_rappel30&#34;, &#34;default&#34;: false, &#34;display_name&#34;: </span><span style=color:#4e9a06>&#34;Rappel 30&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: &#34;has_ralen60&#34;, &#34;default&#34;: false, &#34;display_name&#34;: </span><span style=color:#4e9a06>&#34;Ralen 60&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#204a87;font-weight:700>&#34;kind&#34;: &#34;flag&#34;, &#34;field_name&#34;: &#34;has_rappel60&#34;, &#34;default&#34;: false, &#34;display_name&#34;: </span><span style=color:#4e9a06>&#34;Rappel 60&#34;</span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>],</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># these are C-like boolean expressions:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># true, false, &lt;flag&gt;, &lt;enum&gt; == value, &amp;&amp;, || and ! can be used</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># used to evaluate whether a signal is a block boundary.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;block_boundary_when&#34;: </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># used to evaluate whether a signal is a route boundary.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;route_boundary_when&#34;: </span><span style=color:#4e9a06>&#34;Nf&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># used for naive conflict detection.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;constraining_ma_when&#34;: </span><span style=color:#4e9a06>&#34;aspect != VL&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h2 id=assumptions>Assumptions</h2><ul><li>Each physical signal can be decomposed into a list of logical signals, all of which are associated with a signaling system.</li><li>Blocks have a type.</li><li>It is possible to determine, given only the signal, its delimiting properties.</li><li>Blocks never cross route boundaries.</li><li>Blocks which are not covered by routes do not exist, or can be ignored.</li><li>At any time, trains only use one signaling system capable of transmitting movement authority.</li></ul><h1 id=design-of-signaling-systems>Design of Signaling Systems</h1><p>Each signaling system has:</p><ul><li>A unique identifier (a string).</li><li>A set of roles:<ul><li>Transmission of Movement Authority</li><li>Transmission of speed limits</li></ul></li><li>Its signal state type, which enables deducing:<ul><li>The graphical representation of the signal</li><li>How a train would react to the signal</li><li>If the signal state constrains Movement Authority</li></ul></li><li>The signal parameter types, names and description, which enable front-end edition of signal parameters.</li><li>The block and route conditions, which enable evaluating whether a signal delimits blocks or routes, given its parameters.</li></ul><p>Note that if a signaling system has a dual role of transmitting Movement Authority (MA) and speed
limits, not all signals in this system are necessarily tasked with transmitting
speed limit information.</p><h1 id=design-of-blocks>Design of blocks</h1><p>The blocks have several attributes:</p><ul><li>A signaling system that corresponds to that displayed by its first signal.</li><li>A <strong>path</strong>, which is a list of direction + detector pairs (just like route paths).</li><li>An <strong>entry signal</strong>, (optional when the block starts from a buffer stop).</li><li><strong>Intermediate signals</strong>, if any (only used by systems with distant signals).</li><li>An <strong>exit signal</strong>, (optional when the block ends at a buffer stop).</li></ul><p>The path is expressed from detector to detector so that it can be overlayed with the route graph.</p><p>A few remarks:</p><ul><li>There can be multiple blocks with the same path, as long as they have different signaling systems. Trains only use a block at a time, and ignore others.</li><li>Blocks do not have a state: one can rely on the dynamic state of the zones that make it up.</li><li>Blocks are used to figure out which signals protect which zones in a given context.</li></ul><h1 id=design-of-signals>Design of signals</h1><p>Physical signal are made up of one or more logical signals, which are displayed as a single unit on the field. During simulation, logical signals are treated as separate signals.</p><p>Each logical signal is associated with a signaling system, which defines if the
signal transmits Movement Authority, speed limits, or both.</p><p>Logical signals have one or more drivers. Signal drivers are responsible for computing
signal state. Any given signal driver only works for a given pair of signaling systems,
where the first one is displayed by the signal, and the second is the one displayed by
the next signal.</p><p>When a logical signal has an empty driver list, its content is deduced from neighboring signals.</p><p>For example, a BAL signal that is both a departure of the TVM block and a
departure of the BAL block, it will have two drivers: <code>BAL-BAL</code> and <code>BAL-TVM</code>.</p><h2 id=raw-signal-format>Raw signal format</h2><p>The raw signal format is the user-editable description of a physical signal.</p><p>Raw signals have a list of logical signals, which are independently simulated units sharing
a common physical display. Each logical signal has:</p><ul><li>a signaling system</li><li>user-editable settings, as specified in the signaling system description</li><li>a list of allowed next signaling systems, which are used to load drivers</li></ul><p>For example, this signal encodes a BAL signal which starts both a BAL and a TVM block:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># signals must have location data.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># this data is omitted as its format is irrelevant to how signals behave</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;logical_signals&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#8f5902;font-style:italic># the signaling system shown by the signal</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;signaling_system&#34;: </span><span style=color:#4e9a06>&#34;BAL&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#8f5902;font-style:italic># the settings for this signal, as defined in the signaling system manifest</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;settings&#34;: {&#34;has_ralen30&#34;: &#34;true&#34;, &#34;Nf&#34;: </span><span style=color:#4e9a06>&#34;true&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#8f5902;font-style:italic># this signal can react to BAL or TVM signals</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#8f5902;font-style:italic># if the list is empty, the signal is assumed to be compatible with all following signaling systems</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;next_signaling_systems&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;BAL&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;TVM&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>For example, this signal encodes a BAL signal which starts a BAL block, and shares its physical display / support with a BAPR signal starting a BAPR block:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># signals must have location data.</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># this data is omitted as its format is irrelevant to how signals behave</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>&#34;logical_signals&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;signaling_system&#34;: </span><span style=color:#4e9a06>&#34;BAL&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;settings&#34;: {&#34;has_ralen30&#34;: &#34;true&#34;, &#34;Nf&#34;: </span><span style=color:#4e9a06>&#34;true&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;next_signaling_systems&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;BAL&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>{<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;signaling_system&#34;: </span><span style=color:#4e9a06>&#34;BAPR&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;settings&#34;: {&#34;Nf&#34;: &#34;true&#34;, &#34;distant&#34;: </span><span style=color:#4e9a06>&#34;false&#34;</span>}<span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>&#34;next_signaling_systems&#34;: </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;BAPR&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Such signal descriptions can be condensed down into a simplified description string, for the specific use-case of representing / generating signal icons: <code>BAL[Nf=true,ralen30=true]+BAPR[Nf=true,distant=false]</code></p><h3 id=loading-signal-parameters>Loading Signal Parameters</h3><p>The first step of loading the signal is to characterize the signal in the signaling system.
This step produces an object that describes the signal.</p><p>During the loading of the signal:</p><ul><li>the signaling system corresponding to the provided name is identified</li><li>the signal parameters are loaded and validated according to the signaling system spec</li><li>the signal&rsquo;s block and route delimiting properties are evaluated</li></ul><h3 id=loading-the-signal>Loading the Signal</h3><p>Once signal parameters are loaded, drivers can be loaded. For each driver:</p><ul><li>The driver implementation is identified from the <code>(signaling_system, next_signaling_system)</code> pair.</li><li>It is verified that the signaling system outgoing from the driver corresponds to the one of the signal.</li><li>It is verified that there is no existing driver for the incoming signaling system of the driver.</li></ul><p>This step produces a <code>Map&lt;SignalingSystem, SignalDriver></code>, where the signaling
system is the one incoming to the signal. It then becomes possible to construct
the loaded signal.</p><h3 id=constructing-blocks>Constructing Blocks</h3><ul><li>The framework creates blocks between signals following the routes present in the infrastructure, and the block properties of the signals.</li><li>Checks are made on the created block graph: it must always be possible to choose a block for each signal and each state of the infrastructure.</li></ul><h3 id=speed-limits>Speed Limits</h3><p>Speed limits are represented as ranges on routes.
They start their life as ranges on track sections, and are lifted to ranges on routes as follows:</p><ul><li>Directional speed limits by track are elevated to routes. The same speed limit can be on multiple routes.</li><li>For each speed limit, the route graph is traversed in reverse searching for signals capable of handling the limit:<ul><li>Only speed limits not preceded by another limit with identical properties are considered.</li><li>Each signal must signal its interest in a speed limit: Not concerned, Concerned but to be announced by another signal, or Concerned and terminal.</li></ul></li><li>For each speed limit planned along the train&rsquo;s path, the signals in the announcement chain are added to the list of those to be simulated for the train.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>SpeedLimitHandling</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/** This signal isn&#39;t supposed to announce this limit */</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Ignore</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/** This signal should announce this limit, but cannot */</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/** This signal can announce this limit, and is part of an ongoing chain */</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>Chain</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>/** This signal can announce this limit, and ends the chain */</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>EndChain</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>handles_speed_limit</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#3465a4>self</span>: <span style=color:#000>SignalSettings</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>speed_limit</span>: <span style=color:#000>SpeedLimit</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>distance_mm</span>: <span style=color:#204a87;font-weight:700>u64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>SpeedLimitHandling</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>handles_speed_limit_chain</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#3465a4>self</span>: <span style=color:#000>SignalSettings</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>speed_limit</span>: <span style=color:#000>SpeedLimit</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>chain_signal</span>: <span style=color:#000>Signal</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>distance_mm</span>: <span style=color:#204a87;font-weight:700>u64</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8;text-decoration:underline> </span>-&gt; <span style=color:#000>SpeedLimitHandling</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=block-validation>Block validation</h3><p>The validation process helps to report invalid configurations in terms of signaling and blockage. The validation cases we want to support are:</p><ul><li>The signaling system may want to validate, knowing if the block starts / ends on a buffer:<ul><li>the length of the block</li><li>the spacing between the block signals, first signal excluded</li></ul></li><li>Each signal in the block may have specific information if it is a transition signal. Therefore, all signal drivers participate in the validation.</li></ul><p>In practice, there are two separate mechanisms to address these two needs:</p><ul><li>The <strong>signaling system module</strong> is responsible for validating signaling <strong>within</strong> blocks.</li><li><strong>Signal drivers</strong> take care of validating transitions <strong>between</strong> blocks.</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>extern</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>report_warning</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>/* TODO */</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>extern</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>report_error</span><span style=color:#000;font-weight:700>(</span><span style=color:#8f5902;font-style:italic>/* TODO */</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>Block</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>startsAtBufferStop</span>: <span style=color:#204a87;font-weight:700>bool</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>stopsAtBufferStop</span>: <span style=color:#204a87;font-weight:700>bool</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>signalTypes</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SignalingSystemId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>signalSettings</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SignalSettings</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>signalPositions</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>Distance</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>length</span>: <span style=color:#000>Distance</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/// Runs in the signaling system module
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>check_block</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>block</span>: <span style=color:#000>Block</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>/// Runs in the signal driver module
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>fn</span> <span style=color:#000>check_signal</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>signal</span>: <span style=color:#000>SignalSettings</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#000>block</span>: <span style=color:#000>Block</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>// The partial block downstream of the signal - no signal can see backward
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><h3 id=signal-lifecycle>Signal lifecycle</h3><p>Before a train startup:</p><ul><li>the path a of the train can be expressed is given, both as routes and blocks</li><li>the signal queue a train will encounter is established</li></ul><p>During the simulation:</p><ul><li>along a train movement, the track occupation before it are synthesized</li><li>when a train observes a signal, its state is evaluated</li></ul><h3 id=signal-state-evaluation>Signal state evaluation</h3><p>Signals are modeled as an evaluation function, taking a view of the world and returning the signal state</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>enum</span> <span style=color:#000>ZoneStatus</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>   <span style=color:#8f5902;font-style:italic>/** The zone is clear to be used by the train */</span>
</span></span><span style=display:flex><span>   <span style=color:#000>CLEAR</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>   <span style=color:#8f5902;font-style:italic>/** The zone is occupied by another train, but otherwise clear to use */</span>
</span></span><span style=display:flex><span>   <span style=color:#000>OCCUPIED</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>   <span style=color:#8f5902;font-style:italic>/** The zone is incompatible. There may be another train as well */</span>
</span></span><span style=display:flex><span>   <span style=color:#000>INCOMPATIBLE</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>MAView</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** Combined status of the zones protected by the current signal */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>protectedZoneStatus</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>ZoneStatus</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>nextSignalState</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>SignalState</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>nextSignalSettings</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>SignalSettings</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>DirectSpeedLimit</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** Distance between the signal and the speed limit */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>distance</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>Distance</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>speed</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>Speed</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>IndirectSpeedLimit</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>distanceToNextSignal</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>Distance</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>nextSignalState</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>SignalState</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>nextSignalSettings</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>SignalSettings</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000>SpeedLimitView</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** A list of speed limits directly downstream of the signal */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>directSpeedLimits</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>List</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#000>DirectSpeedLimit</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>/** A list of speed limits which need to be announced in a signal chain */</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>val</span> <span style=color:#000>indirectSpeedLimits</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>List</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#000>IndirectSpeedLimit</span><span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>fun</span> <span style=color:#000>signal</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>maView</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>MAView</span><span style=color:#000;font-weight:700>?,</span> <span style=color:#000>limitView</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>SpeedLimitView</span><span style=color:#000;font-weight:700>?):</span> <span style=color:#000>SignalState</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ...
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic></span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>The view should allow access to the following data:</p><ul><li>a synthetized view of zones downstream until the end of the train&rsquo;s MA</li><li>the block chain</li><li>the state of downstream signals which belong to the current block chain</li></ul><h3 id=signaling-view-path>Signaling view path</h3><p>The path along which the MAView and SpeedLimitView live is best expressed using blocks:</p><ul><li>blocks can be added to extend the view along the path of a train</li><li>the view can be reduced by removing blocks, as the train passes by signals</li></ul><h3 id=simulation-outside-the-train-path>Simulation outside the train path</h3><p>Everything mentionned so far was designed to simulate signals between a train the
end of its movement authority, as all others signals have no influence over the behavior
of trains (they cannot be seen, or are disregarded by drivers).</p><p>Nevertheless, one may want to simulate and display the state of all signals at a given point in time,
regardless of which signals are in use.</p><p>Simulation rules are as follows:</p><ul><li>if a signal starts blocks which have differing paths, it is simulated as if it were at the end of a route</li><li>if a signal starts blocks which all start the same path, it is simulated in the same view as the next signals in this path</li></ul><h2 id=dependencies>Dependencies</h2><p>For the block graph generation:</p><ul><li>route graph. For each route:<ul><li><code>waypoints: List&lt;DiDetector></code></li><li><code>signals: OrderedMap&lt;Position, UnloadedSignal></code></li><li><code>speed_limits: RangeMap&lt;Position, SpeedLimit></code>, including the logic for train category limits</li></ul></li><li>signaling systems</li><li>drivers</li></ul><p>For evaluation:</p><ul><li>train path in blocks</li><li>portion of the path to evaluate</li><li>drivers</li><li>state of the zones in the section to evaluate</li></ul><h2 id=operations>Operations</h2><ul><li><strong>Instantiating a view</strong> creates a framework for observing signals</li><li><strong>Planning the path signals</strong> to the view the blocks that the train will traverse</li><li><strong>Observing a signal</strong> subscribe to the state of a signal (through the view)</li><li><strong>Passing a signal</strong> signals that a signal has been passed by the train (through the view)</li></ul><h2 id=appendices>Appendices</h2><h3 id=research-questions>Research Questions</h3><ul><li>Are there any blocks that overlap the end of a route? SNCF(Loïc): No.</li><li>Are there any signals which rely on the state of the one after next signal? SNCF(Loïc): No.</li><li>Are there signals that change behavior based on the active block in front of them? SNCF(Loïc): Yes, for slowdowns.</li><li>Are there signals that are the start of blocks of different types? SNCF(Loïc): Yes.</li><li>Can the behavior of a signal depend on which block is active after the end of the current block? SNCF(Loïc): Yes, with slowdowns or blinking yellow.</li><li>Do some signaling systems need additional information in the blocks? SNCF(Loïc): Kind of, there are slowdowns, but it&rsquo;s not specifically carried by the block.</li><li>Is it nominal for a train to have multiple active signaling systems at the same time? SNCF(Loïc): No.</li><li>When and by whom are the blocks generated?</li><li>What data is necessary for generating the blocks?</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-6802b8721cfb6034a773e0771f4b7493>4.2.2 - Conflict detection</h1><div class=lead>Detect unrealistic timetables</div><div class="pageinfo pageinfo-warning"><p>This document is a work in progress</p></div><p>Conflict detection is the process of looking for timetable conflicts.
A timetable conflict is any predictable condition which disrupts planned operations.
Planned operations can be disrupted if a train is slowed down, prevented from proceeding, or delayed.</p><p>One of the core features of OSRD is the ability to automatically detect some conflicts:</p><ul><li><strong>spacing conflicts</strong>: insufficient spacing between trains sharing the same path</li><li><strong>routing conflicts</strong>: insufficient spacing between trains with intersecting paths</li></ul><p>Some other kinds of conflicts may be detected <em>later on</em>:</p><ul><li><strong>maintenance conflicts</strong>: planned maintenance disrupts the path of a train</li><li><strong>power delivery conflicts</strong>: combined power delivery requirements exceeds capacity</li></ul><p>Conflict detection relies on interlocking and signaling modeling and simulation to:</p><ol><li>figure out what each actor requires to perform its duty undisturbed</li><li>detect conflicting requirements</li></ol><h2 id=design-constraints>Design constraints</h2><p>The primary design goals are as follows:</p><ul><li>enable threading new train paths into an existing timetable (see STDCM)</li><li>produce conflicts which can be linked back to a root cause</li><li>operate in way that can be visualized and interpreted</li><li>scale to real world timetables: millions of yearly trains, tens of thousands of daily trains</li></ul><p>In addition to these goals, the following constraints apply:</p><ul><li>it must be possible to thread new train paths into timetables with existing conflicts</li><li>it must not cause false-negatives: if no conflicts are detected, a multi-train simulation of the same timetable must not yield any slowdowns</li><li>it cannot rely on data we do not have</li><li>it has to enable later support of mobile block systems</li><li>it has to rely on existing signaling and interlocking simulation</li><li>it has to enable detecting conflicts regardless of the signaling system in use</li><li>it has to support transitions between signaling systems</li><li>it has to support conflicts between different signaling systems</li></ul><h2 id=conflict-modeling>Conflict modeling</h2><p><strong>Actors</strong> are objects which cause resources to be used:</p><ul><li><strong>train paths</strong> (or someone / something on the behalf of the train)</li><li><strong>maintenance work</strong></li></ul><p>Actors need <strong>resources</strong> to be available to proceed, such as:</p><ul><li><strong>zones</strong>, which have one state per way to traverse it</li><li><strong>switches</strong>, which have one state per position</li><li><strong>station platforms</strong>, which could be used to prevent two large trains from occupying both sides of a tiny platform</li></ul><p>Actor emit <strong>resource requirements</strong>, which:</p><ul><li>describe the need of an actor for a resource, for a given time span</li><li>describe what the resource is needed for</li><li>detail how the resource is used, such as switch position, zone entry and exit</li></ul><p>Resource requirements can turn out to be either <strong>satisfied</strong>
or <strong>conflicting</strong> with other requirements, depending on compatibility rules.</p><p><strong>Compatibility rules differ by requirement purpose and resource type</strong>. For example:</p><ul><li>spacing requirements are exclusive: simultaneous requirements for the same resource are conflicting</li><li>zone and switch requirements are shareable: simultaneous requirements are satisfied if the resource configuration is identical</li></ul><p><strong>For conflict detection to work, resource requirements have to be at least as extensive as what&rsquo;s required to guarantee that a train path will not be disturbed.</strong></p><h2 id=routing-conflicts>Routing conflicts</h2><h3 id=context>Context</h3><p>For trains to proceed safely along their planned path:</p><ul><li>switches have to be moved in the appropriate position</li><li>level crossings have to activate</li><li>risks of collision with other trains have to be mitigated</li></ul><p>In practice, the path of trains is partitioned into routes, which when set, ensure a train can safely follow the route.</p><p>Routes have the following lifestyle:</p><ul><li>As a train approaches the start of one of its routes, it is <strong>called</strong> by an operator. If all resources required to safely use the route are available, switches and level crossings start to move. If a resources is not available, e.g. because another train has reserved a section of track, this process is delayed until all conditions are met.</li><li>Once all resources are configured and reserved, the route is <strong>set</strong> and ready to be followed. Before that point, the entry of the route was protected by signaling, which prevented the train from moving past the entry point.</li><li>As the train moves along the route, it is <strong>destroyed</strong>. When the tail of the trail releases key detectors along the route, resources before this detector are released, and can this be reserved by other routes.</li></ul><p>For a train to proceed through a route unimpeded, the following things have to happen:</p><ul><li>The route has to be set before the train arrives, and before it is slowed down by signaling.</li><li>The route has to be called, so that is it set in time.</li><li>All resources required for the route to start setting at call time have to be available.</li></ul><h3 id=generating-requirements>Generating requirements</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>RouteRequirement</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>route</span>: <span style=color:#000>RouteId</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>set_deadline</span>: <span style=color:#000>Time</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>zone_requirements</span>: <span style=color:#204a87>Vec</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>RouteZoneRequirement</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>RouteZoneRequirement</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>zone</span>: <span style=color:#000>ZoneId</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>entry_det</span>: <span style=color:#000>DirDetectorId</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>exit_det</span>: <span style=color:#000>DirDetectorId</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>release_time</span>: <span style=color:#000>Time</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>switches</span>: <span style=color:#000>Map</span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#000>SwitchId</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>SwitchConfigId</span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Routing requirements are generated by the following algorithm:</p><ul><li>Compute the set deadline using signaling simulation. The set deadline is the point in time at which the train would be slowed down if the route were not set.</li><li>For each zone in each route, simulate when it would be released, and thus not required anymore.</li></ul><div class="pageinfo pageinfo-info"><p>Route overlaps are not yet supported.</p></div><h3 id=requirement-compatibility-rules>Requirement compatibility rules</h3><p>Requirement compatibility is evaluated for all <code>RouteZoneRequirement</code>s, grouped by zone. Requirements A and B, ordered such that <code>A.set_deadline &lt;= B.set_deadline</code>, are compatible if and only if either:</p><ul><li>their active time span does not overlap, such that <code>A.release_time &lt;= (B.set_deadline - activation_time)</code>, where the activation time is the delay required to reconfigure from <code>A.switches</code> to <code>B.switches</code>.</li><li><code>(A.entry_det, A.exit_det, A.switches) == (B.entry_det, B.exit_det, B.switches)</code></li></ul><h2 id=spacing-conflicts>Spacing conflicts</h2><h3 id=context-1>Context</h3><p>Even if interlocking mitigates some of the risks associated with operating trains, a major one is left out: head to tail collisions, caused by insufficient spacing.</p><p>This responsibility is handled by signaling, which conveys both interlocking and spacing constraints.</p><p>Signaling helps trains slow down until the end of their movement authority, which is either:</p><ul><li>behind the tail of the next train</li><li>at the end of the last route set for this train</li></ul><p><strong>Spacing requirements are emitted for zones which if occupied, would cause a slowdown, and zones occupied by the train</strong></p><h3 id=generating-requirements-1>Generating requirements</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000>SpacingRequirement</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>{</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>zone</span>: <span style=color:#000>ZoneId</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>begin_time</span>: <span style=color:#000>Time</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>end_time</span>: <span style=color:#000>Time</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000;font-weight:700>}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Every time the driver sees a signal, generate updated spacing requirements by calculating which zones, if occupied, would trigger a slowdown:</p><ul><li>start by assuming the zone just after the head of the train is occupied</li><li>until the train is not slowed down, move the occupied section one zone further away from the train</li></ul><h3 id=requirement-compatibility-rules-1>Requirement compatibility rules</h3><p>Requirement compatibility is evaluated for all <code>SpacingRequirement</code>s, grouped by zone.</p><p>Requirements A and B are compatible if and only if their <code>[begin_time, end_time]</code> ranges do not overlap.</p><h2 id=incremental-requirement-generation>Incremental requirement generation</h2><h3 id=routing-requirements>Routing requirements</h3><pre tabindex=0><code class=language-mermaid data-lang=mermaid>sequenceDiagram
    participant client as Client
    participant gen as Routing resource generator
    client -&gt;&gt; gen: initial path + train movement
    loop
        gen -&gt;&gt; client: prefix path extension needed
        client -&gt;&gt; gen: extra prefix path + train movement
    end
    gen -&gt;&gt; client: resource requirements
</code></pre><p>After an initial path is given, the requirement generator can ask for more <strong>prefix</strong> path (before the start of the route). The client responds with:</p><ul><li>the extra prefix path</li><li>the movement of the train over time on the given prefix path</li></ul><p>If the initial path has multiple routes, the last route is the one resource requirements are emitted for.</p><h3 id=spacing-requirements>Spacing requirements</h3><pre tabindex=0><code class=language-mermaid data-lang=mermaid>sequenceDiagram
    participant client as Client
    participant gen as Spacing resource generator
    client -&gt;&gt; gen: initial path + train movement
    loop
        gen -&gt;&gt; client: postfix path extension needed
        client -&gt;&gt; gen: extra postfix path
    end
    gen -&gt;&gt; client: resource requirements
</code></pre><p>After an initial path is given, the requirement generator can ask for more <strong>postfix</strong> path (before the start of the route).</p><h2 id=visualizing-requirements>Visualizing requirements</h2><script type=application/javascript src=mkt.js></script><p><object style=width:100% onload=mkt_hydrate(this.contentDocument.rootElement) type=image/svg+xml data=requirements-diagram.svg></object></p><p><a href=./requirements-diagram.html>Full-page requirements diagram</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-5c302d0351a984c31f1516d7661b618f>4.2.3 - Search for last-minute train slots (STDCM)</h1><p>OSRD can be used to find a slot for a train in an already established
timetable, without causing conflicts with other trains.</p><p>The acronym STDCM (Short Term Digital Capacity Management) is used
to describe this concept in general.</p></div><div class=td-content><h1 id=pg-947b82c2b20e8d312398ef2a5634cd3c>4.2.3.1 - Business context</h1><p>Some definitions:</p><h3 id=capacity>Capacity</h3><p><strong>Capacity</strong>, in this context, is the ability to
reserve infrastructure elements to allow the passage of a train.</p><p>Capacity is expressed in both space and time:
the reservation of an element can block a specific zone
that becomes inaccessible to other trains, and this reservation
lasts for a given time interval.</p><p>It can be displayed
on a chart, with the time on the horizontal axis
and the distance traveled on the vertical axis.</p><p><img src=space_time_chart.png alt="Space-time chart"></p><blockquote><p>Example of a space-time chart displaying the passage of a train.</p><p>The colors here represent aspects of the signals, but
display a consumption of the capacity as well:
when these blocks overlap for two trains, they conflict.</p></blockquote><p>There is a <strong>conflict</strong> between two trains when they reserve
the same object at the same time, in incompatible configurations.</p><p><img src=conflict.png alt="Space-time chart with conflict"></p><blockquote><p>Example of a space-time graph with a conflict: the second train
is faster than the first one, they are in conflict at the end
of the path, when the rectangles overlap.</p><p>When simulating this timetable, the second train would be
slowed down by the yellow signals, caused by the
presence of the first train.</p></blockquote><h3 id=train-slots>Train slots</h3><p>A <strong>train slot</strong> corresponds to a capacity reservation
for the passage of a train. It is fixed in space and time:
the departure time and the path taken are known.
On the space-time charts in this page, a train slot corresponds
to the set of blocks displayed for a train.</p><blockquote><p>Note: in English-speaking countries, these are often simply called &ldquo;train paths&rdquo;.
But in this context, this name would be ambiguous with the
physical path taken by the train.</p></blockquote><p>The usual procedure is for the infrastructure manager
(e.g. SNCF Réseau) to offers train slots for sale to
railway companies (e.g. SNCF Voyageurs).</p><p>At a given date before the scheduled day of operation,
all the train paths are allocated. But <strong>there may be
enough capacity to fit more trains</strong>. Trains can fit between
scheduled slots,
when they are sufficiently far apart or have not found a buyer.</p><p>The remaining capacity after the allocation of train paths is called
<strong>residual capacity</strong>. This section explains how OSRD looks
for train slots in this residual capacity.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f0e665bd09334507f4e0f2438621834b>4.2.3.2 - Train slot search module</h1><p>This module handles the search for solutions.</p><p>To reduce the problem to its simplest form and for easy and efficient
testing, inputs and outputs are strongly simplified and abstracted.</p><p>To summarize its behavior:
the solution space is described as a graph that encodes locations,
time, and speed. A pathfinding is run on this graph to find a solution.</p><p>This graph could, in a way, be seen as a decision tree,
but different paths can lead to the same node.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a4f78c201b7f1d0e1991144fff21f26a>4.2.3.2.1 - Input format</h1><p>This module takes several parameters to find a path:</p><ul><li>A graph describing the physical infrastructure</li><li>Unavailable sections in time intervals</li><li>Origin and destination point(s)</li><li>Departure time interval</li><li>Maximum run time</li><li>Simulation parameters (rolling stock, time step, allowances, &mldr;)</li></ul><p>Among those, the first 3 require more explanations.</p><h4 id=infrastructure-graph>Infrastructure graph</h4><p>Today, the input graph is the <code>SignalingRoutes</code> graph.
But it can be any graph that represents the physical infrastructures
and the paths that can be used.</p><p>The only constraints are: the edges must have a length, and it must
be possible to compute running time on parts of an edge.</p><h4 id=unavailable-sections>Unavailable sections</h4><p>This input encodes the areas that are unavailable because of
capacity constraints.</p><p>Every edge has a set of &ldquo;occupancy block&rdquo;. A block is made of these elements:</p><ul><li>Start offset</li><li>End offset</li><li>Start time</li><li>End time</li></ul><p>Offsets are relative to the start of the edge. Each block means that
the <em>head</em> of the train cannot be located in the edge
segment during the given interval.</p><p>These blocks include the grid margin. If the solution needs to have
an <code>x</code> seconds margin before the train passage, every block ends
<code>x</code> seconds later.</p><p>To give an example, with the following schedule, a 42m long train,
and 10m sight distance:</p><p><img src=unavailable_sections.svg alt="Unavailable section example"></p><ul><li>The occupancy of the block 1 from t=0 to t=300 makes it unavailable
in its entirety during this time</li><li>The last 10 meters of block 1 are unavailable from t=300 to t=360,
because the signal at the start of block 2 must be green when the
conductor sees it. It is possible to consider that this unavailability block
starts at t=130 (when the next signal isn&rsquo;t green), as blocks can overlap.</li><li>The occupancy of block 2 from t=130 to t=360 makes it unavailable
during this time. It is also unavailable from t=0, as the presence of a
train in this block would cause a warning on block 1.</li><li>The first 42 meters of block 3 are unavailable from t=0 to t=360,
because the tail of the train must have left the block 2 at this time.</li><li>The rest of block 3 is unavailable in its entirety from t=280 to t=360</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-12bb8a99ebcc826ad37983a300610aed>4.2.3.2.2 - Encoding the solution space</h1><h4 id=general-principle>General principle</h4><p>The problem is still a pathfinding problem in a given graph.
Once the problem is encoded as a graph search, it is possible to reuse
our existing tools for this purpose.</p><p>We consider the <em>product graph</em> of position, time, and speed.
This means that every graph element contains these 3 variables
(among other things)</p><p>Every graph edge is computed using
<a href=https://osrd.fr/en/docs/explanation/running_time_calculation/ title="running-time calculation">running-time calculation</a>
to get speed and positions as functions of time.</p><h4 id=graphical-representation>Graphical representation</h4><p>Space is encoded with a graph that contains the physical infrastructure.</p><p><img src=routes_time_1.png alt="product graph (1/3)"></p><p>It is then &ldquo;duplicated&rdquo; at different times.</p><p><img src=routes_time_2.png alt="product graph (2/3)"></p><p>The nodes are then linked together in a way that reflects travel time.</p><p><img src=routes_time_3.png alt="product graph (3/3)"></p><h4 id=notes>Notes</h4><ul><li>The graph is constructed on the fly as it is explored.</li><li>It is <em>discretized</em> in time, to evaluate which nodes have already
been visited. We keep full accuracy of time values, but two nodes
at the same place and close times are considered identical.</li><li>Every edge is computed with a running time computation.</li><li>Speed isn&rsquo;t discretized or considered to check visited nodes,
it&rsquo;s only used to compute time.</li><li>By default, the train always goes as fast as it can
(while still following standard allowances).
It only slows down when necessary.</li></ul><h4 id=example>Example</h4><p>For example, with the following infrastructure, using the track graph:
<img src=example_infra.svg alt="Example infra"></p><p>Exploring the solution graph can give the following result:
<img src=example_graph.svg alt="Représentation du graphe"></p></div><div class=td-content style=page-break-before:always><h1 id=pg-74094845d6db946e31db476ef1c506a2>4.2.3.2.3 - Discontinuities and backtracking</h1><h4 id=the-discontinuity-problem>The discontinuity problem</h4><p>When a new graph edge is visited, a simulation is run to evaluate
its speed. But it is not possible to see beyond the current edge.
This makes it difficult to compute braking curves, because
they can span over several edges.</p><p><img src=discontinuity.png alt=Discontinuity></p><blockquote><p>This example illustrates the problem: by default
the first edge is explored by going at maximum speed.
The destination is only visible once the second edge is visited,
which doesn&rsquo;t leave enough distance to stop.</p></blockquote><h4 id=solution--backtracking>Solution : backtracking</h4><p>To solve this problem, when an edge is generated with a
discontinuity in the speed envelopes, the algorithm goes back
over the previous edges to create new ones that include the
decelerations.</p><p>To give a simplified example, on a path of 4 edges
where the train can accelerate or decelerate by 10km/h per edge:</p><p><img src=backtracking_1.png alt="Discontinuity (edge version, 1/2)"></p><p>For the train to stop at the end of route 4, it must be at most
at 10km/h at the end of edge 3. A new edge is then created on
edge 3, which ends at 10km/h. A deceleration is computed
backwards from the end of the edge back to the start,
until the original curve is met (or the start of the edge).</p><p>In this example, the discontinuity has only been moved to the
transition between edges 2 and 3. The process is then repeated
on edge 2, which gives the following result:</p><p><img src=backtracking_2.png alt="Discontinuity (edge version, 2/2)"></p><p>Old edges are still present in the graph as they can lead to other solutions.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-615ce0cf6c404cd85469e6285e5feb90>4.2.3.2.4 - Conflict avoidance</h1><p>While exploring the graph, it is possible to end up in locations that would
generate conflicts. They can be avoided by adding delay.</p><h4 id=shifting-the-departure-time>Shifting the departure time</h4><p>The departure time is defined as an interval in the module parameters:
the train can leave at a given time, or up to <code>x</code> seconds later.
Whenever possible, delay should be added by shifting the departure time.</p><blockquote><p>for example : a train can leave between 10:00 et 11:00. Leaving
at 10:00 would cause a conflict, the train actually needs to enter the
destination station 15 minutes later. Making the train leave at
10:15 solves the problem.</p></blockquote><p>In OSRD, this feature is handled by keeping track, for every edge,
of the maximum duration by which we can delay the departure time.
As long as this value is enough, conflicts are avoided this way.</p><p>This time shift is a value stored in every edge of the path.
Once a path is found, the value is summed over the whole path.
This is added to the departure time.</p><blockquote><p>For example :</p><ul><li>a train leaves between 10:00 and 11:00. The initial maximum
time shift is 1:00.</li><li>At some point, an edge becomes unavailable 20 minutes after the
train passage. The value is now at 20 for any edge accessed from here.</li><li>The departure time is then delayed by 5 minutes to avoid a conflict.
The maximum time shift value is now at 15 minutes.</li><li>This process is applied until the destination is found,
or until no more delay can be added this way.</li></ul></blockquote><h4 id=engineering-allowances>Engineering allowances</h4><p>Once the maximum delay is at 0, the delay needs to be added
between two points of the path.</p><p><img src=engineering_allowance.png alt="Engineering allowances (1/2)"></p><p>The idea is the same as the one used to fix speed discontinuities:
new edges are created, replacing the previous ones.
The new edges have an engineering allowance, to add the delay where
it is possible.</p><p><img src=engineering_allowance_edges.png alt="Engineering allowances (2/2)"></p><p>computing an
<a href=https://osrd.fr/en/docs/explanation/running_time_calculation/allowances/ title=allowances>engineering allowance</a>
is a feature of the running-time
calculation module. It adds a given delay between two points of
a path, without affecting the speeds on the rest of the path.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ed97b39b0c3816e4f1073f363957a3e3>4.2.3.2.5 - Standard allowance</h1><p>The STDCM module must be usable with
<a href=https://osrd.fr/en/docs/explanation/running_time_calculation/allowances/ title="marge de régularité">standard allowances</a>.
The user can set an allowance value, expressed either as a function of
the running time or the travelled distance. This time must be added to the
running time, so that it arrives later compared to its fastest possible
running time.</p><blockquote><p>For example: the user can set a margin of 5 minutes per 100km.
On a 42km long path that would take 10 minutes at best,
the train should arrive 12 minutes and 6 seconds after leaving.</p></blockquote><p>This can cause problems to detect conflicts, as an allowance would move
the end of the train slot to a later time.
The allowance must be considered when we compute conflicts as
the graph is explored.</p><p>The allowance must also follow the <a href=/pdf/MARECO.pdf>MARECO</a> model:
the extra time isn&rsquo;t added evenly over the whole path,
it is computed in a way that requires knowing the whole path.
This is done to optimize the energy used by the train.</p><h4 id=linear-margin-expressed-as-a-function-of-time>Linear margin expressed as a function of time</h4><p>As a first step, the problem is solved with a linear margin,
i.e. added evenly over the whole path.
The speed is simply modified by a constant factor.</p><p>The <a href=https://osrd.fr/en/docs/explanation/running_time_calculation/envelopes_system/ title=envelopes>envelopes</a>.
computed during the graph traversal are not modified, they are always
at maximum speed. But they are paired with a speed factor, which is used
to compute running time and to evaluate conflicts.</p><p>The final envelope, with the allowance, is only computed once a path
is found.</p><h4 id=linear-margin-expressed-as-a-function-of-distance>Linear margin expressed as a function of distance</h4><p>The principle is generally the same, but with an extra difficulty:
the speed factor isn&rsquo;t constant over the path.
When a train goes faster, it travels more distance in the same time,
which increases the allowance time and the speed factor.</p><p>Because the train speed changes over the path, the speed factor
changes from one edge to another. This causes irregular speed curves.</p><h4 id=mareco-allowances>MARECO Allowances</h4><p>This is exclusively a post-processing step,
because it isn&rsquo;t possible to compute the MARECO envelope
without knowing the full train path.
When looking for a path, linear allowances are used.</p><p>This means that conflicts may appear at this step.
To avoid them, the following procedure is applied:</p><ol><li>A mareco allowance is applied over the whole path.</li><li>If there are conflict, the first one is considered.</li><li>The mareco allowance is <em>split in two intervals</em>.
The point where the first conflict appeared is set
to be at the same time as the envelope with a linear allowance,
removing the conflict at this point.</li><li>This process is repeated iteratively until no conflict is found.</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-460b1be4e2f2584372a451ceef833731>4.2.3.2.6 - Implementation details</h1><p>This page is about implementation details.
It isn&rsquo;t necessary to understand general principles,
but it helps before reading the code.</p><h4 id=stdcmedgebuilder>STDCMEdgeBuilder</h4><p>This refers to
<a href=https://github.com/osrd-project/osrd/blob/dev/core/src/main/java/fr/sncf/osrd/stdcm/graph/STDCMEdgeBuilder.java>this class</a>
in the project.</p><p>This class is used to make it easier to create instances of
<code>STDCMEdge</code>, the graph edges. Those contain many attributes,
most of which can be determined from the context (e.g. the
previous node).
The <code>STDCMEdgeBuilder</code> class makes some parameters optional
and automatically computes others.</p><p>Once instantiated and parametrized, an <code>STDCMEdgeBuilder</code> has two methods:</p><ul><li><p><code>Collection&lt;STDCMEdge> makeAllEdges()</code> can be used to create all
the possible edges in the given context for a given route.
If there are several &ldquo;openings&rdquo; between occupancy blocks, one edge
is instantiated for each opening. Every conflict, their avoidance,
and their related attributes are handled here.</p></li><li><p><code>STDCMEdge findEdgeSameNextOccupancy(double timeNextOccupancy)</code>:
This method is used to get the specific edges that uses a certain
opening (when it exists), identified here with the time of the next
occupancy block. It is called whenever a new edge must be re-created
to replace an old one. It calls the previous method.</p></li></ul><h3 id=pathfinding>Pathfinding</h3><p>The methods mentioned here are defined in
<a href=https://github.com/osrd-project/osrd/blob/dev/core/src/main/java/fr/sncf/osrd/stdcm/graph/STDCMPathfinding.java>this class</a>.</p><h4 id=cost-function>Cost function</h4><p>The function used to define pathfinding cost sets which path
is used over another. The result is always the one that minimizes
this cost (as long as the heuristic is admissible).</p><p>Here, two parameters are used: total run time and departure time.
The latter has a very small weight compared to the former,
so that the fastest path is found. More details
are explained in the documentation of those methods.</p><h4 id=heuristics>Heuristics</h4><p>The algorithm used to find a path is an A*, with a heuristic based
on geographical coordinates.</p><p>However, the coordinates of generated infrastructures are arbitrary
and don&rsquo;t reflect the track distance. It means that,
for the generated infrastructures, the path may not always be the
shortest one.</p><p>It would be possible to use this heuristic to determine whether
the current node can lead to a path that doesn&rsquo;t take
longer than the maximum allowed total run time. But for the same
reason, adding this feature would break any STDCM test on generated
infras. More details in
<a href=https://github.com/osrd-project/osrd/issues/2818>this issue</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-8ee6423983b11793e61c99ce092f6373>4.2.3.3 - Signaling interface</h1><p>WIP</p><p>There&rsquo;s a draft of what we intend to do on the French page,
but it&rsquo;s still a work in progress.
The implementation hasn&rsquo;t been started.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c963971a74112cd3ec208d3977cd25e5>4.3 - APIs</h1><div class=lead>Programming interfaces specifications</div></div><div class=td-content><h1 id=pg-20edb78a2f57bbf0e0aadeb2bd6baaab>4.3.1 - JSON Schemas</h1><script src=https://cdn.rawgit.com/caldwell/renderjson/master/renderjson.js></script><div id=container><h1>Infrastructure</h1></div><script>var infra={};tmp=$.ajax({url:"/schemas/infra_schema.json",async:!1,dataType:'json',success:function(e){infra=e}}),document.getElementById("container").appendChild(renderjson(infra))</script><div id=container2><h1>Rolling Stock</h1></div><script>var rolling_stock={};tmp=$.ajax({url:"/schemas/rolling_stock_schema.json",async:!1,dataType:'json',success:function(e){rolling_stock=e}}),document.getElementById("container2").appendChild(renderjson(rolling_stock))</script><style>#container,#container2{text-shadow:none;background:;padding:1em}.renderjson a{text-decoration:none}.renderjson .disclosure{color:#aa026d;font-size:150%}.renderjson .syntax{color:grey}.renderjson .string{color:#000}.renderjson .number{color:cyan}.renderjson .boolean{color:plum}.renderjson .key{color:#aa026d}.renderjson .keyword{color:#fafad2}.renderjson .object.syntax{color:#20b2aa}.renderjson .array.syntax{color:#ffa07a}</style></div><div class=td-content style=page-break-before:always><h1 id=pg-b5672eea755d8e1fc4d23b2baf6867df>5 - Railway Wiki</h1><div class=lead>International railway wiki</div><p>This wiki is meant to help software engineers have a deep understanding of railway systems.</p><p><strong>It can only happen if content is added as needed. If something is missing, contribute!</strong></p></div><div class=td-content><h1 id=pg-c10f498cbf37ef82f2252bc49b20abb3>5.1 - Glossary</h1><div class=lead>Glossary of OSRD and railway vocabulary</div><p>Please open an issue if you&rsquo;re missing a word</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/osrd-project/osrd aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 OSRD contributors. All Rights Reserved</small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA==" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/mermaid@8.13.4/dist/mermaid.min.js integrity="sha512-JERecFUBbsm75UpkVheAuDOE8NdHjQBrPACfEQYPwvPG+fjgCpHAz1Jw2ci9EXmd3DdfiWth3O3CQvcfEg8gsA==" crossorigin=anonymous></script><style>.markmap>svg{width:100%;height:300px}</style><script>window.markmap={autoLoader:{manual:!0}}</script><script src=https://cdn.jsdelivr.net/npm/markmap-autoloader></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.928c8c2d8b4f463998503da833bc465b748d40b80287e0398a7e1a38ab1c87a2.js integrity="sha256-koyMLYtPRjmYUD2oM7xGW3SNQLgCh+A5in4aOKsch6I=" crossorigin=anonymous></script></body></html>